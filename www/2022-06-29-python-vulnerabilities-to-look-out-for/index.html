<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><link rel=preload href=/fonts/FiraCode-VariableFont_wght.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/css/grid.css type=text/css><link rel=stylesheet href=/css/highlight.css type=text/css><link rel=stylesheet href=/css/main.css type=text/css><meta name=apple-mobile-web-app-title content="dubell.io | Python gems to look out for"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=twitter:site content="@dubs3c"><meta name=twitter:creator content="@dubs3c"><meta property="og:title" content="dubell.io | Python gems to look out for"><meta name=twitter:title content="dubell.io | Python gems to look out for"><meta itemprop=name content="dubell.io | Python gems to look out for"><meta name=application-name content="dubell.io | Python gems to look out for"><meta property="og:site_name" content="dubell.io"><meta property="og:article:published_time" content="2022-06-29T00:00:00Z"><meta property="article:published_time" content="2022-06-29T00:00:00Z"><base href=/www/2022-06-29-python-vulnerabilities-to-look-out-for/><link rel=canonical href=/www/2022-06-29-python-vulnerabilities-to-look-out-for/ itemprop=url><meta name=url content="/www/2022-06-29-python-vulnerabilities-to-look-out-for/"><meta name=twitter:url content="/www/2022-06-29-python-vulnerabilities-to-look-out-for/"><meta property="og:url" content="/www/2022-06-29-python-vulnerabilities-to-look-out-for/"><meta property="og:article:author" content="Dubs3c"><meta property="article:author" content="Dubs3c"><meta name=author content="Dubs3c"><meta name=description content="Things to watch out for in python"><meta itemprop=description content="Things to watch out for in python"><meta property="og:description" content="Things to watch out for in python"><meta name=twitter:description content="Things to watch out for in python"><meta itemprop=image content="/"><meta property="og:image" content><meta name=twitter:image content><meta name=twitter:image:src content><meta property="og:updated_time" content="2022-06-29T00:00:00Z"><link rel=sitemap type=application/xml title=Sitemap href=sitemap.xml><title>dubell.io | Python gems to look out for</title></head><body><div id=particles-js></div><main><div class=row><header class="col center"><a href=/ class=noleet><img href=/ class=banner-image src=/img/logo2.png alt=logo></a></div></div><div class=row><div class="col center"><nav><fieldset><legend>n4vig4ti0n</legend><ul><li><a href=/>/etc/motd</a></li><li><a href=/www/>/var/www</a></li><li><a href=/mnt/>/mnt</a></li><li><a href=/usr/>/usr</a></li></ul></fieldset></nav></div></div><div class=content><article><h1>Python gems to look out for</h1><br><p class=small style=color:#999><a href=/categories/appsec>Appsec</a> / June 29, 2022 â€¢ 2 min read</p><p class=small><strong>Tags:</strong> <a href=/tags/python class=tag>python</a></p><br><p>A few weeks ago I was looking into Python specific code patterns that would lead to vulnerabilities. I was surprised when I found a few patterns that I hadn&rsquo;t really thought about, most likely because I never write Python code like the examples I found. Nevertheless, I learned something new and thought I share it here.</p><h2 id=example-one>Example One</h2><p>Passing an untrusted string to an <code>f-string</code> while passing a dict as an argument to the logger, may give the attacker the possibility to read keys in the dict that should not be readable.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>untrusted_string</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>%(secret)s</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>some_dict</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;foo&#34;</span><span class=p>:</span> <span class=s2>&#34;bar&#34;</span><span class=p>,</span> <span class=s2>&#34;secret&#34;</span><span class=p>:</span> <span class=s2>&#34;mysecret&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Case one: &#39;</span><span class=si>{</span><span class=n>untrusted_string</span><span class=si>}</span><span class=s2>&#39; and &#39;%(foo)s&#39;&#34;</span><span class=p>,</span> <span class=n>some_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; Outputs:
</span></span></span><span class=line><span class=cl><span class=s2>INFO:__main__:look: &#39;mysecret&#39; and &#39;bar&#39;
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Of course it assumes the attacker knows what keys are in the <code>dict</code>. Note that this example does not work with normal <code>print()</code> statements.</p><h2 id=example-two>Example Two</h2><p>This is an interesting one. Using <code>%(var)s</code> method to reference variables in a string will parse <code>\n</code> as newlines. If used in a logging context, you poison the log by &ldquo;injecting&rdquo; new log items. If normal <code>f-strings</code> or <code>.format()</code> were used, it wouldn&rsquo;t work.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=s2>&#34;admin&#34;</span><span class=p>,</span> <span class=s2>&#34;msg&#34;</span><span class=p>:</span> <span class=s1>&#39;hello everybody.</span><span class=se>\n</span><span class=s1>INFO:__main__:user </span><span class=se>\&#39;</span><span class=s1>alice</span><span class=se>\&#39;</span><span class=s1> commented: </span><span class=se>\&#39;</span><span class=s1>I like pineapple pizza</span><span class=se>\&#39;</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s2>&#34;secret&#34;</span><span class=p>:</span> <span class=s2>&#34;1337&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Case Two: user &#39;</span><span class=si>%(user)s</span><span class=s2>&#39; commented: &#39;</span><span class=si>%(msg)s</span><span class=s2>&#39;.&#34;</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; Outputs
</span></span></span><span class=line><span class=cl><span class=s2>INFO:__main__:user &#39;admin&#39; commented: &#39;hello everybody.
</span></span></span><span class=line><span class=cl><span class=s2>INFO:__main__:user &#39;alice&#39; commented: &#39;I like pineapple pizza&#39;&#39;.
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=example-three>Example Three</h2><p>This one is pretty clever, though I have never seen it in the wild nor written anything like it myself. But if the format string itself is controlled by the user, you can of course reference variables within <code>__globals__</code> and read their values.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>THESECRET</span> <span class=o>=</span> <span class=s2>&#34;gibson&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Author</span><span class=p>(</span><span class=nb>object</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;Ellis&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>format_me</span><span class=p>(</span><span class=n>format_string</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>format_string</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== Case Three - Manipulating format string</span>
</span></span><span class=line><span class=cl><span class=c1># This particular bug requires the attacker to be in control of the format string itself.</span>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>=</span> <span class=n>Author</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Current class is: &#34;</span> <span class=o>+</span> <span class=n>format_me</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{0.__class__}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>))</span> <span class=c1># Outputs: &lt;class &#39;__main__.Author&#39;&gt;</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;The secret is: &#34;</span> <span class=o>+</span> <span class=n>format_me</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{0.__init__.__globals__[THESECRET]}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>))</span> <span class=c1># prints: gibson</span>
</span></span></code></pre></td></tr></table></div></div><p>I haven&rsquo;t confirmed it yet, but I have a suspicion that remote code execution could be achieved in this specific scenario. Maybe an exercise for the reader? :)</p><h2 id=credits>Credits</h2><p>Thank you <a href=https://dev.arie.bovenberg.net/blog/is-your-python-code-vulnerable-to-log-injection/>Arie Bovenberg</a> for teaching me about these fine python gems :)</p></article></div><footer></footer></main><script src=/js/particles.min.js defer></script>
<script src=/js/particles.conf.js defer></script>
<script src=/js/baffle.min.js async></script>
<script src=/js/main.js defer async></script></body></html>