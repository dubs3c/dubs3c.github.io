<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><link rel=preload href=/fonts/FiraCode-VariableFont_wght.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/css/bootstrap-grid.min.css type=text/css><link rel=stylesheet href=/css/main.css type=text/css><meta name=apple-mobile-web-app-title content="dubell.io | Python gems to look out for"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=twitter:site content="@dubs3c"><meta name=twitter:creator content="@dubs3c"><meta property="og:title" content="dubell.io | Python gems to look out for"><meta name=twitter:title content="dubell.io | Python gems to look out for"><meta itemprop=name content="dubell.io | Python gems to look out for"><meta name=application-name content="dubell.io | Python gems to look out for"><meta property="og:site_name" content="dubell.io"><meta property="og:article:published_time" content="2022-06-29T00:00:00Z"><meta property="article:published_time" content="2022-06-29T00:00:00Z"><base href=https://dubell.io/www/2022/06/python-gems-to-look-out-for/><link rel=canonical href=https://dubell.io/www/2022/06/python-gems-to-look-out-for/ itemprop=url><meta name=url content="https://dubell.io/www/2022/06/python-gems-to-look-out-for/"><meta name=twitter:url content="https://dubell.io/www/2022/06/python-gems-to-look-out-for/"><meta property="og:url" content="https://dubell.io/www/2022/06/python-gems-to-look-out-for/"><meta property="og:article:author" content="Dubs3c"><meta property="article:author" content="Dubs3c"><meta name=author content="Dubs3c"><meta name=description content="Things to watch out for in python"><meta itemprop=description content="Things to watch out for in python"><meta property="og:description" content="Things to watch out for in python"><meta name=twitter:description content="Things to watch out for in python"><meta itemprop=image content="/"><meta property="og:image" content="https://dubell.io"><meta name=twitter:image content="https://dubell.io"><meta name=twitter:image:src content="https://dubell.io"><meta property="og:updated_time" content="2022-06-29T00:00:00Z"><link rel=sitemap type=application/xml title=Sitemap href=https://dubell.iositemap.xml><title>dubell.io | Python gems to look out for</title></head><body><div id=particles-js></div><main><div class=row><div class=col><header style=text-align:center><a href=/ class=noleet><img href=/ class=banner-image src=/img/logo2.png alt=logo></a></header></div></div><div class=row><div class=col style=text-align:center><nav><fieldset><legend>n4vig4ti0n</legend><ul><li><a href=/>/etc/motd</a></li><li><a href=/www/>/var/www</a></li><li><a href=/mnt/>/mnt</a></li><li><a href=/usr/>/usr</a></li></ul></fieldset></nav></div></div><div class=content><article><h1>Python gems to look out for</h1><br><p class=small style=color:#999><a href=/categories/appsec>Appsec</a> / June 29, 2022 â€¢ 2 min read</p><p class=small><strong>Tags:</strong> <a href=/tags/python class=tag>python</a></p><br><p>A few weeks ago I was looking into Python specific code patterns that would lead to vulnerabilities. I was surprised when I found a few patterns that I hadn&rsquo;t really thought about, most likely because I never write Python code like the examples I found. Nevertheless, I learned something new and thought I share it here.</p><h2 id=example-one>Example One</h2><p>Passing an untrusted string to an <code>f-string</code> while passing a dict as an argument to the logger, may give the attacker the possibility to read keys in the dict that should not be readable.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#fb660a;font-weight:700>import</span> logging
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>logging.basicConfig(level=logging.INFO)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>logger = logging.getLogger(__name__)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>untrusted_string = <span style=color:#0086d2>&#34;</span><span style=color:#0086d2>%(secret)s</span><span style=color:#0086d2>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>some_dict = {<span style=color:#0086d2>&#34;foo&#34;</span>: <span style=color:#0086d2>&#34;bar&#34;</span>, <span style=color:#0086d2>&#34;secret&#34;</span>: <span style=color:#0086d2>&#34;mysecret&#34;</span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>logger.info(<span style=color:#0086d2>f</span><span style=color:#0086d2>&#34;Case one: &#39;</span><span style=color:#0086d2>{</span>untrusted_string<span style=color:#0086d2>}</span><span style=color:#0086d2>&#39; and &#39;%(foo)s&#39;&#34;</span>, some_dict)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#0086d2>&#34;&#34;&#34; Outputs:
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#0086d2>INFO:__main__:look: &#39;mysecret&#39; and &#39;bar&#39;
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#0086d2>&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>Of course it assumes the attacker knows what keys are in the <code>dict</code>. Note that this example does not work with normal <code>print()</code> statements.</p><h2 id=example-two>Example Two</h2><p>This is an interesting one. Using <code>%(var)s</code> method to reference variables in a string will parse <code>\n</code> as newlines. If used in a logging context, you poison the log by &ldquo;injecting&rdquo; new log items. If normal <code>f-strings</code> or <code>.format()</code> were used, it wouldn&rsquo;t work.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#fb660a;font-weight:700>import</span> logging
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>logging.basicConfig(level=logging.INFO)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>logger = logging.getLogger(__name__)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>context = {<span style=color:#0086d2>&#34;user&#34;</span>: <span style=color:#0086d2>&#34;admin&#34;</span>, <span style=color:#0086d2>&#34;msg&#34;</span>: <span style=color:#0086d2>&#39;hello everybody.</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>INFO:__main__:user </span><span style=color:#0086d2>\&#39;</span><span style=color:#0086d2>alice</span><span style=color:#0086d2>\&#39;</span><span style=color:#0086d2> commented: </span><span style=color:#0086d2>\&#39;</span><span style=color:#0086d2>I like pineapple pizza</span><span style=color:#0086d2>\&#39;</span><span style=color:#0086d2>&#39;</span>, <span style=color:#0086d2>&#34;secret&#34;</span>: <span style=color:#0086d2>&#34;1337&#34;</span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>logger.info(<span style=color:#0086d2>&#34;Case Two: user &#39;</span><span style=color:#0086d2>%(user)s</span><span style=color:#0086d2>&#39; commented: &#39;</span><span style=color:#0086d2>%(msg)s</span><span style=color:#0086d2>&#39;.&#34;</span>, context)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#0086d2>&#34;&#34;&#34; Outputs
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#0086d2>INFO:__main__:user &#39;admin&#39; commented: &#39;hello everybody.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#0086d2>INFO:__main__:user &#39;alice&#39; commented: &#39;I like pineapple pizza&#39;&#39;.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#0086d2>&#34;&#34;&#34;</span>
</span></span></code></pre></div><h2 id=example-three>Example Three</h2><p>This one is pretty clever, though I have never seen it in the wild nor written anything like it myself. But if the format string itself is controlled by the user, you can of course reference variables within <code>__globals__</code> and read their values.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>THESECRET = <span style=color:#0086d2>&#34;gibson&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#fb660a;font-weight:700>class</span> Author(object):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#fb660a;font-weight:700>def</span> __init__(self) -&gt; <span style=color:#fb660a;font-weight:700>None</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        self.name = <span style=color:#0086d2>&#34;Ellis&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>format_me</span>(format_string: str, a):
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#fb660a;font-weight:700>return</span> format_string.format(a)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>a = Author()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#080;background-color:#0f140f;font-style:italic># Outputs: &lt;class &#39;__main__.Author&#39;&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>print(<span style=color:#0086d2>&#34;Current class is: &#34;</span> + format_me(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>{0.__class__}</span><span style=color:#0086d2>&#34;</span>, a))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#080;background-color:#0f140f;font-style:italic># prints: gibson</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>print(<span style=color:#0086d2>&#34;The secret is: &#34;</span> + format_me(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>{0.__init__.__globals__[THESECRET]}</span><span style=color:#0086d2>&#34;</span>, a))
</span></span></code></pre></div><p>I haven&rsquo;t confirmed it yet, but I have a suspicion that remote code execution could be achieved in this specific scenario. Maybe an exercise for the reader? :)</p><h2 id=credits>Credits</h2><p>Thank you <a href=https://dev.arie.bovenberg.net/blog/is-your-python-code-vulnerable-to-log-injection/>Arie Bovenberg</a> for teaching me about these fine python gems :)</p></article></div><footer></footer></main><script src=/js/particles.min.js defer></script>
<script src=/js/particles.conf.js defer></script>
<script src=/js/baffle.min.js async></script>
<script src=/js/main.js defer async></script></body></html>