<!DOCTYPE html>
<html lang="en"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">

    <link rel="preload" href="/fonts/FiraCode-VariableFont_wght.ttf" as="font" type="font/ttf" crossorigin>
    
    <link rel="stylesheet" href="/css/bootstrap-grid.min.css" type="text/css" />
    
    <link rel="stylesheet" href="/css/main.css" type="text/css" />
    
    
    
    <meta name="apple-mobile-web-app-title" content="dubell.io | Overwriting HttpOnly cookies with Javascript" /> 
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <meta name="twitter:site" content="@dubs3c">
    <meta name="twitter:creator" content="@dubs3c" />

    
    <meta property="og:title" content="dubell.io | Overwriting HttpOnly cookies with Javascript" />
    <meta name="twitter:title" content="dubell.io | Overwriting HttpOnly cookies with Javascript" />
    <meta itemprop="name" content="dubell.io | Overwriting HttpOnly cookies with Javascript" />
    <meta name="application-name" content="dubell.io | Overwriting HttpOnly cookies with Javascript" />
    <meta property="og:site_name" content="dubell.io" />

    <meta property="og:article:published_time" content=2021-11-01T13:13:37Z /> 
    <meta property="article:published_time" content=2021-11-01T13:13:37Z />

    
    <base href="/www/2021/11/overwriting-httponly-cookies-with-javascript/">
    <link rel="canonical" href="/www/2021/11/overwriting-httponly-cookies-with-javascript/" itemprop="url" /> 
    <meta name="url" content="/www/2021/11/overwriting-httponly-cookies-with-javascript/" />
    <meta name="twitter:url" content="/www/2021/11/overwriting-httponly-cookies-with-javascript/" /> 
    <meta property="og:url" content="/www/2021/11/overwriting-httponly-cookies-with-javascript/" />

    
    
    <meta property="og:article:author" content="Dubs3c" />
    <meta property="article:author" content="Dubs3c" /> 
    <meta name="author" content="Dubs3c" /> 
    
  
    
    <meta name="description" content="HttpOnly is used to prevent javascript from reading certain cookies, but if you overflow the cookie jar, you can overwrite the cookie :)" />
    <meta itemprop="description" content="HttpOnly is used to prevent javascript from reading certain cookies, but if you overflow the cookie jar, you can overwrite the cookie :)" />
    <meta property="og:description" content="HttpOnly is used to prevent javascript from reading certain cookies, but if you overflow the cookie jar, you can overwrite the cookie :)" />
    <meta name="twitter:description" content="HttpOnly is used to prevent javascript from reading certain cookies, but if you overflow the cookie jar, you can overwrite the cookie :)" />
    
    
     
    <meta itemprop="image" content="/img/cookie-monsta.png" />
    <meta property="og:image" content="/img/cookie-monsta.png" /> 
    <meta name="twitter:image" content="/img/cookie-monsta.png" />
    <meta name="twitter:image:src" content="/img/cookie-monsta.png" /> 
    

    <meta property="og:updated_time" content=2021-11-01T13:13:37Z />
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

    <title>dubell.io | Overwriting HttpOnly cookies with Javascript</title>
</head><body>
        <div id="particles-js"></div>
        <main><div class="row">
    <div class="col">
    <header style="text-align: center;">
            <a href="/" class="noleet"><img href="/" class="banner-image" src="/img/logo2.png" alt="logo"/></a>
    </header>
    </div>
</div>

<div class="row">
    <div class="col" style="text-align: center;">
        <nav>
            <fieldset>
                <legend>n4vig4ti0n</legend>
                <ul>
                    
                    <li><a href="/">/etc/motd</a></li>
                    
                    <li><a href="/www/">/var/www</a></li>
                    
                    <li><a href="/mnt/">/mnt</a></li>
                    
                    <li><a href="/usr/">/usr</a></li>
                    
                </ul>
            </fieldset>
        </nav>
    </div>
</div>

<div class="content">
<article>
    <h1>Overwriting HttpOnly cookies with Javascript</h1>
        <br />
        <p class="small" style="color: rgb(153 153 153/1)"> 
            <a href="/categories/appsec">AppSec</a> / November 1, 2021 â€¢ 3 min read </p>

            
            <p class="small"><strong>Tags:</strong> <a href="/tags/web" class="tag">web</a>  <a href="/tags/cookies" class="tag">cookies</a> </p> 
            

    <br>
    <p>So I got in contact with <a href="https://twitter.com/SamuelAnttila">Sam Anttila</a> on twitter regarding his <a href="https://netsec.expert/posts/mitigation-schmitigation-xss-and-httponly/">article</a> about overwriting HttpOnly enabled cookies using Javascript, which <em>should</em> not be possible. I asked him if he had verified if Firefox exhibits the same behavior. He answered yes and the result was negative, but the test was done a long time ago and things could have changed. So I decided to try it out myself, as you should :)</p>
<h2 id="whats-in-the-cookie-jar">What&rsquo;s in the Cookie Jar?</h2>
<p>This is something you may have read in &ldquo;older&rdquo; web application security books, the concept is called <strong>Cookie Jar Overflow</strong>. The idea is to simply create too many cookies for the browser to store, so that it begins deleting older cookies. However, today developers are encouraged to protect sensitive cookies by setting the HttpOnly flag, in order to prevent a potential XSS to read it. Meaning, you can&rsquo;t simply overwrite or read a cookie set with this flag. But as it turns out, if you overflow the browser&rsquo;s cookie jar, you can overwrite the cookie you want with a new value, thereby removing the HttpOnly flag.</p>
<p>According to my tests, this only works in Chrome, just as Sam had reported. Firefox does not seem to allow a HttpOnly enabled cookie to be overwritten even if you overflow the cookie jar. Hats of to Mozilla!</p>
<p>In order to test this, I whipped up a simple Go server which you&rsquo;ll find below:</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#fb660a;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#fb660a;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>	<span style="color:#0086d2">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>	<span style="color:#0086d2">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>	<span style="color:#0086d2">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>	<span style="color:#0086d2">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#fb660a;font-weight:bold">func</span> <span style="color:#ff0086;font-weight:bold">main</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>	cookieHandler := <span style="color:#fb660a;font-weight:bold">func</span>(w http.ResponseWriter, req *http.Request) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>		c := &amp;http.Cookie{
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>			Name:     <span style="color:#0086d2">&#34;secret_cookie&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>			Value:    <span style="color:#0086d2">&#34;admin123&#34;</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>			HttpOnly: <span style="color:#fb660a;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>		}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>		http.<span style="color:#ff0086;font-weight:bold">SetCookie</span>(w, c)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>		io.<span style="color:#ff0086;font-weight:bold">WriteString</span>(w, <span style="color:#0086d2">&#34;Cookie Set!!\n&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>	getCookiesHandler := <span style="color:#fb660a;font-weight:bold">func</span>(w http.ResponseWriter, req *http.Request) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>		w.<span style="color:#ff0086;font-weight:bold">Header</span>().<span style="color:#ff0086;font-weight:bold">Set</span>(<span style="color:#0086d2">&#34;Content-Type&#34;</span>, <span style="color:#0086d2">&#34;text/html; charset=utf-8&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>		<span style="color:#fb660a;font-weight:bold">for</span> i, c := <span style="color:#fb660a;font-weight:bold">range</span> req.<span style="color:#ff0086;font-weight:bold">Cookies</span>() {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>			io.<span style="color:#ff0086;font-weight:bold">WriteString</span>(w, strconv.<span style="color:#ff0086;font-weight:bold">Itoa</span>(i)+<span style="color:#0086d2">&#34;. &#34;</span>+c.Name+<span style="color:#0086d2">&#34;:&#34;</span>+c.Value+<span style="color:#0086d2">&#34;&lt;br /&gt;&#34;</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>		}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>	http.<span style="color:#ff0086;font-weight:bold">HandleFunc</span>(<span style="color:#0086d2">&#34;/setcookie&#34;</span>, cookieHandler)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>	http.<span style="color:#ff0086;font-weight:bold">HandleFunc</span>(<span style="color:#0086d2">&#34;/&#34;</span>, getCookiesHandler)
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>	log.<span style="color:#ff0086;font-weight:bold">Fatal</span>(http.<span style="color:#ff0086;font-weight:bold">ListenAndServe</span>(<span style="color:#0086d2">&#34;:8080&#34;</span>, <span style="color:#fb660a;font-weight:bold">nil</span>))
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>}
</span></span></code></pre></div><p>Simply visit <code>/setcookie</code> and then browse back to the main page, you should see the cookie there. Next, you overflow the cookie with the following code snippet (paste into dev tools):</p>
<div class="highlight"><pre tabindex="0" style="color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span><span style="color:#fb660a;font-weight:bold">for</span> (<span style="color:#fb660a;font-weight:bold">let</span> i=<span style="color:#0086f7;font-weight:bold">0</span>;i&lt;<span style="color:#0086f7;font-weight:bold">1000</span>;i++) {
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>    document.cookie = <span style="color:#0086d2">&#34;cookie&#34;</span>+i+<span style="color:#0086d2">&#34;=overflow&#34;</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>document.cookie = <span style="color:#0086d2">&#34;secret_cookie=hacked1&#34;</span>
</span></span></code></pre></div><p>Now the <code>secret_cookie</code> should have the value <code>hacked1</code> and the HttpOnly flag should be set to false. You can verify this in the cookie storage tab in developer tools.</p>
<h2 id="practical-attacks">Practical attacks</h2>
<p>Depending on what the cookie is being used for, there are different things you can do after overflowing the jar. You could attempt session fixation if the cookie handles sessions. Other things may include manipulating data, for instance, if the cookie contains something like <code>role=user</code>, you could set it to <code>role=admin</code>.</p>
<h2 id="mitigation">Mitigation</h2>
<p>Well, as Sam mentioned, simply don&rsquo;t use cookies :) But that may be easier said than done. Ultimately, this attack allows an attacker to modify data, therefore in order to protect against this attack you need to verify the integrity of the cookie. This can be done in different ways but JWT has built-in functionality for this, that could be an option. Another approach could be embedding an HMAC into the cookie which is verified on each request.</p>
<h2 id="resources">Resources</h2>
<p>I found some other resources around the web discussing this attack, check them out, they are quite interesting.</p>
<ul>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=607613">HttpOnly cookies flushed by non-HttpOnly cookies (useful for session fixation)</a></li>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=797618">Prevent cookie overflow + replace</a></li>
<li><a href="https://michael-coates.blogspot.com/2010/01/cookie-forcing-trust-your-cookies-no.html">Cookie Forcing - Trust your cookies no more</a></li>
<li><a href="https://scarybeastsecurity.blogspot.com/2008/11/cookie-forcing.html">Cookie forcing </a></li>
</ul>

    </article>


        </div><footer>
 
</footer></main>
        
        <script src="/js/particles.min.js" defer></script>
        <script src="/js/particles.conf.js" defer></script>
        <script src="/js/baffle.min.js" async></script>
        <script src="/js/main.js" defer async></script>
    </body>
</html>
