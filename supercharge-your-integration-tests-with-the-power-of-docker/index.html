<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><link rel=preload href=/fonts/FiraCode-VariableFont_wght.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/css/bootstrap-grid.min.css type=text/css><link rel=stylesheet href=/css/main.css type=text/css><meta name=apple-mobile-web-app-title content="dubell.io | Supercharge Your Integration Tests with the Power of Docker"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=twitter:site content="@dubs3c"><meta name=twitter:creator content="@dubs3c"><meta property="og:title" content="dubell.io | Supercharge Your Integration Tests with the Power of Docker"><meta name=twitter:title content="dubell.io | Supercharge Your Integration Tests with the Power of Docker"><meta itemprop=name content="dubell.io | Supercharge Your Integration Tests with the Power of Docker"><meta name=application-name content="dubell.io | Supercharge Your Integration Tests with the Power of Docker"><meta property="og:site_name" content="dubell.io"><meta property="og:article:published_time" content="2023-09-19T12:25:17+0200"><meta property="article:published_time" content="2023-09-19T12:25:17+0200"><base href=https://dubell.io/supercharge-your-integration-tests-with-the-power-of-docker/><link rel=canonical href=https://dubell.io/supercharge-your-integration-tests-with-the-power-of-docker/ itemprop=url><meta name=url content="https://dubell.io/supercharge-your-integration-tests-with-the-power-of-docker/"><meta name=twitter:url content="https://dubell.io/supercharge-your-integration-tests-with-the-power-of-docker/"><meta property="og:url" content="https://dubell.io/supercharge-your-integration-tests-with-the-power-of-docker/"><meta property="og:article:author" content="Dubs3c"><meta property="article:author" content="Dubs3c"><meta name=author content="Dubs3c"><meta name=description content="Supercharge Your Integration Tests with the Power of Docker"><meta itemprop=description content="Supercharge Your Integration Tests with the Power of Docker"><meta property="og:description" content="Supercharge Your Integration Tests with the Power of Docker"><meta name=twitter:description content="Supercharge Your Integration Tests with the Power of Docker"><meta itemprop=image content="/"><meta property="og:image" content="https://dubell.io"><meta name=twitter:image content="https://dubell.io"><meta name=twitter:image:src content="https://dubell.io"><meta property="og:updated_time" content="2023-09-19T12:25:17+0200"><link rel=sitemap type=application/xml title=Sitemap href=https://dubell.iositemap.xml><title>dubell.io | Supercharge Your Integration Tests with the Power of Docker</title></head><body><div class=container><div id=particles-js></div><div class=row><div class=col><header style=text-align:center><a href=/ class=noleet><img href=/ class=banner-image src=/img/logo2.png alt=logo></a></header></div></div><div class=row><div class=col style=text-align:center><nav><fieldset><legend>n4vig4ti0n</legend><ul><li><a href=/>/etc/motd</a></li><li><a href=/www/>/var/www</a></li><li><a href=/mnt/>/mnt</a></li><li><a href=/usr/>/usr</a></li></ul></fieldset></nav></div></div><div class=row><div class=content><article><div class=row><div class=col><h1>Supercharge Your Integration Tests with the Power of Docker</h1><p class=small style=color:#999><a href=/categories/development>Development</a> / September 19, 2023 â€¢ 2 min read</p><p class=small><strong>Tags:</strong> <a href=/tags/docker class=tag>Docker</a> <a href=/tags/go class=tag>Go</a></p></div></div><div class=row><div class=col><div id=article-content><p>In the beginning of my developer career, I learned to use in-memory databases for running integration tests. The in-memory database made it easy to spin up a local database which is often needed for integration testing. However, there are some drawbacks with this approach.</p><h3 id=a-clever-illusion>A Clever Illusion</h3><p>Using an in-memory database does not reflect the real database running in production. The local database may look and feel like the real deal, but it&rsquo;s essentially an illusion, and a clever one.</p><p>The real database running in your production environment has vastly more underlying code paths, dependencies, frameworks, integrations and most likely handles concurrency differently.</p><p>As an example, many years ago I remember feeling overly happy and proud when I had completed a complex feature. It worked locally, and the integration tests I wrote to make sure the feature behaved as a expected, passed with flying colors. However, once the feature was deployed and received traffic, an optimistic lock occurred. I had written a test for this scenario, which passed locally. But in the production environment, something went wrong, something that the local illusion could not account for.</p><h3 id=breaking-the-illusion>Breaking The Illusion</h3><p>Instead of using in-memory databases or other such tricks, use e.g. Docker to spin up an ephemeral container running your database of choice. This provides you with the same foundation as your production environment. Now you can be more confident about the accuracy of your tests.</p><p>I have used two libraries in the past that facilitates the use of Docker containers in integration testing:</p><ul><li><a href=https://github.com/testcontainers/testcontainers-java>https://github.com/testcontainers/testcontainers-java</a></li><li><a href=https://github.com/ory/dockertest>https://github.com/ory/dockertest</a></li></ul><p>Before running your tests, you programmatically spin up a docker container and provide the connection details to your setup method that will provide the database object to the rest of your test code. When the tests are finished, you can remove the container.</p><p>Below you&rsquo;ll find a short example how you can use dockertest by ory in your Go environment.</p><p>Create a <code>TestMain</code>:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#fb660a;font-weight:700>func</span> <span style=color:#ff0086;font-weight:700>TestMain</span>(m *testing.M) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>	<span style=color:#080;background-color:#0f140f;font-style:italic>// Docker setup here
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#080;background-color:#0f140f;font-style:italic></span>}
</span></span></code></pre></div><p>Create a new pool object that connects to the default docker socket:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>pool, err := dockertest.<span style=color:#ff0086;font-weight:700>NewPool</span>(<span style=color:#0086d2>&#34;&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fb660a;font-weight:700>if</span> err != <span style=color:#fb660a;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>	log.<span style=color:#ff0086;font-weight:700>Fatalf</span>(<span style=color:#0086d2>&#34;Could not construct pool: %s&#34;</span>, err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><p>Define the image you want:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>resource, err := pool.<span style=color:#ff0086;font-weight:700>Run</span>(<span style=color:#0086d2>&#34;mysql&#34;</span>, <span style=color:#0086d2>&#34;5.7&#34;</span>, []<span style=color:#cdcaa9;font-weight:700>string</span>{<span style=color:#0086d2>&#34;MYSQL_ROOT_PASSWORD=secret&#34;</span>})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#fb660a;font-weight:700>if</span> err != <span style=color:#fb660a;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>	log.<span style=color:#ff0086;font-weight:700>Fatalf</span>(<span style=color:#0086d2>&#34;Could not start resource: %s&#34;</span>, err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>}
</span></span></code></pre></div><p>Wait for the database to become available:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#fb660a;font-weight:700>if</span> err := pool.<span style=color:#ff0086;font-weight:700>Retry</span>(<span style=color:#fb660a;font-weight:700>func</span>() <span style=color:#cdcaa9;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>	<span style=color:#fb660a;font-weight:700>var</span> err <span style=color:#cdcaa9;font-weight:700>error</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>	db, err = sql.<span style=color:#ff0086;font-weight:700>Open</span>(<span style=color:#0086d2>&#34;mysql&#34;</span>, fmt.<span style=color:#ff0086;font-weight:700>Sprintf</span>(<span style=color:#0086d2>&#34;root:secret@(localhost:%s)/mysql&#34;</span>, resource.<span style=color:#ff0086;font-weight:700>GetPort</span>(<span style=color:#0086d2>&#34;3306/tcp&#34;</span>)))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>	<span style=color:#fb660a;font-weight:700>if</span> err != <span style=color:#fb660a;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>		<span style=color:#fb660a;font-weight:700>return</span> err
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>	}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>	<span style=color:#fb660a;font-weight:700>return</span> db.<span style=color:#ff0086;font-weight:700>Ping</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>}); err != <span style=color:#fb660a;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	log.<span style=color:#ff0086;font-weight:700>Fatalf</span>(<span style=color:#0086d2>&#34;Could not connect to database: %s&#34;</span>, err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span></code></pre></div><p>Run your tests!</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>code := m.<span style=color:#ff0086;font-weight:700>Run</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#fb660a;font-weight:700>if</span> err := pool.<span style=color:#ff0086;font-weight:700>Purge</span>(resource); err != <span style=color:#fb660a;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>	log.<span style=color:#ff0086;font-weight:700>Fatalf</span>(<span style=color:#0086d2>&#34;Could not purge resource: %s&#34;</span>, err)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>os.<span style=color:#ff0086;font-weight:700>Exit</span>(code)
</span></span></code></pre></div><p>When all tests have finished, the container will be removed.</p><h3 id=doesnt-get-easier-than-that>Doesn&rsquo;t Get Easier Than That!</h3><p>That&rsquo;s it! Now go and update your development environment and supercharge your integration tests!</p></div></div></div></article></div></div><footer></footer></div><script src=/js/particles.min.js defer></script><script src=/js/particles.conf.js defer></script><script src=/js/baffle.min.js async></script><script src=/js/main.js defer async></script></body></html>